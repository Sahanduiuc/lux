define(["lux"],function(a){"use strict";var b=a.getLogger("cms"),c=a.cms={name:"page",_content_types:{},_wrapper_types:{},content_type:function(a){return this._content_types[a]},wrapper_type:function(a){return this._wrapper_types[a]},content_types:function(){return this._sorted(this._content_types)},wrapper_types:function(){return this._sorted(this._wrapper_types)},create_content_type:function(a,b,c){b.meta;c||(c=i),b.meta=b.meta||{},b.meta.name=a.toLowerCase();var d=c.extend(b);return this._content_types[d._meta.name]=d,d},create_wrapper:function(a,b,c){c||(c=j),b.title||(b.title=a),b.name=a.toLowerCase();var d=c.extend(b),e=new d;return this._wrapper_types[e.name]=e,e},set_transport:function(a){this._backend=a,_(this._content_types).forEach(function(b){b._meta.set_transport(a)})},_sorted:function(a){var b=[];return _(a).forEach(function(a){a._meta&&(a=a._meta),b.push({value:a.name,text:a.title})}),b.sort(function(a,b){return a.text>b.text?1:-1}),b}},d=new a.Ordered,e=new a.Ordered,f="content_type",g="dbfields",h=function(a){return a.id?"<div class='colored "+a.id+"'>"+a.text+"</div>":a.text},i=c.Content=a.Model.extend({show_title:!1,meta:{name:"content",fields:[new a.ChoiceField("content_type",{required:!0,choices:function(){return c.content_types()},fieldset:f,select2:{placeholder:"Choose a content"}}),new a.ChoiceField("wrapper",{choices:function(){return c.wrapper_types()},fieldset:f,select2:{minimumResultsForSearch:-1}}),new a.ChoiceField("skin",{choices:a.SKIN_NAMES,fieldset:f,select2:{placeholder:"Choose a skin",formatResult:h,formatSelection:h,minimumResultsForSearch:-1,escapeMarkup:function(a){return a}}}),new a.Field("id",{type:"hidden",fieldset:g}),new a.Field("title",{required:!0,fieldset:g}),new a.KeywordsField("keywords",{fieldset:g,select2:{tags:[],initSelection:function(a,b){var c=[];_(a.val().split(",")).forEach(function(a){a&&c.push({id:a,text:a})}),b(c)}}})]},getForm:function(b){b||(b={}),b.model=this;var c=new a.Form(b);return c.addFields(_.filter(this._meta.fields,function(a){return!a.fieldset})),c},render:function(){},close:function(){this.container&&(this.container.trigger("close-plugin-edit"),delete this.container)},sync:function(a,b){return this.set(f,this._meta.name),this._meta.persistent?this._super(a,b):void(b&&b.success&&b.success.call(this._meta,this.fields()))},serialize:function(){if(!this._meta.persistent)return this.set(f,this._meta.name),this.fields();var a=this.pk();return a?a:void 0}}),j=c.Wrapper=a.Class.extend({render:function(a){a.content.render(a.elem)}}),k=a.Model.extend({meta:c,update_content:function(a){var c=a.id,d=a.data;if(c&&d){var e=this.content_type(d.content_type);if(e){var f=e.prototype._meta;return f.update(c,d)}}b.error("Could not understand content")}}),l=function(b){var d,e,h,j,k=new a.Dialog(b.contentedit),l=b.page_limit||10,m=$(document.createElement("div")).addClass("columns"),n=$(document.createElement("div")).addClass("content-fields column pull-left span8"),o=$(document.createElement("div")).addClass("content-data column").css("padding-left",n.width()+20),p=$(document.createElement("fieldset")).addClass(f).appendTo(n),q=$(document.createElement("fieldset")).addClass(g).appendTo(n),r=$(document.createElement("fieldset")).addClass("submit").appendTo(n),s=new a.Form;return s.elem.append(n).append(o).appendTo(m),s.addFields(i._meta.fields),s.addSubmit({text:"Done",fieldset:r}),s.render(),q.detach(),k.body().append(m).addClass("edit-content").bind("close-plugin-edit",function(){k.destroy()}),s.elem.find('[name="skin"]').change(function(){j.skin=this.value}),h=q.find('[name="id"]'),e=p.find('[name="content_type"]'),d=p.find('[name="wrapper"]').change(function(){j.wrapper=this.value}),b.content_url&&q.find('[name="title"]').Select({placeholder:"Search content",minimumInputLength:2,id:function(a){return a.title},initSelection:function(a,b){var c=a.val();b({title:c})},formatResult:function(a,b,c){return a.title||(a.title=c.term),"<p>"+a.title+"</p>"},formatSelection:function(a){return-1===a.id?h.val(""):a.id&&$.ajax({url:b.content_url+"/"+a.id,success:function(a){var b=a,d=c.content_type(b.content_type);a.data&&(b=a.data,delete a.data,_.extend(b,a)),j.content=new d(b),j.content.updateForm(s.elem)}}),a.title},ajax:{url:b.content_url,minimumInputLength:3,data:function(a){return{q:a,per_page:l,field:["id","title"],content_type:j.content._meta.name,apikey:b.api_key}},results:function(a){return a.splice(0,0,{title:"",id:-1}),{results:a,more:_.size(a)-1===l}}}}),s.ajax({beforeSubmit:function(b){var c=j.content,d=a.fields_from_array(b),e=d.wrapper;return delete d.wrapper,c.replace(d),j.wrapper=e,j.set(c),k.fadeOut(),!1}}),e.change(function(){var a=this.value;if(j.content=j.content_history[a],!j.content){var b=c.content_type(a);b&&(j.content=new b)}if(j.content){j.log(j+" changed content type to "+j.content),j.content_history[j.content._meta.name]=j.content,j.content._meta.persistent?(p.after(q),j.content.updateForm(s.elem)):q.detach(),o.html("");var e=j.content.getForm();o.append(e.render().elem.children())}else a?web.logger.error("Unknown content type "+a):(q.detach(),o.html(""));j.wrapper!==d.val()&&d.val(j.wrapper).trigger("change")}),k.set_current_view=function(a){j=a,j.content?(j.content_history[j.content._meta.name]=j.content,e.val(j.content._meta.name).trigger("change")):e.val("").trigger("change")},k},m=c.views={},n=150,o=new a.ChoiceField("rowtemplate",{choices:function(){var a=[];return d.each(function(b,c){a.push(c)}),a},select2:{placeholder:"Select a row layout",minimumResultsForSearch:-1}}),p=new a.ChoiceField("blocktemplate",{choices:function(){var a=[];return e.each(function(b,c){a.push(c)}),a},select2:{placeholder:"Select a block layout",minimumResultsForSearch:-1}}),q=m.base=a.View.extend({initialise:function(a){this.parentType=a.parent?a.parent.type:null,delete a.parent,this.options=a,this.store=this.options.store,this.name=this.elem.data("context"),this.elem.addClass("cms-"+this.type).data("cmsview",this)},render:function(){var a=this;this.elem.children().each(function(){a.createChild(this)}),this.elem.fadeTo("fast",1)},setupEdit:function(){var a=this;this.childType&&!this.editing&&_(this.childrenElem()).forEach(function(b){var c=$(b).data("cmsview");c?c.setupEdit():a.log("could not find editing element","WARNING")}),this.editing=!0},parent:function(){return this.parentType?this.container().closest(".cms-"+this.parentType).data("cmsview"):void 0},child:function(b){var c;return this.iter(function(d,e){return e===b?(c=d,a.breaker):void 0}),c},childrenElem:function(){return this.childType?this.elem.find(".cms-"+this.childType):[]},iter:function(a){_(this.childrenElem()).forEach(function(b,c){a($(b).data("cmsview"),c)})},page:function(){return this.parent().page()},grid:function(){return this.parent().grid()},current_column:function(){return this.page().current_column()},index:function(){var b=this.parent(),c=-1,d=this.elem[0];return b&&_(b.childrenElem()).forEach(function(b,e){return d===b?(c=e,a.breaker):void 0}),c},createChild:function(b,c){if(this.childType){var d=m[this.childType],e=this.options;if(!d)throw new a.NotImplementedError(this+" has no createChild method.");e.elem=b,e.parent=this;var f=new d(e);return c===Object(c)&&f.elem.data(c),f.render(this),f}},container:function(){return this.dialog?this.dialog.elem:this.elem},get_column:function(){var a=this.childrenElem().first(),b=a.data("cmsview");return b.get_column()},layout:function(){var a,b=[];return this.iter(function(c){a=c.layout(),a&&b.push(a)}),b.length?b:null},_create_edit_dialog:function(b){return this.dialog||(this.dialog=new a.Dialog(b),this.elem.before(this.dialog.elem),this.dialog.body().append(this.elem)),this.dialog},log:function(a,b){var c=this.page();c&&c.logger&&c.logger.html(b?'<p class="text-danger">'+b+": "+a+"</p>":"<p>"+a+"</p>")},toString:function(){var a=this.index();return-1===a?this.type:this.type+"-"+a}}),r=m.page=q.extend({type:"page",childType:"grid",render:function(){var a=this;this.childrenElem().each(function(){a.createChild(this)}),this.options.editing&&(a.model=new k({id:this.options.editing}),this.setupEdit()),this.elem.fadeTo(100,1)},setupEdit:function(){if(!this.editing){var b=$(".cms-control"),c=new a.Grid({rows:[[8,8,8]]});this.logger=$('<div class="cms-info"></div>'),b.length||(b=$(document.createElement("div")).addClass("cms-control")),c.row(0).column(0).append(b),this.elem.prepend(c.elem),this.control=new a.Dialog(_.extend({elem:c.elem},this.options.page)),this.control.header().prepend(this.logger),b.show(),this._add_block_control(),this.options.block.dragdrop&&(this.options.block.dragdrop=this._create_drag_drop(this.options.block)),this.options.row.dragdrop&&(this.options.row.dragdrop=this._create_drag_drop(this.options.row)),this._super()}},page:function(){return this},grid:function(){return null},index:function(){return-1},get_current_column:function(){return this._current_column},set_current_column:function(a){this._current_column&&this._current_column.elem.removeClass("active"),this._current_column=a,a&&(this.log("Selected current "+a),a.elem.addClass("active"))},layout:function(){var a,b={};return this.iter(function(c){a=c.layout(),a&&(b[c.name]=a)}),b},sync:function(){var a=this;this.model.set("content",this.layout()),this.log("saving layout..."),a.model.sync(a.store,{success:function(){a.log("Layout saved")}})},_add_block_control:function(){var a=this,b=a.options,c=this.control,d=c.createButton({icon:b.add_block_icon,title:"Add new block"}),e=p.render(function(b){a.control.buttons.prepend(b)}).width(n);a.control.buttons.prepend(d.elem),d.elem.click(function(){var b=e.val(),c=a.get_current_column();(!c||c.index()<0)&&(c=a.get_column(),a.set_current_column(c)),c?c.add_block(b):a.log("WARNING: No column available!")})},_create_drag_drop:function(b){var c=this,d=new a.DragDrop({dropzone:"."+b.dropzone,placeholder:$(document.createElement("div")).addClass(b.dropzone),onDrop:function(a){d.moveElement(a,this),c.sync()}});return d.add("."+b.dropzone,"."+b.dropzone+" > .header"),d}}),s=(m.grid=q.extend({type:"grid",childType:"row",setupEdit:function(){if(!this.editing){var a=this,b=this._create_edit_dialog(this.options.grid),c=b.createButton({icon:this.options.add_row_icon,title:"Add new row"}),d=o.render(function(a){b.buttons.prepend(a)}).width(n);b.elem.css("margin-top","5px"),b.title(this.name),b.buttons.prepend(c.elem),c.elem.click(function(){var b=a.createChild(null,{template:d.val()});a.elem.append(b.container()),b.setupEdit()}),this._super()}},grid:function(){return this},index:function(){return this.name},toString:function(){return this.type+"-"+this.name}}),m.row=q.extend({type:"row",childType:"column",templates:d,render:function(){"row"==this.type&&this.elem.addClass("row grid"+this.options.columns),this.templateName=this.elem.data("template"),this.template=this.templateName?this.templates.get(this.templateName):null,this.template||(this.templateName=this.templates.order[0],this.template=this.templates.get(this.templateName));var a=this,b=this.template.length,c=0;for(this.elem.children().detach().each(function(){b>c&&(a.template.append(a.createChild(this),a,c),c+=1)});b>c;c++)a.template.append(a.createChild(),a,c)},setupEdit:function(){this._create_edit_dialog(this.options[this.type]),this._super()},layout:function(){var a=[],b=!1;return _(this.childrenElem()).forEach(function(c){c=$(c).data("cmsview");var d=c.layout();a.push(d),d&&(b=!0)}),b?{template:this.templateName,children:a}:void 0},_create_edit_dialog:function(a){if(!this.dialog){var b=this._super(a),c=this.page();b.elem.addClass(a.dropzone).bind("removed",function(){c&&c.sync()})}return this.dialog}})),t=(m.column=q.extend({type:"column",childType:"block",setupEdit:function(){if(!this.editing){var a=this;this.elem.click(function(){a.page().set_current_column(a)}),this._super()}},get_column:function(){return this},add_block:function(a){var b=this.createChild(null,{template:a});this.elem.append(b.container()),this.log("Added new "+b),this.editing&&b.setupEdit()}}),m.block=s.extend({type:"block",childType:"content",templates:e,get_column:function(){return this.parent()}}),m.content=q.extend({type:"content",render:function(){var b=this,c=this.elem.data(),d=a.cms.content_type(c.content_type);d&&(this.wrapper=c.wrapper,this.skin=c.skin,c=_.merge({},c),delete c.wrapper,delete c.skin,delete c.cmsview,this.elem.children().each(function(){var a=$(this),d=a.data("field");d?c[d]=a.html():b.log("Field not available in content","WARNING")}),c.keywords||(c.keywords=[]),this.set(new d(c),!1))},setupEdit:function(){if(!this.editing){var a=this,b=$(document.createElement("div")),c=$(document.createElement("div")).addClass("cms-content-toolbar").appendTo(b),d=$(document.createElement("div")).addClass("btn-group pull-right").appendTo(c),e=this.parent(),f=e.dialog.createButton({icon:"edit",size:"mini"});f.elem.click(function(){a.edit_content()}).appendTo(d),this.button_group=d,this.title=$(document.createElement("span")).prependTo(c),b.appendTo(this.elem.parent()),this.elem.addClass("preview").appendTo(b),this._container=b,this.content_history={},this.editing=!0,this.content&&this.title.html(this.content._meta.title)}},container:function(){return this._container?this._container:this.elem},child:function(){return null},get_content:function(b){var c=a.cms.content_type(b.content_type),d=this;if(c){var e=this.elem.data("fields");b.fields||0===e?(e=b.fields,b.id&&(e=e||{},e.id=b.id),this.set(new c(e),!1)):b.id?c._meta.get(b.id,{success:function(a){d.set(a[0],!1)}}):d.log("could not understand content!","WARNING")}},layout:function(){return this.content?{content:this.content.serialize(),skin:this.skin,wrapper:this.wrapper}:void 0},set:function(a,b){this.content=a;var d=c.wrapper_type(this.wrapper);if(this.elem.html(""),d?d.render(this):a.render(this.elem,this.skin),this.title&&this.title.html(a._meta.title),b!==!1){var e=this,f=this.page();a.sync(e.store,{success:function(){e.log(e+" set content to "+e.content),f.sync()},error:function(a){e.log("ERROR while synching. "+a)}})}},get_column:function(){return this.parent.get_column()},edit_content:function(){var a=this.page(),b=a._content_dialog;return b||(b=l(a.options),a._content_dialog=b),b.set_current_view(this),b.fadeIn(),b}}),a.Class.extend({init:function(a){this.length=a},append:function(a,b){var c=a.container();if(1===this.length)b.elem.append(c);else{{b.inner}b.elem.children().length||b.elem.addClass("row grid"+b.options.columns),c.addClass("span"+b.options.columns/this.length).appendTo(b.elem)}}})),u=t.extend({append:function(b,c){var d=b.container();if(1===this.length)c.elem.append(d);else{var e=c.inner,f=a.s4(),g=b.elem.attr("title"),h=$(document.createElement("a")).attr("href","#"+f).html(g);e||(c.ul=$(document.createElement("ul")).appendTo(c.elem),c.inner=e=$(document.createElement("div")).appendTo(c.elem)),c.ul.append($(document.createElement("li")).append(h)),c.inner.append($(document.createElement("div")).attr("id",f).append(d))}}}),v=a.Class.extend({init:function(a){this.splits=a,this.length=a.length},append:function(a,b,c){var d=a.container();d.addClass("column span"+this.splits[c]*b.options.columns),b.elem.append(d)}});d.set("One Column",new v([1])),d.set("Half-Half",new v([.5,.5])),d.set("33-66",new v([1/3,2/3])),d.set("66-33",new v([2/3,1/3])),d.set("25-75",new v([.25,.75])),d.set("75-25",new v([.75,.25])),d.set("33-33-33",new v([1/3,1/3,1/3])),d.set("50-25-25",new v([.5,.25,.25])),d.set("25-25-50",new v([.25,.25,.5])),d.set("25-50-25",new v([.25,.5,.25])),d.set("25-25-25-25",new v([.25,.25,.25,.25])),e.set("1 element",new t(1)),e.set("2 elements",new t(2)),e.set("3 elements",new t(3)),e.set("2 tabs",new u(2)),e.set("3 tabs",new u(3)),e.set("4 tabs",new u(4));var w=function(a,b,c){var d=$("<div class='panel panel-default'></div>").appendTo(a.elem).addClass(a.skin);if(b){var e=$("<div class='header'></div>").appendTo(d),f=a.content.get("title");c&&(e=$("<h3 class='title'></h3>").appendTo(e)),f&&e.html(f)}var g=$("<div class='body'></div>").appendTo(d);a.content.render(g,a.skin)};c.create_wrapper("nothing",{title:"No Wrapper"}),c.create_wrapper("well",{title:"Well",render:function(a){var b=$("<div class='well'></div>").appendTo(a.elem);a.content.render(b)}}),c.create_wrapper("welllg",{title:"Well Large",render:function(a){var b=$("<div class='well well-lg'></div>").appendTo(a.elem).addClass(a.skin);a.content.render(b)}}),c.create_wrapper("wellsm",{title:"Well Small",render:function(a){var b=$("<div class='well well-sm'></div>").appendTo(a.elem).addClass(a.skin);a.content.render(b)}}),c.create_wrapper("panel",{title:"Panel",render:function(a){w(a)}}),c.create_wrapper("panelheading",{title:"Panel with heading",render:function(a){w(a,!0)}}),c.create_wrapper("paneltitle",{title:"Panel with title",render:function(a){w(a,!0,!0)}}),c.create_content_type("contenturl",{meta:{title:"Site Content",fields:[new a.ChoiceField("content_url",{label:"Choose a content",choices:function(){var b=[];return _(a.content_urls).forEach(function(a){b.push(a)}),b}})]},render:function(c){var d=this.get("content_url");if("this"===d){var e=this.get("this");_.defer(function(){a.loadViews(c.html(e))})}else d?(c.html("&nbsp;"),$.ajax(d,{dataType:"json",success:function(b){b.html&&require(b.requires||[],function(){a.loadViews(c.html(b.html))})}})):b.warning("Missing underlying page url and html")}}),c.create_content_type("blank",{model_title:"The content served by the url",render:function(a){a.html("&nbsp;")}}),c.create_content_type("markdown",{meta:{title:"Text using markdown",persistent:!0,fields:[new a.TextArea("raw",{rows:10,placeholder:"Write markdown"}),new a.TextArea("javascript",{rows:7,placeholder:"javascript"})]},render:function(b){var c=this;require(["showdown"],function(){var d=c.get("raw")||"",e=c.get("javascript")||"",f=new Showdown.converter,g=f.makeHtml(d);if(a.loadViews(b.html(g)),e){var h=$("body"),i=$("<script type='application/javascript'>"+e+"</script>"),j=c.cid();$("#"+j,h).remove(),h.append(i.attr("id",j))}})},get_form_new:function(b){var c=this._meta.fields,d=a.web.form(),e=c.raw.add_to_form(d,this),f=c.javascript.add_to_form(d,this),g=new a.TabView({tabs:[{name:"markdown",content:e},{name:"javascript",content:f}]});d._element.empty().append(g.elem),require(["codemirror"],function(){CodeMirror.fromTextArea(e[0]),CodeMirror.fromTextArea(f[0]),b(d)})}}),c.create_content_type("versions",{meta:{title:"Versions of libraries"},render:function(b){var c=$(document.createElement("ul")).appendTo(b);_(a.libraries).forEach(function(a){c.append($('<li><a href="'+a.web+'">'+a.name+"</a> "+a.version+"</li>"))})}}),c.create_content_type("datatable",{meta:{title:"Data Grid",persistent:!0,render_queue:[],api_info:function(a){this.api=a||{};var b=this.render_queue;delete this.render_queue,_.each(b,function(a){a.content._render(a.container,a.skin)})},fields:[new a.ChoiceField("url",{label:"Choose a model",choices:function(a){var b=a.model.api();return b.groups},select2:{}}),new a.MultiField("fields",{placeholder:"Select fields to display",select2:{}}),new a.MultiField("row_actions",{label:"Row actions",placeholder:"Action on rows",choices:[{value:"delete"}],select2:{minimumResultsForSearch:-1}}),new a.ChoiceField("style",{tag:"input",choices:["table","grid"]}),new a.BooleanField("sortable"),new a.BooleanField("editable"),new a.BooleanField("collapsable"),new a.BooleanField("fullscreen"),new a.BooleanField("footer",{label:"Display Footer"})]},render:function(a,b){var c=this;require(["datagrid"],function(){void 0===c._meta.api?c._meta.render_queue.push({content:c,container:a,skin:b}):c._render(a,b)})},getForm:function(){var a=this._super();return this._formActions(a),a},_render:function(a,b){var c=$(document.createElement("div")).appendTo(a),d=_.extend({},this.fields()),e=this.api().models,f=e?e[d.url]:null,g=[];if(f){if(d.fields){var h={};_(f.fields).forEach(function(a){h[a.code]=a}),_(d.fields).forEach(function(a){var b=h[a];b&&g.push(b)})}d.columns=g.length?g:f.fields,d.store=d.url,d.skin=b,c.datagrid(d)}},api:function(){var a=this._meta.api;return a?(!a.groups&&a.sitemap&&this._create_groups(a),a):{}},_create_groups:function(a){var b=[],c={};_(a.sitemap).forEach(function(a){var d=$(document.createElement("optgroup")).attr("label",a.name);b.push(d),_(a.routes).forEach(function(a){$(document.createElement("option")).val(a.api_url).html(a.model).appendTo(d),c[a.api_url]=a})}),a.groups=b,a.models=c},_formActions:function(a){var b=this,c=this.api(),d=c.models,e=a.elem.find('[name="fields"]');a.elem.find('[name="url"]').change(function(){var a=$(this).val(),c=d[a];e.val([]).trigger("change"),e.children().remove(),c&&(c.options?_(c.options).forEach(function(a){e.append(a)}):(c.options=[],c.map={},_(d[a].fields).forEach(function(a){var b=$(document.createElement("option")).val(a.code).html(a.name);c.map[a.code]=a,c.options.push(b),e.append(b)})),a===b.get("url")&&_(b.get("fields")).forEach(function(){}))}).val(this.get("url")).trigger("change")}});a.CmsView=a.createView("cms",{selector:".cms-page",defaults:{editing:!1,backend_url:null,content_url:null,add_row_icon:"columns",add_block_icon:"plus",skin:"control",row_control_class:"add-row",columns:24,hartbeat:5,page:{collapsable:!0,collapsed:!0,className:"control",skin:"inverse",buttons:{size:"default"}},grid:{collapsable:!0,className:"control",buttons:{size:"default"}},row:{closable:!0,collapsable:!0,skin:"default",size:"mini",dragdrop:!1,dropzone:"row-control"},block:{closable:!0,collapsable:!0,skin:"primary",size:"mini",dragdrop:!0,dropzone:"block-control"},contentedit:{modal:!0,movable:!0,fullscreen:!0,autoOpen:!1,width:600,title:"Edit Content",fade:{duration:20},closable:{destroy:!1}}},initialise:function(b){{var c=this;c._element}b.editing&&(this.elem.addClass("editing"),b.store=new a.create_store(b.backend_url,{hartbeat:b.hartbeat})),this._setup_api(),this._super(b)},_setup_api:function(){var a=$("html").data("api");if(a){var b=this;$.ajax(a.url,{dataType:"json",success:function(c){b.on_sitemap(a,c)},error:function(){b.on_sitemap(a)}})}else this.on_sitemap()},on_sitemap:function(a,b){var d=c.content_type("datatable");d&&(a&&(a.sitemap=b),d._meta.api_info(a))},_handle_close:function(){$(window).bind("beforeunload",function(a){return a.preventDefault(),!1})}},r);return c});