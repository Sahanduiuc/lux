define(["lux-web"],function(){"use strict";var a=new lux.Ordered,b=new lux.Ordered,c="content_type",d="dbfields",e=lux.web,f=lux.Model.extend({show_title:!1,meta:{name:"content",fields:{id:new lux.Field({type:"hidden",fieldset:{Class:d}}),title:new lux.Field({required:"required",placeholder:"title",fieldset:{Class:d}}),keywords:new lux.KeywordsField({placeholder:"keywords",fieldset:{Class:d}})}},get_form:function(){},render:function(){},close:function(){this.container&&(this.container.trigger("close-plugin-edit"),delete this.container)},sync:function(a){return this.set(c,this._meta.name),this._meta.persistent?this._super(a):void(a&&a.success&&a.success.call(this._meta,this.fields()))},serialize:function(){if(!this._meta.persistent)return this.set(c,this._meta.name),this.fields();var a=this.pk();return a?a:void 0}}),g=lux.Class.extend({render:function(a){a.content.render(a.elem)}}),h=lux.Model.extend({meta:{name:"page",_content_types:{},_wrapper_types:{},content_type:function(a){return this._content_types[a]},wrapper_type:function(a){return this._wrapper_types[a]},content_types:function(){return this._sorted(this._content_types)},wrapper_types:function(){return this._sorted(this._wrapper_types)},create_content_type:function(a,b,c){b.meta;c||(c=f),b.meta=b.meta||{},b.meta.name=a.toLowerCase();var d=c.extend(b);return d._meta.set_transport(this._backend),this._content_types[d.prototype._meta.name]=d,d},create_wrapper:function(a,b,c){c||(c=g),b.title||(b.title=a),b.name=a.toLowerCase();var d=c.extend(b),e=new d;return this._wrapper_types[e.name]=e,e},set_transport:function(a){this._backend=a,_(this._content_types).forEach(function(b){b._meta.set_transport(a)})},_sorted:function(a){var b=[];return _(a).forEach(function(a){a._meta&&(a=a._meta),b.push({value:a.name,text:a.title})}),b.sort(function(a,b){return a.text>b.text?1:-1}),b}},update_content:function(a){var b=a.id,c=a.data;if(b&&c){var d=this.content_type(c.content_type);if(d){var f=d.prototype._meta;return f.update(b,c)}}e.logger.error("Could not understand content")}}),i=lux.cms=h._meta;i.Content=f;var j=function(a){var b,c,g,h,j,k=e.dialog(a.contentedit),l=a.page_limit||10,m=e.grid(),n=$(document.createElement("div")).addClass("preview"),o=f._meta.fields,p=e.form(),q=e.create_select(i.wrapper_types()).attr("name","content_type"),r=e.create_select(i.content_types()),s="content-selection",t=function(){};return p.add_input(q,{fieldset:{Class:s}}),p.add_input(r,{fieldset:{Class:s}}),c=o.id.add_to_form(p),b=o.title.add_to_form(p),o.keywords.add_to_form(p).select({tags:[],initSelection:function(a,b){var c=[];_(a.val().split(",")).forEach(function(a){a&&c.push({id:a,text:a})}),b(c)}}),g=p._element.find("fieldset."+s),h=p._element.find("fieldset."+d).detach(),m.column(0).append(p._element),m.column(1).append(n),p.add_input("submit",{value:"Done",fieldset:{Class:"submit"}}),k.body().append(m._element).addClass("edit-content").bind("close-plugin-edit",function(){k.destroy()}),e.select(q,{placeholder:"Choose a container"}),e.select(r,{placeholder:"Choose a content"}),a.content_url&&b.select({placeholder:"Search content",minimumInputLength:2,id:function(a){return a.title},initSelection:function(a,b){var c=a.val();b({title:c})},formatResult:function(a,b,c){return a.title||(a.title=c.term),"<p>"+a.title+"</p>"},formatSelection:function(b){return-1===b.id?c.val(""):b.id&&$.ajax({url:a.content_url+"/"+b.id,success:function(a){var b=a;a.data&&(b=a.data,delete a.data,_.extend(b,a)),j.content.update(b),j.content.update_form(p._element)}}),b.title},ajax:{url:a.content_url,minimumInputLength:3,data:function(b){return{q:b,per_page:l,field:["id","title"],content_type:j.content._meta.name,apikey:a.api_key}},results:function(a){return a.splice(0,0,{title:"",id:-1}),{results:a,more:_.size(a)-1===l}}}}),p.ajax({beforeSubmit:function(a){var b=j.content;return b.set_form_fields(a),j.set(b),k.fadeOut(),!1}}),r.change(function(){var a=this.value;if(j.content=j.content_history[a],!j.content){var b=i.content_type(a);b&&(j.content=new b)}if(j.content){j.log(j+" changed content type to "+j.content),j.content_history[j.content._meta.name]=j.content,j.content._meta.persistent?(g.after(h),j.content.update_form(p._element)):h.detach();var c=j.content.get_form();p._element.find(".content-form").remove(),c&&h.after(c._element.children("fieldset").addClass("content-form"))}else a?e.logger.error("Unknown content type "+a):(h.detach(),p._element.find(".content-form").remove());j.wrapper!==q.val()?q.val(j.wrapper).trigger("change"):t()}),q.change(function(){j.wrapper=this.value,t()}),k.set_current_view=function(a){j=a,j.content?(j.content_history[j.content._meta.name]=j.content,r.val(j.content._meta.name).trigger("change")):r.val("").trigger("change")},k},k=lux.View.extend({init:function(a,b,c){this.elem=$(a),this.options=b||{},this.parentType=c?c.type:null,this.name=this.elem.data("context"),this.elem.addClass("cms-"+this.type).data("cmsview",this)},render:function(){var a=this;this.elem.children().each(function(){a.create_child(this)}),this.elem.fadeTo("fast",1)},setupEdit:function(){var a=this;this.childType&&!this.editing&&_(this.childrenElem()).forEach(function(b){var c=$(b).data("cmsview");c?c.setupEdit():a.log("could not find editing element","WARNING")}),this.editing=!0},parent:function(){return this.parentType?this.container().closest(".cms-"+this.parentType).data("cmsview"):void 0},child:function(a){var b;return this.iter(function(c,d){return d===a?(b=c,lux.breaker):void 0}),b},childrenElem:function(){return this.childType?this.elem.find(".cms-"+this.childType):[]},iter:function(a){_(this.childrenElem()).forEach(function(b,c){a($(b).data("cmsview"),c)})},page:function(){return this.parent().page()},grid:function(){return this.parent().grid()},current_column:function(){return this.page().current_column()},index:function(){var a=this.parent(),b=-1,c=this.elem[0];return a&&_(a.childrenElem()).forEach(function(a,d){return c===a?(b=d,lux.breaker):void 0}),b},create_child:function(a,b){if(this.childType){var c=r[this.childType];if(!c)throw new lux.NotImplementedError(this+" has no create_child method.");a||(a=$(document.createElement("div")));var d=new c(a,this.options,this);return b===Object(b)&&a.data(b),d.render(this),d}},container:function(){return this.dialog?this.dialog.element():this.elem},get_column:function(){var a=this.childrenElem().first(),b=a.data("cmsview");return b.get_column()},layout:function(){var a,b=[];return this.iter(function(c){a=c.layout(),a&&b.push(a)}),b.length?b:null},_create_edit_dialog:function(a){return this.dialog||(this.dialog=e.dialog(a),this.elem.before(this.dialog.element()),this.dialog.body().append(this.elem)),this.dialog},log:function(a,b){var c=this.page();c&&c.logger&&c.logger.html(b?'<p class="text-danger">'+b+": "+a+"</p>":"<p>"+a+"</p>")},toString:function(){var a=this.index();return-1===a?this.type:this.type+"-"+a}}),l=k.extend({type:"page",childType:"grid",render:function(){var a=this;this.childrenElem().each(function(){a.create_child(this)}),this.options.editing&&(a.model=new h({id:this.options.editing}),this.setupEdit())},setupEdit:function(){if(!this.editing){var a=$(".cms-control");this.logger=$('<div class="cms-info"></div>'),a.length||(a=$(document.createElement("div")).addClass("cms-control").prependTo(document.body)),this.control=e.dialog(a,this.options.page),this.control.header().prepend(this.logger),a.show(),this._add_block_control(),this.options.block.dragdrop&&(this.options.block.dragdrop=this._create_drag_drop(this.options.block)),this.options.row.dragdrop&&(this.options.row.dragdrop=this._create_drag_drop(this.options.row)),this._super()}},page:function(){return this},grid:function(){return null},index:function(){return-1},get_current_column:function(){return this._current_column},set_current_column:function(a){this._current_column&&this._current_column.elem.removeClass("active"),this._current_column=a,a&&(this.log("Selected current "+a),a.elem.addClass("active"))},layout:function(){var a,b={};return this.iter(function(c){a=c.layout(),a&&(b[c.name]=a)}),b},sync:function(){var a=this;this.model.set("content",this.layout()),this.log("saving layout..."),this.model.sync({success:function(){a.log("Layout saved")}})},_add_block_control:function(){var a=this,b=a.options,c=this.control,d=c.create_button({icon:b.add_block_icon,title:"Add new block"}),e=a.select_layouts().addClass(b.skin);a.control.buttons.prepend(e).prepend(d),d.click(function(){var b=e.val(),c=a.get_current_column();(!c||c.index()<0)&&(c=a.get_column(),a.set_current_column(c)),c?c.add_block(b):a.log("WARNING: No column available!")})},select_layouts:function(){var a=$(document.createElement("select"));return b.each(function(b,c){a.append($("<option></option>").attr("value",c).text(c))}),a},_create_drag_drop:function(a){var b=this,c=new e.DragDrop({dropzone:"."+a.dropzone,placeholder:$(document.createElement("div")).addClass(a.dropzone),onDrop:function(a){c.moveElement(a,this),b.sync()}});return c.add("."+a.dropzone,"."+a.dropzone+" > .header"),c}}),m=k.extend({type:"grid",childType:"row",setupEdit:function(){if(!this.editing){var b=this,c=this._create_edit_dialog(this.options.grid),d=c.create_button({icon:this.options.add_row_icon,title:"Add new row"}),e=$(document.createElement("select")).addClass(c.options.skin);c.title(this.name),a.each(function(a,b){e.append($("<option></option>").attr("value",b).text(b))}),c.buttons.prepend(e).prepend(d),d.click(function(){var a=b.create_child(null,{template:e.val()});b.elem.append(a.container()),a.setupEdit()}),this._super()}},grid:function(){return this},index:function(){return this.name},toString:function(){return this.type+"-"+this.name}}),n=k.extend({type:"row",childType:"column",templates:a,render:function(){"row"==this.type&&this.elem.addClass("row grid"+this.options.columns),this.templateName=this.elem.data("template"),this.template=this.templateName?this.templates.get(this.templateName):null,this.template||(this.templateName=this.templates.order[0],this.template=this.templates.get(this.templateName));var a=this,b=this.template.length,c=0;for(this.elem.children().detach().each(function(){b>c&&(a.template.append(a.create_child(this),a,c),c+=1)});b>c;c++)a.template.append(a.create_child(),a,c)},setupEdit:function(){this._create_edit_dialog(this.options[this.type]),this._super()},layout:function(){var a=[],b=!1;return _(this.childrenElem()).forEach(function(c){c=$(c).data("cmsview");var d=c.layout();a.push(d),d&&(b=!0)}),b?{template:this.templateName,children:a}:void 0},_create_edit_dialog:function(a){if(!this.dialog){var b=this._super(a),c=this.page();b.container().addClass(a.dropzone),b.element().bind("removed",function(){c&&c.sync()})}return this.dialog}}),o=k.extend({type:"column",childType:"block",setupEdit:function(){if(!this.editing){var a=this;this.elem.click(function(){a.page().set_current_column(a)}),this._super()}},get_column:function(){return this},add_block:function(a){var b=this.create_child(null,{template:a});this.elem.append(b.container()),this.log("Added new "+b),this.editing&&b.setupEdit()}}),p=n.extend({type:"block",childType:"content",templates:b,get_column:function(){return this.parent()}}),q=k.extend({type:"content",render:function(){var a=this,b=this.elem.data(),c=lux.cms.content_type(b.content_type);c&&(this.wrapper=b.wrapper,b=_.merge({},b),delete b.wrapper,delete b.content_type,delete b.cmsview,this.elem.children().each(function(){var c=$(this),d=c.data("field");d?b[d]=c.html():a.log("Field not available in content","WARNING")}),this.set(new c(b),!1))},setupEdit:function(){if(!this.editing){{var a=this,b=$(document.createElement("div")),c=$(document.createElement("div")).addClass("cms-content-toolbar").appendTo(b),d=$(document.createElement("div")).addClass("btn-group right").appendTo(c),e=this.parent();e.dialog.create_button({icon:"edit",size:"mini"}).click(function(){a.edit_content()}).appendTo(d)}this.button_group=d,this.title=$(document.createElement("span")).prependTo(c),b.appendTo(this.elem.parent()),this.elem.addClass("preview").appendTo(b),this._container=b,this.content_history={},this.editing=!0,this.content&&this.title.html(this.content._meta.title)}},container:function(){return this._container?this._container:this.elem},child:function(){return null},get_content:function(a){var b=lux.cms.content_type(a.content_type),c=this;if(b){var d=this.elem.data("fields");a.fields||0===d?(d=a.fields,a.id&&(d=d||{},d.id=a.id),this.set(new b(d),!1)):a.id?b._meta.get(a.id,{success:function(a){c.set(a[0],!1)}}):c.log("could not understand content!","WARNING")}},layout:function(){return this.content?{content:this.content.serialize(),wrapper:this.wrapper}:void 0},set:function(a,b){this.content=a;var c=i.wrapper_type(this.wrapper);if(this.elem.html(""),c?c.render(this):a.render(this.elem),this.title&&this.title.html(a._meta.title),b!==!1){var d=this,e=this.page();try{a.sync({success:function(){d.log(d+" set content to "+d.content),e.sync()}})}catch(f){d.log("ERROR while synching. "+f)}}},get_column:function(){return this.parent.get_column()},edit_content:function(){var a=this.page(),b=a._content_dialog;return b||(b=j(a.options),a._content_dialog=b),b.set_current_view(this),b.fadeIn(),b}}),r=lux.cms.ContentViewMap={page:l,grid:m,row:n,column:o,block:p,content:q},s=lux.Class.extend({init:function(a){this.length=a},append:function(a,b){var c=a.container();if(1===this.length)b.elem.append(c);else{{b.inner}b.elem.children().length||b.elem.addClass("row grid"+b.options.columns),c.addClass("span"+b.options.columns/this.length).appendTo(b.elem)}}}),t=s.extend({append:function(a,b){var c=a.container();if(1===this.length)b.elem.append(c);else{var d=b.inner,e=lux.s4(),f=a.elem.attr("title"),g=$(document.createElement("a")).attr("href","#"+e).html(f);d||(b.ul=$(document.createElement("ul")).appendTo(b.elem),b.inner=d=$(document.createElement("div")).appendTo(b.elem)),b.ul.append($(document.createElement("li")).append(g)),b.inner.append($(document.createElement("div")).attr("id",e).append(c))}}}),u=lux.Class.extend({init:function(a){this.splits=a,this.length=a.length},append:function(a,b,c){var d=a.container();d.addClass("column span"+this.splits[c]*b.options.columns),b.elem.append(d)}});a.set("One Column",new u([1])),a.set("Half-Half",new u([.5,.5])),a.set("33-66",new u([1/3,2/3])),a.set("66-33",new u([2/3,1/3])),a.set("25-75",new u([.25,.75])),a.set("75-25",new u([.75,.25])),a.set("33-33-33",new u([1/3,1/3,1/3])),a.set("50-25-25",new u([.5,.25,.25])),a.set("25-25-50",new u([.25,.25,.5])),a.set("25-50-25",new u([.25,.5,.25])),a.set("25-25-25-25",new u([.25,.25,.25,.25])),b.set("1 element",new s(1)),b.set("2 elements",new s(2)),b.set("3 elements",new s(3)),b.set("2 tabs",new t(2)),b.set("3 tabs",new t(3)),b.set("4 tabs",new t(4));var v=function(a,b){var c=$("<div class='panel panel-default'></div>").appendTo(a.elem),d=$("<div class='panel-heading'></div>").appendTo(c),e=$("<div class='panel-body'></div>").appendTo(c),f=a.content.get("title");b&&(d=$("<h3 class='panel-title'></h3>").appendTo(d)),f&&d.html(f),a.content.render(e)};lux.cms.create_wrapper("nothing",{title:"No Wrapper"}),lux.cms.create_wrapper("well",{title:"Well",render:function(a){var b=$("<div class='well'></div>").appendTo(a.elem);a.content.render(b)}}),lux.cms.create_wrapper("welllg",{title:"Well Large",render:function(a){var b=$("<div class='well well-lg'></div>").appendTo(a.elem);a.content.render(b)}}),lux.cms.create_wrapper("wellsm",{title:"Well Small",render:function(a){var b=$("<div class='well well-sm'></div>").appendTo(a.elem);a.content.render(b)}}),lux.cms.create_wrapper("panel",{title:"Panel",render:function(a){var b=$("<div class='panel panel-default'></div>").appendTo(a.elem),c=$("<div class='panel-body'></div>").appendTo(b);a.content.render(c)}}),lux.cms.create_wrapper("panelheading",{title:"Panel with heading",render:function(a){v(a)}}),lux.cms.create_wrapper("paneltitle",{title:"Panel with title",render:function(a){v(a,!0)}}),lux.cms.create_content_type("contenturl",{meta:{title:"Site Content"},render:function(a){var b=this.get("content_url"),c=this.get("jQuery");"this"===b&&(b=lux.web.options.this_url),c?a.append(c):b?(a.html("&nbsp;"),$.ajax(b,{dataType:"json",success:function(b){b.html&&require(b.requires||[],function(){e.refresh(a.html(b.html))})}})):e.logger.warning("Missing underlying page url and html")},get_form:function(){var a=lux.web.form(),b=a.add_input("select",{name:"content_url"});return $(document.createElement("option")).val("this").html("this").appendTo(b),_(lux.web.options.content_urls).forEach(function(a){$(document.createElement("option")).val(a[1]).html(a[0]).appendTo(b)}),a}}),lux.cms.create_content_type("blank",{model_title:"The content served by the url",render:function(a){a.html("&nbsp;")}}),lux.cms.create_content_type("markdown",{meta:{title:"Text using markdown",persistent:!0,fields:{raw:new lux.TextArea({rows:15,placeholder:"Write markdown"}),javascript:new lux.TextArea({rows:10,placeholder:"javascript"})}},render:function(a){var b=this;require(["showdown"],function(){var c=b.get("raw")||"",d=b.get("javascript")||"",f=new Showdown.converter,g=f.makeHtml(c);if(e.refresh(a.html(g)),d){var h=$("body"),i=$("<script type='application/javascript'>"+d+"</script>"),j="markdown-"+b.id();$("#"+j,h).remove(),h.append(i.attr("id",j))}})},get_form:function(){var a=this._meta.fields,b=lux.web.form();return a.raw.add_to_form(b,this),a.javascript.add_to_form(b,this),b}}),lux.cms.create_content_type("versions",{meta:{title:"Versions of libraries"},render:function(a){var b=$(document.createElement("ul")).appendTo(a);_(e.libraries).forEach(function(a){b.append($('<li><a href="'+a.web+'">'+a.name+"</a> "+a.version+"</li>"))})}}),i.create_content_type("datatable",{meta:{title:"Data Grid",persistent:!0,render_queue:[],api_info:function(a){this.api=a||{};var b=this.render_queue;delete this.render_queue,_.each(b,function(a){a.content._render(a.container)})},fields:{sortable:new lux.BooleanField({label:"Sortable"}),editable:new lux.BooleanField({label:"Editable"}),footer:new lux.BooleanField({label:"Display Footer"}),row_actions:new lux.MultiField({label:"Row actions",placeholder:"Action on rows",options:[{value:"delete"}]})}},render:function(a){var b=this;require(["datagrid"],function(){void 0===b._meta.api?b._meta.render_queue.push({content:b,container:a}):b._render(a)})},get_form:function(){var a=this._api();return a.groups?this._get_form(a):void 0},_render:function(a){var b=$(document.createElement("div")).appendTo(a),c=_.extend({},this.fields()),d=this._api().models,e=d?d[c.url]:null,f=[];if(e){if(c.fields){var g={};_(e.fields).forEach(function(a){g[a.code]=a}),_(c.fields).forEach(function(a){var b=g[a];b&&f.push(b)})}c.columns=f.length?f:e.fields,c.ajaxUrl=c.url,lux.web.datagrid(b,c)}},_api:function(){var a=this._meta.api;return a?(!a.groups&&a.sitemap&&this._create_groups(a),a):{}},_create_groups:function(a){var b=[],c={};_(a.sitemap).forEach(function(a){var d=$(document.createElement("optgroup")).attr("label",a.name);b.push(d),_(a.routes).forEach(function(a){$(document.createElement("option")).val(a.api_url).html(a.model).appendTo(d),c[a.api_url]=a})}),a.groups=b,a.models=c},_get_form:function(a){var b=this,c=lux.web.form(),d=c.add_input("select",{name:"url"}),e=a.models,f=this._meta.fields;d.append($(document.createElement("option")).html("Choose a model")),_(a.groups).forEach(function(a){d.append(a)});var g=c.add_input("select",{multiple:"multiple",name:"fields",placeholder:"Select fields to display"}).select();return f.sortable.add_to_form(c,this),f.editable.add_to_form(c,this),f.footer.add_to_form(c,this),f.row_actions.add_to_form(c,this).select(),d.select().change(function(){var a=$(this).val(),c=e[a];g.val([]).trigger("change"),g.children().remove(),c&&(c.options?_(c.options).forEach(function(a){g.append(a)}):(c.options=[],c.map={},_(e[a].fields).forEach(function(a){var b=$(document.createElement("option")).val(a.code).html(a.name);c.map[a.code]=a,c.options.push(b),g.append(b)})),a===b.get("url")&&_(b.get("fields")).forEach(function(){}))}),d.val(this.get("url")).trigger("change"),c}}),lux.web.extension("cms",{selector:"div.cms-page",options:{editing:!1,backend_url:null,content_url:null,add_row_icon:"columns",add_block_icon:"plus",skin:"control",row_control_class:"add-row",columns:24,hartbeat:5,page:{collapsable:!0,collapsed:!0,class_name:"control",skin:"inverse",buttons:{size:"default"}},grid:{collapsable:!0,skin:null,class_name:"control",buttons:{size:"default"}},row:{closable:!0,collapsable:!0,skin:"default",size:"mini",dragdrop:!1,dropzone:"row-control"},block:{closable:!0,collapsable:!0,skin:"primary",size:"mini",dragdrop:!0,dropzone:"block-control"},contentedit:{modal:!0,movable:!0,fullscreen:!0,autoOpen:!1,title:"Edit Content",fade:{duration:20},closable:{destroy:!1}}},decorate:function(){var a=this,b=a.options,c=a._element;b.editing&&(c.addClass("editing"),lux.cms._backend?a.backend=e.backend({socket:lux.cms._backend}):(a.backend=e.backend({host:b.backend_url,hartbeat:b.hartbeat}),lux.cms.set_transport(a.backend.socket))),a._setup_api(),a.view=new l(c,b),a.view.render()},_setup_api:function(){var a=$("html").data("api");if(a){var b=this;$.ajax(a.url,{dataType:"json",success:function(c){b.on_sitemap(a,c)},error:function(){b.on_sitemap(a)}})}else this.on_sitemap()},on_sitemap:function(a,b){var c=i.content_type("datatable");c&&(a&&(a.sitemap=b),c._meta.api_info(a))},_handle_close:function(){$(window).bind("beforeunload",function(a){return a.preventDefault(),!1})}}),lux.web.extension("grid",{defaultElement:"div",options:{template:"Half-Half",columns:24},decorate:function(){var b=a.get(this.options.template),c=this.options,d=this.element();b||(this.options.template="Half-Half",b=a.get(this.options.template)),this.template=b,d.addClass("row grid"+this.options.columns),_(this.template).forEach(function(a){var b=a*c.columns,e=$(document.createElement("div")).addClass("column span"+b);d.append(e)})},column:function(a){var b=this._element[0].childNodes;return $(b[a])}})});