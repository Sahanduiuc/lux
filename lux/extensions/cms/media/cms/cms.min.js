define(["lux-web"],function(){"use strict";var a=new lux.Ordered,b=new lux.Ordered,c=lux.web,d=lux.Model.extend({show_title:!1,meta:{name:"content"},edit_element:function(a){var b=this,c=this.get_form();return c?(c.ajax({beforeSubmit:function(c){var d=b.get_form_fields(c);return b.update(d),a.set(b),b.close(),!1}}),c.element()):void 0},get_form_fields:function(a){var b={};return _(a).forEach(function(a){var c=b[a.name];void 0===c?b[a.name]=a.value:$.isArray(c)?c.push(a.value):b[a.name]=[c,a.value]}),b},get_form:function(){var a=lux.web.form();return a.add_input("submit",{value:"Done"}),a},render:function(){},edit:function(a,b){this.container=b.html(""),this.show_title&&b.append($(document.createElement("h3")).html(this._meta.title));var c=this.edit_element(a);c&&this.container.append(c)},close:function(){this.container&&(this.container.trigger("close-plugin-edit"),delete this.container)}}),e=lux.Model.extend({}),f=lux.Model.extend({meta:{name:"page",_content_types:{},_wrapper_types:{},content_type:function(a){return this._content_types[a]},wrapper_type:function(a){return this._wrapper_types[a]},content_types:function(){return this._sorted(this._content_types)},wrapper_types:function(){return this._sorted(this._wrapper_types)},_sorted:function(a){var b=[];return _(a).forEach(function(a){b.push({value:a._meta.name,text:a._meta.title})}),b.sort(function(a,b){return a.text>b.text?1:-1}),b},create_content_type:function(a,b,c){var e=b.meta;e||(b.meta=e={}),e.name=a.toLowerCase(),c||(c=d);var f=c.extend(b);return f._meta.set_transport(this._backend),this._content_types[f.prototype._meta.name]=f,f},create_wrapper:function(a,b,c){var d=b.meta;d||(b.meta=d={}),d.name=a.toLowerCase(),c||(c=e);var f=c.extend(b);return this._wrapper_types[f.prototype._meta.name]=f,f},set_transport:function(a){this._backend=a,_(this._content_types).forEach(function(b){b._meta.set_transport(a)})}},update_content:function(a){var b=a.id,d=a.data;if(b&&d){var e=this.content_type(d.content_type);if(e){var f=e.prototype._meta;return f.update(b,d)}}c.logger.error("Could not understand content")}}),g=lux.cms=f._meta;g.Content=d;var h=function(a,b){if(a._content_dialog)return a._content_dialog;b=b||{};var d=c.dialog({modal:!0,movable:!0,fullscreen:!0,title:"Edit Content"}),e=c.grid(),f=$(document.createElement("div")).addClass("preview"),h=c.form(),i=c.create_select(g.wrapper_types()),j=c.create_select(g.content_types()),k=c.create_select(),l=$(document.createElement("fieldset")).addClass("search").hide();return h.add_input(i),h.add_input(j),l.append(k),h._element.append(l),e.column(0).append(h._element),e.column(1).append(f),d.body().append(e._element).addClass("edit-content").bind("close-plugin-edit",function(){d.destroy()}),c.select(i),c.select(j),j.change(function(){var b=this.value;if(a.content=a.content_history[b],!a.content){var d=g.content_type(b);d&&(a.content=new d)}a.content?(c.logger.info(a+" changed content type to "+a.content),a.content_history[a.content._meta.name]=a.content,a.content._meta._persistent?l.show():l.hide(),a.content.edit(a,h)):c.logger.error("Unknown content type "+b)}),i.change(function(){}),a.content&&(a.content_history[a.content._meta.name]=a.content,j.val(a.content._meta.name).trigger("change")),d},i=lux.View.extend({type:"page",childType:"grid",init:function(a,b,d){this.elem=$(a),this.options=b||{},this.parentType=d?d.type:null,this.name=this.elem.data("context"),this.elem.addClass("cms-"+this.type).data("cmsview",this),this.setup(),this.options.editing&&(this.setupEdit(d),c.logger.info("Created "+this))},setup:function(){},setupEdit:function(){},parent:function(){return this.container().closest(".cms-"+this.parentType).data("cmsview")},child:function(a){var b;return this.iter(function(c,d){return d===a?(b=c,lux.breaker):void 0}),b},numChildren:function(){return this.childrenElem().length},childrenElem:function(){return this.elem.find(".cms-"+this.childType)},iter:function(a){_(this.childrenElem()).forEach(function(b,c){return a($(b).data("cmsview"),c)})},page:function(){return $(".cms-page").data("cmsview")},grid:function(){return this.parent().grid()},current_column:function(){return this.page().current_column()},index:function(){var a=this.parent(),b=-1,c=this.elem[0];return a&&_(a.childrenElem()).forEach(function(a,d){return c===a?(b=d,lux.breaker):void 0}),b},render:function(a){a=this.create_children(a),_(a).forEach(function(a,b){var c=this.child(b);c?c.render(a):this.create_child(null,a)},this),this.elem.fadeTo("fast",1)},create_child:function(a,b){var c=p[this.childType];if(!c)throw new lux.NotImplementedError(this+" has no create_child method.");a||(a=$(document.createElement("div")));var d=new c(a,this.options,this);return this.elem.append(d.container()),d.render(b),d},create_children:function(a){if(!this.numChildren()){var b=this;this.elem.children().detach().each(function(c){b.create_child(this,a?a[c]:null)});var c=this.numChildren();if(c&&a)return a.splice(c)}return a},container:function(){return this.dialog?this.dialog.element():this.elem},get_column:function(){var a=this.childrenElem().first(),b=a.data("cmsview");return b.get_column()},layout:function(){var a,b=[];return this.iter(function(c){a=c.layout(),a&&b.push(a)}),b.length?b:null},drag_drop_dialog:function(a,b){var d=c.dialog(b),e=this.page();return d.body().append(this.elem),a.elem.append(d.container().addClass(b.dropzone)),this.dialog=d,d.element().bind("removed",function(){e.sync()}),d},toString:function(){var a=this.index();return-1===a?this.type:this.type+"-"+a}}),j=i.extend({init:function(a,b){var c=this;this.model=a,this.cms=b,this._super(b.element(),b.options),_(this.childrenElem()).forEach(function(a){a=$(a);var b=a.next(),d=a.parent(),e=new k(a,c.options,c);b.length?b.before(e.container()):d.append(e.container())})},setupEdit:function(){var a=this.cms,b=$(".cms-control");b.length||(b=$(document.createElement("div")).addClass("cms-control").prependTo(document.body)),delete this.cms,this.control=c.dialog(b,this.options.page),b.show(),a.backend.element().prependTo(this.control.header()),this._add_block_control(),this.options.block.dragdrop&&(this.options.block.dragdrop=this._create_drag_drop(this.options.block)),this.options.row.dragdrop&&(this.options.row.dragdrop=this._create_drag_drop(this.options.row))},parent:function(){return null},page:function(){return this},grid:function(){return null},index:function(){return-1},get_current_column:function(){return this._current_column},set_current_column:function(a){this._current_column&&this._current_column.elem.removeClass("active"),this._current_column=a,a&&(c.logger.info("Selected current "+a),a.elem.addClass("active"))},layout:function(){var a,b={};return this.iter(function(c){a=c.layout(),a&&(b[c.name]=a)}),b},render:function(){if(this.model){var a,b={};this.iter(function(a){b[a.name]=a}),_(this.model.get("content")).forEach(function(c,d){a=b[d],a&&a.render(c)},this)}else this.iter(function(a){a.render()})},sync:function(a){this.model.set("content",this.layout()),c.logger.info(this+" sync with backend"),this.model.sync(a)},_add_block_control:function(){var a=this,b=a.options,d=this.control,e=d.create_button({icon:b.add_block_icon,title:"Add new block"}),f=a.select_layouts().addClass(b.skin);a.control.buttons.prepend(f).prepend(e),e.click(function(){var b=f.val(),d=a.get_current_column();(!d||d.index()<0)&&(d=a.get_column(),a.set_current_column(d)),d?d.create_child(null,{template:b}):c.logger.warning("No column available!")})},select_layouts:function(){var a=$(document.createElement("select"));return b.each(function(b,c){a.append($("<option></option>").attr("value",c).text(c))}),a},_create_drag_drop:function(a){var b=this,d=new c.DragDrop({dropzone:"."+a.dropzone,placeholder:$(document.createElement("div")).addClass(a.dropzone),onDrop:function(a){d.moveElement(a,this),b.sync()}});return d.add("."+a.dropzone,"."+a.dropzone+" > .header"),d}}),k=i.extend({type:"grid",childType:"row",setupEdit:function(){var b=this,d=this.dialog=c.dialog(this.options.grid),e=d.create_button({icon:this.options.add_row_icon,title:"Add new row"}),f=$(document.createElement("select")).addClass(d.options.skin);a.each(function(a,b){f.append($("<option></option>").attr("value",b).text(b))}),d.buttons.prepend(f).prepend(e),e.click(function(){b.create_child(null,{template:f.val()})}),d.title(this.name),d.body().append(this.elem.fadeTo("fast",1))},grid:function(){return this},index:function(){return this.name},toString:function(){return this.type+"-"+this.name}}),l=i.extend({type:"row",childType:"column",templates:a,setup:function(){this.elem.addClass("row grid"+this.options.columns),this.templateName=this.elem.data("template")},setupEdit:function(a){this.drag_drop_dialog(a,this.options.row)},render:function(a){this.template=this.get_template(a),a=a&&a.children?a.children.splice(0,this.template.length):[];for(var b=a.length;b<this.template.length;b++)a[b]=null;a=this.create_children(a);var c=this.template.length-a.length;_(a).forEach(function(b,d){var e=this.child(d+c);e?e.render(a[d]):this.create_child(null,a[d])},this)},create_child:function(a,b){var c=this.numChildren();if(c<this.template.length){var d=this._super(a,b);return d.container().addClass("column span"+this.template[c]*this.options.columns),d}},get_template:function(a){var b=this.templateName?this.templates.get(this.templateName):null;if(a&&a.template){var c=this.templates.get(a.template);c&&(this.templateName=a.template,b=c)}return b||(this.templateName=this.templates.order[0],b=this.templates.get(this.templateName)),this.dialog&&this.dialog.title(this.templateName),b},layout:function(){var a=[],b=!1;return _(this.childrenElem()).forEach(function(c){c=$(c).data("cmsview");var d=c.layout();a.push(d),d&&(b=!0)}),b?{template:this.templateName,children:a}:void 0}}),m=i.extend({type:"column",childType:"block",setupEdit:function(){var a=this;this.elem.click(function(){a.page().set_current_column(a)})},get_column:function(){return this}}),n=l.extend({type:"block",childType:"position",templates:b,setup:function(){this.elem.addClass("block"),this.templateName=this.elem.data("template")},setupEdit:function(a){this.drag_drop_dialog(a,this.options.block)},create_child:function(a,b){var c=this.numChildren();if(c<this.template.length){var d=p[this.childType];if(!d)throw new lux.NotImplementedError(this+" has no create_child method.");a||(a=$(document.createElement("div")));var e=new d(a,this.options,this);return this.template.append(e,this,c),e.render(b),e}},get_column:function(){return this.parent()}}),o=i.extend({type:"position",childType:null,setup:function(){var a=this.elem.attr("id");this.elem.addClass("content"),a&&(a=a.split("-"),2===a.length&&lux.cms.content_type(a[0])&&(this.content_type={content_type:a[0],id:a[1]}))},setupEdit:function(a){var b=this,c=$(document.createElement("div")),d=$(document.createElement("div")).addClass("cms-position-toolbar").appendTo(c),e=$(document.createElement("div")).addClass("btn-group right").appendTo(d),f=(a.dialog.create_button({icon:"edit",size:"mini"}).click(function(){b.edit_content()}).appendTo(e),$(document.createElement("span")).prependTo(d));this.button_group=e,this.title=f,c.appendTo(this.elem.parent()),this.elem.addClass("preview").appendTo(c),this._container=c,this.content_history={}},container:function(){return this._container?this._container:this.elem},child:function(){return null},create_child:function(a){if(this.content_type&&a){a=$(a);var b=a.data("field");this.content_type.fields||(this.content_type.fields={}),b?this.content_type.fields[b]=a.data("value")||a.html():this.content_type.fields.jQuery=a}},render:function(a){this.create_children(a),this.content_type?(this.get_content(this.content_type),delete this.content_type):a&&a.content_type&&this.get_content(a)},get_content:function(a){var b=lux.cms.content_type(a.content_type),d=this;if(b){var e=this.elem.data("fields");a.fields||0===e?(e=a.fields,a.id&&(e=e||{},e.id=a.id),this.set(new b(e),!1)):a.id?b._meta.get(a.id,{success:function(a){d.set(a[0],!1)}}):c.logger.warning("Could not understand content")}},layout:function(){return this.content?{id:this.content.pk(),content_type:this.content._meta.name}:void 0},set:function(a,b){if(this.content=a,a.render(this.elem),this.title&&this.title.html(a._meta.title),b!==!1){var d=this,e=this.page();try{a.sync({success:function(){c.logger.info(d+" set content to "+d.content),e.sync()}})}catch(f){c.logger.error(f)}}},get_column:function(){return this.parent.get_column()},edit_content:function(){return h(this)},_old_edit_content:function(){if(!this._content_dialog){var a=c.dialog({modal:!0,movable:!0,fullscreen:!0,title:"Edit Content"}),b=this,d=$(document.createElement("select")),e=$(document.createElement("div")).addClass("vpadding-small").append(d),f=$(document.createElement("div")),g=lux.cms;return d.append($("<option></option>")),_(g.content_types()).forEach(function(a){var b=a._meta;d.append($("<option></option>").val(b.name).text(b.title))}),c.select(d,{placeholder:"Select a Content"}),a.body().append(e).append(f).addClass("edit-content").bind("close-plugin-edit",function(){a.destroy()}),d.change(function(){var a=d.val();if(b.content=b.content_history[a],!b.content){var e=g.content_type(a);e&&(b.content=new e)}b.content?(c.logger.info(b+" changed content type to "+b.content),b.content_history[b.content._meta.name]=b.content,b.content.edit(b,f)):c.logger.error("Unknown content type "+a)}),this.content&&(this.content_history[this.content._meta.name]=this.content,d.val(this.content._meta.name).trigger("change")),a}return this._dialog}}),p={page:j,grid:k,row:l,column:m,block:n,position:o};lux.cms.ContentView=i,lux.cms.ContentViewMap=p;var q=lux.Class.extend({init:function(a){this.length=a},append:function(a,b){var c=a.container();if(1===this.length)b.elem.append(c);else{{b.inner}b.elem.children().length||b.elem.addClass("row grid"+b.options.columns),c.addClass("span"+b.options.columns/this.length).appendTo(b.elem)}}}),r=q.extend({append:function(a,b){var c=a.container();if(1===this.length)b.elem.append(c);else{var d=b.inner,e=lux.s4(),f=a.elem.attr("title"),g=$(document.createElement("a")).attr("href","#"+e).html(f);d||(b.ul=$(document.createElement("ul")).appendTo(b.elem),b.inner=d=$(document.createElement("div")).appendTo(b.elem)),b.ul.append($(document.createElement("li")).append(g)),b.inner.append($(document.createElement("div")).attr("id",e).append(c))}}});a.set("One Column",[1]),a.set("Half-Half",[.5,.5]),a.set("33-66",[1/3,2/3]),a.set("66-33",[2/3,1/3]),a.set("25-75",[.25,.75]),a.set("75-25",[.75,.25]),a.set("33-33-33",[1/3,1/3,1/3]),a.set("50-25-25",[.5,.25,.25]),a.set("25-25-50",[.25,.25,.5]),a.set("25-50-25",[.25,.5,.25]),a.set("25-25-25-25",[.25,.25,.25,.25]),b.set("1 element",new q(1)),b.set("2 elements",new q(2)),b.set("3 elements",new q(3)),b.set("2 tabs",new r(2)),b.set("3 tabs",new r(3)),b.set("4 tabs",new r(4)),lux.cms.create_content_type("contenturl",{meta:{title:"Site Content"},render:function(a){var b=this.get("content_url"),d=this.get("jQuery");"this"===b&&(b=lux.web.options.this_url),d?a.append(d):b?(a.html("&nbsp;"),$.ajax(b,{dataType:"json",success:function(b){b.html&&require(b.requires||[],function(){c.refresh(a.html(b.html))})}})):c.logger.warning("Missing underlying page url and html")},get_form:function(){var a=lux.web.form(),b=a.add_input("select",{name:"content_url"});return $(document.createElement("option")).val("this").html("this").appendTo(b),_(lux.web.options.content_urls).forEach(function(a){$(document.createElement("option")).val(a[1]).html(a[0]).appendTo(b)}),a.add_input("submit",{value:"Done"}),a}}),lux.cms.create_content_type("blank",{model_title:"The content served by the url",render:function(a){a.html("&nbsp;")}}),lux.cms.create_content_type("markdown",{model_title:"Text using markdown",render:function(a){var b=this;require(["showdown"],function(){var d=b.get("raw")||"",e=new Showdown.converter,f=e.makeHtml(d);c.refresh(a.html(f))})},get_form:function(){{var a=lux.web.form();a.add_input("textarea",{name:"raw",value:this.get("raw"),rows:15,placeholder:"Write markdown"})}return a.add_input("submit",{value:"Done"}),a}}),lux.cms.create_content_type("versions",{model_title:"Versions of libraries",render:function(a){var b=$(document.createElement("ul")).appendTo(a);_(c.libraries).forEach(function(a){b.append($('<li><a href="'+a.web+'">'+a.name+"</a> "+a.version+"</li>"))})}}),lux.web.extension("api",{selector:"html",decorate:function(){if(this.url=this.element().data("api"),this.url){var a=this;$.ajax(this.url,{dataType:"json",success:function(b){a.on_sitemap(b)}})}else this.on_sitemap()},on_sitemap:function(a){var b=this,c={},d=null;this.models=c,lux.cms.create_content_type("datatable",{model_title:"Data Grid",render:function(a){var b=this.get("jQuery");b||(b=$(document.createElement("div")).data({colHeaders:this.get("fields"),ajaxUrl:this.get("url")})),b.appendTo(a.html("")),require(["datagrid"],function(){lux.web.datagrid(b)})},get_form_fields:function(a){var b=this._super(a),d=c[b.url];if(d){var e=[];return b.fields?each(b.fields,function(a){e.push(d.map[a])}):e=d.fields,b.fields=e,b}return{}},get_form:function(){return!d&&a&&(d=b.create_groups(a)),d?b.create_form(d):void 0}})},create_groups:function(a){var b=[],c=this.models;return each(a,function(a){var d=$(document.createElement("optgroup")).attr("label",a.name);b.push(d),each(a.routes,function(a){$(document.createElement("option")).val(a.api_url).html(a.model).appendTo(d),c[a.api_url]=a})}),b},create_form:function(a){var b=lux.web.form(),c=b.add_input("select",{name:"url"}),d=this.models;c.append($(document.createElement("option")).html("Choose a model")),each(a,function(a){c.append(a)});var e=b.add_input("select",{multiple:"multiple",name:"fields"}).select2({placeholder:"Select fields to display"});return b.add_input("checkbox",{name:"editable",label:"Editable"}),b.add_input("checkbox",{name:"footer",label:"Display footer"}),b.add_input("submit",{value:"Done"}),c.select2().change(function(){var a=$(this).val(),b=d[a],c=b.options;e.val([]).trigger("change"),e.children().remove(),c?each(c,function(a){e.append(a)}):(b.options=c=[],b.map={},each(d[a].fields,function(a){var d=$(document.createElement("option")).val(a.code).html(a.name);b.map[a.code]=a,c.push(d),e.append(d)}))}),b}}),lux.web.extension("cms",{selector:"div.cms-page",options:{editing:!1,backend_url:null,add_row_icon:"columns",add_block_icon:"plus",skin:"control",row_control_class:"add-row",columns:24,page:{collapsable:!0,collapsed:!0,class_name:"control",skin:"inverse",buttons:{size:"default"}},grid:{collapsable:!0,skin:null,class_name:"control",buttons:{size:"default"}},row:{closable:!0,collapsable:!0,skin:"default",size:"mini",dragdrop:!1,dropzone:"row-control"},block:{closable:!0,collapsable:!0,skin:"primary",size:"mini",dragdrop:!0,dropzone:"block-control"}},decorate:function(){{var a=this,b=a.options,d=a.element();$(".cms-control")}b.editing?(d.addClass("editing"),a.backend=c.backend({host:b.backend_url,hartbeat:5}),lux.cms.set_transport(a.backend.socket),lux.cms.get(b.editing,{success:function(b){a.view=new j(b[0],a),a.view.render()}})):(a.view=new j(null,this),a.view.render())},_handle_close:function(){$(window).bind("beforeunload",function(a){return a.preventDefault(),!1})}}),lux.web.extension("grid",{defaultElement:"div",options:{template:"Half-Half",columns:24},decorate:function(){var b=a.get(this.options.template),c=this.options,d=this.element();b||(this.options.template="Half-Half",b=a.get(this.options.template)),this.template=b,d.addClass("row grid"+this.options.columns),_(this.template).forEach(function(a){var b=a*c.columns,e=$(document.createElement("div")).addClass("column span"+b);d.append(e)})},column:function(a){var b=this._element[0].childNodes;return $(b[a])}})});