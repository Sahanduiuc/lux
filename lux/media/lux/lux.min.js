define(["jquery","angular","angular-sanitize"],function(a){"use strict";function b(a,b,c,d){var e=this;this.lux=d,this.name=a,this.url=b,this.auth=null,this.request=function(a,b,f){var g=d.q.defer(),h=g.promise,i={deferred:g,options:angular.extend({method:a},f),urlparams:b,api:e,error:function(a,b,c){angular.isString(a)&&(a={error:!0,message:a}),g.reject({data:a,status:b,headers:c})},success:function(a,b,c){g.resolve({data:a,status:b,headers:c})}};return h.success=function(a){return h.then(function(b){a(b.data,b.status,b.headers)}),h},h.error=function(a){return h.then(null,function(b){a(b.data,b.status,b.headers)}),h},c.call(i),h},this.get=function(a,b){return e.request("GET",a,b)},this.put=function(a,b){return b=a.id?angular.extend({url:function(b){return b+"/"+a.id},data:a,method:"POST"},b):angular.extend({data:a,method:"POST"},b),e.request(b)},this.getMany=function(a){return e.request(angular.extend({method:"GET"},a))}}function c(a,b){angular.forEach(a,function(a){var c=b[a];c&&c.href&&"_self"!==c.target&&g.addRoute(c.href,d(c))})}function d(a){return{templateUrl:a.template_url,template:'<div ng-bind-html="page.content"></div>',controller:a.controller||"html5Page",resolve:{response:function(b,c){if(a.api){var d=b.api(a.api);return d.get(c.current.params)}}}}}function e(b){return function(c){if(angular.extend(c,l.csrf),"application/x-www-form-urlencoded"===b)return a.param(c);if("multipart/form-data"===b){var d=new FormData;return angular.forEach(c,function(a,b){d.append(b,a)}),d}return c}}function f(a,b,c){function d(b){angular.forEach(b,function(b,c){a.formMessages[c]=b})}c||(c={});var f=a.$parent?a.$parent.page:{};a.formModel=c.data||c,a.formClasses={},a.formErrors={},a.formMessages={},a.formModel.name&&(f.title="Update "+a.formModel.name),a.checkField=function(b){var c=a["check_"+b];if(c)c.call(a);else{var d=a.form[b];d.$valid?a.formClasses[b]="has-success":d.$dirty&&(a.formErrors[b]=b+" is not valid",a.formClasses[b]="has-error")}},a.showErrors=function(){var b=a.form.$error;angular.forEach(b.required,function(b){a.formClasses[b.$name]="has-error"})},a.processForm=function(c){c.preventDefault(),c.stopPropagation();var f,g,h=angular.element(c.target),i=h.attr("data-api"),j=h.attr("action");if(a.form.$invalid)return a.showErrors();if(!j&&i&&(g=b.api(i),g||b.log.error("Could not find api url for "+i)),a.formMessages={},j){var k=h.attr("enctype")||"",l=k.split(";")[0],m={url:j,method:h.attr("method")||"POST",data:a.formModel,transformRequest:e(l)};("application/x-www-form-urlencoded"===l||"multipart/form-data"===l)&&(m.headers={"content-type":void 0}),f=b.http(m)}else{if(!g)return void b.log.error("Could not process form. No target or api");f=g.put(a.formModel)}f.success(function(b,c){b.messages?angular.forEach(b.messages,function(b,c){a.formMessages[c]=b}):g?a.formMessages[r]=201===c?[{message:"Succesfully created"}]:[{message:"Succesfully updated"}]:window.location.href=b.redirect||"/"}).error(function(a,b){var c,e;a?(c=a.messages,c||(e=a.message,e||(b=b||a.status||501,e="Server error ("+a.status+")"),c={},c[r]=[{message:e,error:!0}])):(b=b||501,e="Server error ("+a.status+")",c={},c[r]=[{message:e,error:!0}]),d(c)})}}var g={},h={},i=window,j=[],k=[],l=a.extend(h,i.context),m=["ngSanitize","lux.controllers","lux.services"];l.html5mode&&m.push("ngRoute"),angular.element=a,g.$=a,g.context=l,g.services=angular.module("lux.services",[]),g.controllers=angular.module("lux.controllers",["lux.services"]),g.app=angular.module("lux",m),g.addRoute=function(a,b){j.push([a,b])},g.add_ready_callback=function(a){k===!0?a():k.push(a)},g.requiresAngular=function(){g.$.each(arguments,function(a,b){-1===g.app.requires.indexOf(b)&&g.app.requires.push(b)})};var n=g.ApiTypes={};if(!l.csrf){var o=a("meta[name=csrf-param]").attr("content"),p=a("meta[name=csrf-token]").attr("content");o&&p&&(l.csrf={},l.csrf[o]=p)}g.services.service("$lux",function(a,b,c,d,e){var f=this;this.location=a,this.log=d,this.http=c,this.q=b,this.anchorScroll=e,this.post=function(a,b,d){return l.csrf&&(b||(b={}),angular.extend(b,l.csrf)),c.post(a,b,d)},this.api=function(a){Object(a)!==a&&(a={name:a});var b=n[a.type||"lux"];return b||f.log.error('Api provider "'+a.type+'" is not available'),b.api(a.name,a.url,f)}});var q={apiUrls:l.apiUrls,api:function(a,c,d){return new b(a,c,this,d)},authentication:function(a){this.auth={},this.call(a)},addAuth:function(){},httpOptions:function(b){var c=b.options,d=c.url;return a.isFunction(d)&&(d=d()),d||(d=b.api.url),c.url=d,c},call:function(a){var b=this,c=a.api,d=c.lux;if(!c.url&&!c.name)return a.error("api should have url or name");if(!c.url){if(!this.apiUrls)return l.apiUrl?(d.log.info("Fetching api info"),d.http.get(l.apiUrl).success(function(c){b.apiUrls=c,b.call(a)}).error(a.error)):a.error("Api url not available");if(c.url=this.apiUrls[c.name]||this.apiUrls[c.name+"_url"],!c.url)return a.error("Could not find a valid url for "+c.name)}if(!b.auth)return b.authentication(a);b.addAuth(a);var e=b.httpOptions(a);d.http(e).success(a.success).error(a.error)}};g.createApi=function(a,b){return n[a]=angular.extend({},q,b),n[a]},g.createApi("lux",{authentication:function(a){var b=this;return l.user?($lux.log.info("Fetching authentication token"),$lux.post("/_token").success(function(c){b.auth={user_token:c.token},b.call(a)}).error(a.error),a.deferred.promise):(b.auth={},void b.call(a))},addAuth:function(a,b){if(this.user_token){var c=b.headers;c||(b.headers=c={}),c.Authorization="Bearer "+this.user_token}}}),g.createApi("static",{httpOptions:function(a){var b=a.options,c=a.api.url,d=a.urlparams.path;return d&&(c+="/"+d),".json"!==c.substring(c.length-5)&&(c+=".json"),b.url=c,b}}),g.controllers.controller("page",["$scope","$lux",function(b,c){c.log.info("Setting up angular page"),angular.extend(b,l);var d=b.page;b.page=d=d&&b.pages?b.pages[d]:{},b.windowHeight=function(){return i.window.innerHeight>0?i.window.innerHeight:i.screen.availHeight},b.search_text="",b.sidebarCollapse="",b.logout=function(a,b){a.preventDefault(),a.stopPropagation(),c.post(b).success(function(a){a.redirect&&window.location.replace(a.redirect)})},b.search=function(){b.search_text&&(window.location.href="/search?"+a.param({q:b.search_text}))},b.dismiss=function(a){c.post("/_dismiss_message",{message:a})},b.togglePage=function(a){a.preventDefault(),a.stopPropagation(),this.link.active=!this.link.active},b.loadPage=function(){b.page=this.link},b.collapse=function(){var a=i.window.innerWidth>0?i.window.innerWidth:i.screen.width;b.sidebarCollapse=a<l.navbarCollapseWidth?"collapse":""},b.collapse(),a(i).bind("resize",function(){b.collapse(),b.$apply()}),b.scrollToHash=function(b,d){var e=a(b.currentTarget.hash);e.length?(d=d?d:0,b.preventDefault(),b.stopPropagation(),c.log.info("Scrolling to target"),a("html,body").animate({scrollTop:e.offset().top+d},1e3)):c.log.warning("Cannot scroll, target not found")}}]),g.controllers.controller("html5Page",["$scope","$lux","response",function(a,b,c){var d=c.data;200===c.status&&(a.page=d,d.html_title&&(document.title=d.html_title))}]),c(l.hrefs,l.pages);var r="m__form";return g.app.directive("watchChange",function(){return{scope:{onchange:"&watchChange"},link:function(a,b){b.on("keyup",function(){a.$apply(function(){a.onchange()})}).on("change",function(){a.$apply(function(){a.onchange()})})}}}),g.controllers.controller("formController",["$scope","$lux","data",function(a,b,c){f(a,b,c)}]),g.controllers.controller("listgroup",["$scope","$lux","data",function(a,b,c){a.data=c.data}]),g.controllers.controller("userController",["$scope","$lux",function(b,c){f(b,c,l.user),b.unlink=function(b,c){b.preventDefault(),b.stopPropagation();var d="/oauth/"+c+"/remove";a.post(d).success(function(a){a.success&&$route.reload()})},b.check_password_repeat=function(){var a=this.formModel,b=this.form.password_repeat,c=a.password,d=a.password_repeat;c!==d&&b.$dirty?(this.formErrors.password_repeat="passwords don't match",b.$error.password_repeat=!0,this.formClasses.password_repeat="has-error"):b.$dirty&&(this.formClasses.password_repeat="has-success",delete this.form.$error.password_repeat)}}]),g.bootstrap=function(){function b(){angular.bootstrap(document,["lux"]),angular.forEach(k,function(a){a()}),k=!0}a(document).ready(function(){l.html5mode?require(["angular-route"],function(){if(j.length){var c=j;j=[],g.app.config(["$routeProvider","$locationProvider",function(b,d){angular.forEach(c,function(c){var d=c[0],e=c[1];a.isFunction(e)&&(e=e()),b.when(d,e)}),d.html5Mode(!0)}])}b()}):b()})},g});