define(["jquery","angular","angular-route","angular-sanitize"],function(a){"use strict";function b(a){angular.forEach(a,function(a){b(a.links),a.href&&"_self"!==a.target&&e.addRoute(a.href,{templateUrl:a.href+"/html"})})}function c(b){return function(c){if("application/x-www-form-urlencoded"===b)return a.param(options.data);if("multipart/form-data"===b){var d=new FormData;return angular.forEach(c,function(a,b){d.append(b,a)}),d}return c}}function d(a,b,d,e,f){f||(f={}),a.formModel=f,a.formClasses={},a.formErrors={},a.formMessages={},a.checkField=function(b){var c=a["check_"+b];if(c)c.call(a);else{var d=a.form[b];d.$valid?a.formClasses[b]="has-success":d.$dirty&&(a.formErrors[b]=b+" is not valid",a.formClasses[b]="has-error")}},a.showErrors=function(){var b=a.form.$error;angular.forEach(b.required,function(b){a.formClasses[b.$name]="has-error"})},a.processForm=function(b){b.preventDefault(),b.stopPropagation();var e=angular.element(b.target);if(a.form.$invalid)return a.showErrors();var f=e.attr("enctype")||"",g=f.split(";")[0],h={url:e.attr("action"),method:e.attr("method")||"POST",data:a.formModel,transformRequest:c(g)};("application/x-www-form-urlencoded"===g||"multipart/form-data"===g)&&(h.headers={"content-type":void 0}),a.formMessages={},d(h).success(function(b){b.messages?angular.forEach(b.messages,function(b,c){a.formMessages[c]=b}):window.location.href=b.redirect||"/"}).error(function(){})}}var e={},f={},g=window,h=[],i=[],j=angular.extend(f,g.context);e.$=a,e.context=j,e.services=angular.module("lux.services",[]),e.controllers=angular.module("lux.controllers",["lux.services"]),e.app=angular.module("lux",["ngRoute","ngSanitize","lux.controllers","lux.services"]),e.addRoute=function(a,b){h.push([a,b])},e.add_ready_callback=function(a){i===!0?a():i.push(a)},e.bootstrap=function(){angular.element(document).ready(function(){if(h.length&&j.html5mode){var a=h;h=[],e._setupRouter(a)}angular.bootstrap(document,["lux"]),angular.forEach(i,function(a){a()}),i=!0})},e._setupRouter=function(b){e.app.config(["$routeProvider","$locationProvider",function(c,d){angular.forEach(b,function(b){var d=b[0],e=b[1];a.isFunction(e)&&(e=e()),c.when(d,e)}),d.html5Mode(!0)}])},e.controllers.controller("page",["$scope","$http","$location",function(b,c){angular.extend(b,j),b.search_text="",b.page=j.page||{},b.sidebar_collapse="",b.logout=function(b,c){b.preventDefault(),b.stopPropagation(),a.post(c).success(function(a){a.redirect&&window.location.replace(a.redirect)})},b.search=function(){b.search_text&&(window.location.href="/search?"+a.param({q:b.search_text}))},b.dismiss=function(a){c.post("/_dismiss_message",a)},b.togglePage=function(a){a.preventDefault(),a.stopPropagation(),this.link.active=!this.link.active},b.loadPage=function(){b.page=this.link},b.collapse=function(){var a=g.window.innerWidth>0?g.window.innerWidth:g.screen.width;b.sidebar_collapse=a<j.collapse_width?"collapse":""},b.collapse(),a(g).bind("resize",function(){b.collapse(),b.$apply()})}]),b(j.sitemap);return e.app.directive("watchChange",function(){return{scope:{onchange:"&watchChange"},link:function(a,b){b.on("keyup",function(){a.$apply(function(){a.onchange()})}),b.on("change",function(){a.$apply(function(){a.onchange()})})}}}),e.controllers.controller("formController",["$scope","$location","$http","$sce",function(a,b,c,e){d(a,b,c,e)}]),e.controllers.controller("userController",["$scope","$location","$http","$sce",function(b,c,e,f){d(b,c,e,f,j.user),b.unlink=function(b,c){b.preventDefault(),b.stopPropagation();var d="/oauth/"+c+"/remove";a.post(d).success(function(a){a.success&&$route.reload()})},b.check_password_repeat=function(){var a=this.formModel,b=this.form.password_repeat,c=a.password,d=a.password_repeat;c!==d&&b.$dirty?(this.formErrors.password_repeat="passwords don't match",b.$error.password_repeat=!0,this.formClasses.password_repeat="has-error"):b.$dirty&&(this.formClasses.password_repeat="has-success",delete this.form.$error.password_repeat)}}]),e});