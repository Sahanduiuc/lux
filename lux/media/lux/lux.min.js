define(["lodash","jquery"],function(a,b){"use strict";function c(a,b,c,d){this.key=a,this.value=b,this.next=c,this.width=d}var d=window,e={},f=Array.prototype.slice;d.lux=e,e.showdown={},e.s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},e.guid=function(){var a=e.s4;return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},e.isnothing=function(a){return void 0===a||null===a},e.sorted=function(b,c){var d=[];a(b).forEch(function(a,b){d.push(b)}),d.sort(),a(d).forEach(function(a){c(b[a],a)})},e.event=function(){return b.Event()};{var g="cid",h="cidchange",i=/xyz/.test(function(){})?/\b_super\b/:/.*/,j=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&i.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},k=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var g in b)"Metaclass"!==g&&(f[g]=j.call(a,c,g,b[g],e));if(d){for(g in e)void 0===f[g]&&(f[g]=e[g]);return f}var h=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return h.prototype=f,h.prototype.constructor=h,h.extend=a.extend,h},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),l=function(a){return a.__class__=k,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),m=l.extend({bindToElement:function(a){this._jquery_element=a},trigger:function(b,c){c?(a.isArray(c)||(c=[c]),c.splice(0,0,this)):c=[this],this.jElem().trigger(b,c)},on:function(a,b){this.jElem().on(a,b,f.call(arguments,2))},jElem:function(){return this._jquery_element?this._jquery_element:b(window)}}),n=l.extend({name:"Exception",init:function(a){this.message=a||""},toString:function(){return this.name+": "+this.message}}),o=n.extend({name:"ModelException"}),p=n.extend({name:"NotImplementedError"}),q={pkname:"id",name:"model",defaults:{}},r=l.extend({init:function(b,c){this.model=b,a.extend(this,c),this.title=this.title||this.name},init_instance:function(b,c){b._fields={},b._changed={},c===Object(c)&&a(c).forEach(function(a,c){this.set_field(b,c,a)},this),b.pk()||(b._id=g+e.s4())},get:function(c,d){if(!this._backend)throw new o("Cannot sync "+this+". No backend registered.");d||(d={}),b.isArray(c)||(c=[c]);var e={},f=this;a(c).forEach(function(a){f._add_to_crud(e,"read",a,d)}),f._backend.send(e.read)},update:function(b){var c=this,d=[];return a(b).forEach(function(a){var b=c.liveStorage.getItem(a.id);b?(b.update(a.fields),b._changed={}):b=new c.model(a.fields),d.push(b)}),d},set_field:function(b,c,d){if(void 0!==d){if(this.fields){var e=this.fields[c];e&&(d=e.validate(b,d))}var f=b.get(c);if(!a.isEqual(d,f)){if(c===this.pkname){if(!d)return;var g=b.cid();b._fields[c]=d,delete b._id,g!==b.cid()&&b.trigger(h,[b,g])}else b._fields[c]=d;return void 0===f?null:f}}},toString:function(){return this.name}}),s=k.extend({new_class:function(b,c){var d={},e=b._meta;e&&e.fields&&(d.fields=a.extend({},e.fields)),e=a.merge(d,q,c.meta),delete c.meta,a(e.fields).forEach(function(a,b){a.name=b});var f=this._super(b,c);return f._meta=f.prototype._meta=new r(f,e),f}}),t=m.extend({Metaclass:s,init:function(a){this._meta.init_instance(this,a)},pk:function(){return this.get(this._meta.pkname)},cid:function(){return this._meta.name+"-"+(this.pk()||this._id)},isNew:function(){return this.pk()?!1:!0},isDeleted:function(){return this._deleted===!0},fields:function(){return this._fields},toJSON:function(b){var c={},d=this._fields,e=d;return b&&!this.isNew()&&(e=this._changed),a(e).forEach(function(a,b){a=d[b],c[b]=a instanceof Date?.001*a.getTime():a}),c},set:function(a,b){var c=this._meta.set_field(this,a,b);void 0!==c&&(this._changed[a]=c,this.trigger("change",[this,a]))},changedFields:function(a){return a?"string"==typeof a?this._changed[a]:this._changed:this._changed},hasChanged:function(){return a.size(this._changed)>0},previous:function(a){return this._changed[a]},get:function(a){return this._fields[a]},update:function(b){if(b===Object(b)){var c=this;a(b).forEach(function(a,b){c.set(b,a)})}},"delete":function(){this._deleted=!0},sync:function(a,b){if(b=this._sync_data(b)){b.model=this._meta.name;var c=b.success,d=this;return b.success=function(a){d._changed={},c&&c(a)},a.execute(b)}},toString:function(){return this.cid()},get_form:function(){},update_form:function(b){a(this.fields()).forEach(function(a,c){var d=b.find("[name="+c+"]");d.length&&e.set_value(d,a)})},set_form_fields:function(c){var d={},e=this;a(c).forEach(function(a){var c=d[a.name];void 0===c?d[a.name]=a.value:b.isArray(c)?c.push(a.value):d[a.name]=[c,a.value]}),a(this._fields).forEach(function(a,b){void 0===d[b]&&(delete e._fields[b],e.trigger("change",b))}),this.update(d)},_sync_data:function(a){a=Object(a);var b=this.pk();if(this.isDeleted()&&b)a.crud=z.delete,a.item={pk:b,cid:this.cid()};else if(b&&this.hasChanged())a.crud=z.update,a.item={fields:this.toJSON(!0),pk:b,cid:this.cid()};else{if(b)return;if(data=this.toJSON(),!data)return;a.crud=z.create,a.item={fields:data,cid:this.cid()}}return a}});e.Collection=l.extend({init:function(b,c){var d=this,e=[],f={},g=d.model=b||t.extend({});d.store=C(c),Object.defineProperty(d,"length",{get:function(){return e.length}}),a.extend(d,{at:function(a){var b=e[a];return b?f[b]:void 0},get:function(a){return f[a]},add:function(b,c){var h,i,j=[];return c=Object(c),a.isArray(b)||(b=[b]),a(b).forEach(function(a){a instanceof d.model||(a=new g(a)),i=a.cid(),h=f[i],h?c.merge&&(h.update(a.fields()),h.hasChanged()&&j.push(h)):(f[i]=a,e.push(i),j.push(a))}),j},set:function(b){a(b).forEach(function(a){var b=a.id(),c=f[b];c?c.update(a.fields()):(f[b]=a,e.push(b))})},clear:function(){e=[],f={}},forEach:function(a){for(var b=e.length,c=0;b>c&&a(f[e[c]],c)!==!1;c++);},each:function(a){d.forEach(a)}})},reset:function(a){this.clear(),this.set(a)},fetch:function(a){a=Object(a);var b=this;a.success||a.success||function(a){a=b.parse(a),b.reset(a)},a.meta=this.model._meta,b.store.execute(a)},sync:function(b){b=Object(b);var c,d,e=this,f={},g=b.success,h=b.error;this.forEach(function(a){var b=a._sync_data();b&&(c=f[d.crud],c||(c=f[d.crud]=[]),c.push(b.item))});var i=[],j=[];fire=function(){i.length===f.length&&(j.length?h&&h(e,i,j):g&&g(e))},a(f).forEach(function(a,b){e.store.execute({meta:e.model._meta,type:b,data:a,success:function(a){i.push(b);try{e.afterSync(b,a)}finally{fire()}},error:function(){i.push(b),j.push(b),fire()}})})},parse:function(a){return a},toString:function(){return this.model._meta.name+"["+this.length+"]"},afterSync:function(a){a===z.delete||a===z.create||a===z.update}})}e.View=l.extend({remove:function(){return this.elem.remove(),this}}),e.Type=k,e.Class=l,e.EventClass=m,e.Model=t,e.ModelType=s,e.Exception=n,e.ModelException=o,e.NotImplementedError=p;var u={debug:10,info:20,warning:30,error:40,critical:50},v="info",w=e.Logger=l.extend({init:function(b,c){var d=this,e={},f={level:v,formatter:function(a,b){return b+": "+a}};a(u).forEach(function(a,b){d[b]=function(a){d.log(a,b)}}),a.extend(d,{handlers:[],config:function(a){return a=Object(a),a.level&&u[a.level]&&(f.level=a.level),f},getConfig:function(){return f},log:function(a,b){var c=u[b]||0;if(c>u[f.level])for(var e,g=d.getHandlers(),h=0;h<g.length;h++)e=g[h],c>=e.nlevel&&e.log(a,b)},get:function(a){var b=e[a];return b||(b=new w({namespace:a},d),e[a]=b),b},getHandlers:function(){return!d.handlers.length&&c?c.getHandlers():d.handlers}}),d.config(b)},addHandler:function(b,c){c=c||new x,c.config(a.extend({},this.getConfig(),b)),this.handlers.push(c)}}),x=e.LogHandler=l.extend({config:function(b){a.extend(this,b),this.nlevel=u[this.level]||0},log:function(a,b){console.log(this.formatter(a,b))}}),y=(e.HtmlLogHandler=x.extend({init:function(a){this.elem=b(a),this.elem.addClass("lux-logger")},log:function(a,b){a=this.formatter(a,b),a='<pre class="'+b+'">'+a+"</pre>",this.elem.prepend(a)}}),new w);e.getLogger=function(b,c){var d=y;return b&&a.each(b.split("."),function(a){d=d.get(a)}),c&&d.config(c),d};var z={create:"create",read:"read",update:"update","delete":"delete"},A=(e.CrudMethod={create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},{}),B=e.register_store=function(a,b){A[a]=b},C=e.create_store=function(b,c){if(b instanceof D)return b;if(a.isString(b)){var d=b.search("://");if(d>-1){var e=b.substr(0,d),f=A[e];if(f)return new f(b,c,e)}}return new D(b,c,"dummy")},D=e.Backend=e.Class.extend({options:{dataType:"json"},init:function(b,c,d){this.type=d,this.url=b,this.options=a.merge({},this.options,c)},execute:function(a){a.success&&a.success([])},toString:function(){return this.type+" "+this.url}}),E=e.Backend.extend({init:function(a,b){this._super(a,b,"ajax")},execute:function(a){var c=this.url,d=(a.model,a.item);delete a.model,a.type=e.CrudMethod[a.crud]||a.type||"GET",d&&(delete a.item,d.pk&&(c=e.utils.urljoin(c,d.pk)),a.data=d.fields),b.ajax(c,a)}});B("http",E),B("https",E);var F=e.Backend.extend({options:{resource:null,reconnecting:1,hartbeat:5,maxDelay:3600,maxRetries:null,factor:2.718281828459045,jitters:0,jitter:.11962656472},init:function(a,b){var c=this;a=this.websocket_uri(a),this._super(a,b,"websocket"),this._retries=0,this._transport=null,this._opened=!1,this._pending_messages={},this._delay=this.options.reconnecting,this._queue=[],c.connect()},opened:function(){return this._opened},connect:function(){var a=this.options,b=this.url,c=this;a.resource&&(b+=a.resource),y.info("Connecting with "+c),this._transport=new WebSocket(b),this._transport.onopen=function(){c.onopen()},this._transport.onmessage=function(a){"message"===a.type&&c.onmessage(a)},this._transport.onclose=function(){c.onclose()}},onopen:function(){if(this._opened=!0,y.info(this+" opened."),this.options.onopen&&this.options.onopen.call(this),this._queue){var b=this._queue;this._queue=[],a(b).forEach(function(a){this._transport.send(a)},this)}},reconnect:function(){var a=this.options,b=this;return this._delay?(this._retries+=1,null!==a.maxRetries&&this._retries>a.maxRetries?void K.logger.info("Exiting websocket after "+this.retries+" retries."):(this._delay=Math.min(this._delay*a.factor,a.maxDelay),a.jitter&&(this._delay=e.math.normalvariate(this._delay,this._delay*a.jitter)),K.logger.info("Try to reconnect websocket in "+this._delay+" seconds"),this.trigger("reconnecting",this._delay),void(this._reconnect=e.eventloop.call_later(this._delay,function(){b._reconnect=null,b.connect()})))):void K.logger.info("Exiting websocket")},execute:function(a){if(!a.beforeSend||a.beforeSend.call(a,this)!==!1){a.item&&(a.data=[a.item]);var b={mid:this.new_mid(a),action:a.action||e.CrudMethod[a.crud]||a.crud,model:a.model,data:a.data};b=JSON.stringify(b),this._opened?this._transport.send(b):this._queue.push(b)}},onmessage:function(a){var b=JSON.parse(a.data),c=b.mid,d=c?this._pending_messages[c]:void 0,e=b.data;d&&(delete this._pending_messages[c],d.item&&(e=e[0])),b.error?d&&d.error?d.error(b.error,this,b):y.error(this.toString()+" - "+b.error):d&&d.success?d.success(e,this,b):y.warning(this.toString()+" - Got message with no callback registered")},onclose:function(){this._opened=!1,y.warning(this+" closed."),this.reconnect()},new_mid:function(a){if(a.success||a.error){for(var b=e.s4();this._pending_messages[b];)b=e.s4();return this._pending_messages[b]=a,b}},websocket_uri:function(a){var b=window.location;if(a||(a=b.href.split("?")[0]),"http://"===a.substring(0,7))return"ws://"+a.substring(7);if("https://"===a.substring(0,8))return"wss://"+a.substring(8);if("ws://"===a.substring(0,5)||"wss://"===a.substring(0,6))return a;var c="http:"===b.protocol?"ws:":"wss:";return e.utils.urljoin(c,b.host,b.pathname,a)}});B("ws",F),B("wss",F);var G="ABCDEFGHIJKLMNOPQRSTUVWXYZ";e.num_to_letter=function(a){for(var b=G.length,c="";a>=b;){var d=a%b;a=Math.floor(a/b),c+=G[d]}return c+=G[a]},e.Ordered=l.extend({init:function(){this.all={},this.order=[]},set:function(a,b){this.all[a]?this.all[a]=b:a&&(this.order.push(a),this.all[a]=b)},get:function(a){return this.all[a]},at:function(a){return a<this.order.length?this.all[this.order[a]]:void 0},size:function(){return this.order.length},each:function(b,c){a(this.order).forEach(function(a,d){b.call(c,this.all[a],a,d)},this)},ordered:function(){var b=[];return a(this.order).forEach(function(a){b.push(this.all[a])},this),b}});var H=32,I=e.SkipList=function(b,d){b=Math.min(H,Math.max(8,b?b:H));var e,f=function(a){for(var c=[],d=b;d--;)c.push(a);return c},g=Math.log(2),h=0,i=new c("HEAD",null,new Array(b),f(1)),j=1;Object.defineProperty(this,"length",{get:function(){return h}}),Object.defineProperty(this,"levels",{get:function(){return levels}}),a.extend(this,{insert:function(a,k){var l,m,n=new Array(b),o=f(0),p=i;for(e=j-1;e>=0;e--){for(o[e]=e===j-1?0:o[e+1];p.next[e]&&p.next[e].key<=a;)o[e]+=p.width[e],p=p.next[e];n[e]=p}if(n[0].key===a&&d)return h;var q=Math.min(b,1-Math.round(Math.log(Math.random())/g));if(q>j){for(e=j;q>e;e++)o[e]=0,n[e]=i,n[e].width[e]=h;j=q}for(p=new c(a,k,new Array(b),new Array(b)),e=0;q>e;e++)l=n[e],m=o[0]-o[e],p.next[e]=l.next[e],p.width[e]=l.width[e]-m,l.next[e]=p,l.width[e]=m+1;for(e=q;j>e;e++)n[e].width[e]+=1;return h+=1},forEach:function(a){for(var b=i.next[0];b;)a(b.value,b.score),b=b.next[0]}})},J=[],K=e.web={options:{debug:!1,skins:[],media_url:"/media/",icon:"fontawesome"},extension_list:[],extensions:{},libraries:[],extension:function(a,b){return b=this.create_extension(a,b),this.extension_list.push(b),this.extensions[a]=b,b},ready:function(a,b){e.$&&(void 0===b?a():require(a,b))},refresh:function(b){return a(this.extension_list).forEach(function(a){a.refresh(b)}),b},add_lib:function(b){a.contains(this.libraries,b.name)||this.libraries.push(b)}};e.init_web=function(){e.$=b,b(document).ready(function(){var c=b(this),d=c.find("html").data()||{};K.options=a.extend(K.options,d),K.options.debug&&(y.config({level:"debug"}),y.handlers.length||y.addHandler()),K.element=c;var e=J;J=[],a(e).forEach(function(a){K.extension(a.name,a.ext)}),K.refresh(c)})},e.set_value_hooks=[],e.set_value=function(a,b){for(var c=0;c<e.set_value_hooks.length;c++)if(e.set_value_hooks[c](a,b))return;a.val(b)},K.ExtInstance=e.Class.extend({selector:null,defaultElement:null,options:{fade:{duration:200}},init:function(b,c,d){this._id=b,this._element=c,this.options=a.merge({},this.options,d)},toString:function(){return this._id},element:function(){return this._element},container:function(){return this._element},id:function(){return this._id},lux_id:function(){return this._id},extension:function(){return this.constructor},destroy:function(){return this.constructor.destroy(this)},decorate:function(){},fadeIn:function(a){var b=this;b._element.fadeIn({duration:this.options.fade.duration,complete:function(){a&&a(b),b._element.trigger("show",b)}})},fadeOut:function(a){var b=this;b._element.fadeOut({duration:this.options.fade.duration,complete:function(){a&&a(b),b._element.trigger("hide",b)}})},get_skin:function(a){return K.get_skin(a?a:this.element())}}),K.create_extension=function(c,d,e){var f=[],g=c+"-",h="lux-"+c+"-id",i=0,j=function(){return i+=1,g+i};e=e?e:K.ExtInstance,d.options=a.merge({},e.prototype.options,d.options),d.name=c;var k=e.extend(d);return k.instance=function(a){if(a){a=a.lux_id?a.lux_id():a;var d,e=f[a];return e||(d=b(a),d.length||"string"!=typeof a||(d=b("#"+a)),e=d.length?f[d.closest("."+c).data(h)]||null:null),e}return null},k.create=function(e,g){var h=this.instance(e);if(null!==h)return h;if(e=b(e),0===e.length)e=b(document.createElement(d.defaultElement));else{var i=e.data(c)||e.data();g=g?a.extend(g,i):i}j();return h=new k(j(),e,g),f[h.id()]=h,h.decorate(),h},k.destroy=function(a){if(a=this.instance(a)){delete f[a.id()];var b=a.container();b&&(b.trigger("remove",a),b.detach().trigger("removed",a),b.remove())}},k.toString=function(){return c},k.refresh=function(a){var d=[];if(k.prototype.selector){var e=b(k.prototype.selector,a);e.length&&(y.info("Apply extension "+c+" to "+e.length+" elements"),e.each(function(){d.push(k.create(this))}))}return d},k.prototype.defaultElement&&(K[k.prototype.name]=function(a,c){var d=a;return(!a||b.isPlainObject(a))&&(d=null,c=a),k.create(d,c)}),k},K.add_lib({name:"RequireJs",web:"http://requirejs.org/",version:require.version}),K.add_lib({name:"Lo-Dash",web:"http://lodash.com/",version:a.VERSION}),K.add_lib({name:"jQuery",web:"http://jquery.com/",version:b.fn.jquery});var L=n.extend({name:"StopIteration"}),M=l.extend({init:function(a,b,c){this.deadline=a,this.cancelled=!1,this.callback=b,this.args=c},cancel:function(){this.cancelled=!0},reschedule:function(a){this._deadline=a,this._cancelled=!1}}),N=l.extend({init:function(b,c,d,e){var f,g=this,h=!1;this.callback=c,this.args=d;var i=function(){try{this.callback.call(this,g.args)}catch(a){return void g.cancel()}j()},j=function(){h||(e?(f.reschedule(b.time()+e),b.scheduled.insert(f.deadline,f)):b.callbacks.append(f))};e&&e>0?(e=e,f=b.call_later(e,i)):(e=null,f=b.call_soon(i)),a.extend(this,{get cancelled(){return h},cancel:function(){h=!0}})}}),O=e.EventLoop=l.extend({init:function(){var b=[],c=new I,d=!1,e=window.requestAnimationFrame,g=function(){var c=(this.time(),b.splice(0));a(c).forEach(function(a){a.cancelled||a.callback(a.args.splice(0))})},h=function(a){if(d){try{g(a)}catch(b){if("StopIteration"===b.name)return void(d=!1)}d&&e(h)}};a.extend(this,{get callbacks(){return b},get scheduled(){return c},call_soon:function(a){var c=new M(null,a,f(arguments,1));return b.append(c),c},call_later:function(a,b){var d=f.call(arguments,2),e=new M(this.time()+a,b,d);return c.insert(e.deadline,e),e},call_at:function(a,b){var d=f.call(arguments,2),e=new M(a,b,d);return c.insert(e.deadline,e),e},run:function(){d||(d=!0,e(h))},is_running:function(){return d}})},call_every:function(a){return new N(this,a,f(arguments,1))},time:function(){return(new Date).getTime()},stop:function(a){this.is_running()?this.call_soon(function(){if(a)try{a()}catch(b){console.log(b)}throw new L}):a&&a()}});e.eventloop=new O;e.each;e.utils={detector:{canvas:!!window.CanvasRenderingContext2D,workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob},allClasses:function(a){var c={},d=[];return b(a).each(function(){this.className&&b.each(this.className.split(" "),function(){var a=this;""!==a&&void 0===c[a]&&(c[a]=a,d.push(a))})}),d},as_tag:function(a,c){var d=b(c);return d.length||"string"!=typeof c?d.length?(d.is(a)||(d=b("<"+a+">").append(d)),d):void 0:b("<"+a+">").html(c)},closest_color:function(a,c){var d=null;for(a=b(a);a.length&&null===d;)a=a.parent(),d=a.css(c),("inherit"==d||"transparent"==d)&&(d=null);return d},urljoin:function(){var a=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},b=[].slice.call(arguments,0).join("/");return a(b)},prettyTime:function(a){var b=Math.floor(a/86400);return 0===b&&(2>a&&"1 second ago"||60>a&&Math.floor(a)+" seconds ago"||120>a&&"1 minute ago"||3600>a&&Math.floor(a/60)+" minutes ago"||7200>a&&"1 hour ago"||86400>a&&Math.floor(a/3600)+" hours ago")||1===b&&"Yesterday"||7>b&&b+" days ago"||31>b&&Math.ceil(b/7)+" weeks ago"},asDate:function(a){if(a instanceof Date)return a;var b=parseFloat(a);if(b===b)return new Date(1e3*b);throw new TypeError("Could not convert "+a+" to a date")}};var P={},Q=Math.PI;e.math=P,b.extend(P,{point2d:function(a,b){return{x:a,y:b}},distance2d:function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))},angle2d:function(a,b,c,d,e,f){var g=a-c,h=b-d,i=e-c,j=f-d,k=Math.atan2(g,h),l=Math.atan2(i,j);return k-l},degree:function(a){return 180*a/Q},radians:function(a){return Q*a/180}});var R=Math.random,S=Math.log,T=4*Math.exp(-.5)/Math.sqrt(2);return b.extend(P,{normalvariate:function(a,b){for(var c,d,e,f;;)if(c=R(),d=1-R(),e=T*(c-.5)/d,f=e*e/4,f<=-S(d))break;return a+e*b}}),e});