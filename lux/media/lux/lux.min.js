define(["lodash","jquery"],function(){"use strict";function a(a,b,c,d){this.key=a,this.value=b,this.next=c,this.width=d}var b=window,c={};b.lux=c;var d=Array.prototype,e=d.slice;c.showdown={},c.s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},c.guid=function(){var a=c.s4;return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},c.isnothing=function(a){return void 0===a||null===a},c.sorted=function(a,b){var c=[];_(a).forEch(function(a,b){c.push(b)}),c.sort(),_(c).forEach(function(c){b(a[c],c)})};var f=/xyz/.test(function(){})?/\b_super\b/:/.*/,g=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&f.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},h=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var h in b)"Metaclass"!==h&&(f[h]=g.call(a,c,h,b[h],e));if(d){for(h in e)void 0===f[h]&&(f[h]=e[h]);return f}var i=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return i.prototype=f,i.prototype.constructor=i,i.extend=a.extend,i},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),i=function(a){return a.__class__=h,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),j=i.extend({bindToElement:function(a){this._jquery_element=a},trigger:function(a){this.jElem().trigger(a,this,e.call(arguments,1))},on:function(a,b){this.jElem().on(a,b,e.call(arguments,2))},jElem:function(){return this._jquery_element?this._jquery_element:$(window)}}),k=i.extend({data:{},init:function(a){this.prefix=a},decode:function(a){return a},encode:function(a){return a},setItem:function(a,b){this.data[this.prefix+a]=this.encode(b)},getItem:function(a){return this.decode(this.data[this.prefix+a])},removeItem:function(a){delete this.data[this.prefix+a]},keys:function(){var a=[],b=this.prefix,c=this.prefix.length;for(var d in this.data)d.substring(0,c)===b&&a.push(d.substring(c));return a},all:function(){var a=this,b=[];return _(this.keys()).forEach(function(c){b.push(a.getItem(c))}),b},clear:function(){var a=this;_(this.keys()).forEach(function(b){a.removeItem(b)})}}),l=i.extend({name:"Exception",init:function(a){this.message=a||""},toString:function(){return this.name+": "+this.message}}),m=l.extend({name:"ModelException"}),n=l.extend({name:"NotImplementedError"}),o={pkname:"id",name:"model",LiveStorage:k,defaults:{}},p=i.extend({_newprefix:"new-",init:function(a,b){var c=b.LiveStorage;delete b.LiveStorage,this.model=a,_.extend(this,b),this.title=this.title||this.name,this.liveStorage=new c(this.name+"."),this._backend=null},init_instance:function(a,b){if(a._fields={},a._changed={},b===Object(b)&&_(b).forEach(function(b,c){this.set_field(a,c,b)},this),void 0===a.pk())for(var d=!0;d;)a._id=this._newprefix+c.s4(),d=this.liveStorage.getItem(a.id());this.liveStorage.setItem(a.id(),a)},live:function(a){return a?this.liveStorage.getItem(a):this.liveStorage.all()},clear:function(){this.liveStorage.clear()},get:function(a,b){if(!this._backend)throw new m("Cannot sync "+this+". No backend registered.");b||(b={}),$.isArray(a)||(a=[a]);var c={},d=this;_(a).forEach(function(a){d._add_to_crud(c,"read",a,b)}),d._backend.send(c.read)},update:function(a){var b=this,c=[];return _(a).forEach(function(a){var d=b.liveStorage.getItem(a.id);d?(d.update(a.fields),d._changed={}):d=new b.model(a.fields),c.push(d)}),c},set_field:function(a,b,c){if(void 0!==c){if(this.fields){var d=this.fields[b];d&&(c=d.validate(a,c))}var e=a.get(b);if(c!==e){if(b===this.pkname){if(!c)return;this.liveStorage.removeItem(a.id()),a._fields[b]=c,delete a._id,this.liveStorage.setItem(a.id(),a)}else a._fields[b]=c;return void 0===e?null:e}}},sync:function(a,b){var c=this;if(c instanceof r?(c=this._meta,b=[this]):b||(b=this.liveStorage.all()),!c._backend)throw new m("Cannot sync "+c+". No backend registered.");a=a||{};var d={};_(b).forEach(function(b){if(b._meta!==c)throw new TypeError("Got an invalid model "+b+" in sync");b.isNew()?c._add_to_crud(d,"create",b.backend_data(),a):b.isDeleted()?c._add_to_crud(d,"destroy",b.pk(),a):b.hasChanged()?c._add_to_crud(d,"update",b.backend_data(),a):c._add_to_crud(d,"read",b.pk(),a)}),_(d).forEach(function(a){c._backend.send(a)})},set_transport:function(a){this._backend=a},toString:function(){return this.name},_add_to_crud:function(a,b,c,d){var f=a[b];if(!f){f=_.extend({},d);var g=f.success,h=this;f.type=b,f.data=[],f.model=h.name,f.success=function(a){a=h.update(a),g&&g.call(this,a,e.call(arguments,1))},a[b]=f}f.data.push(c)}}),q=h.extend({new_class:function(a,b){var c={},d=a._meta;d&&d.fields&&(c.fields=d.fields),d=_.merge(c,o,b.meta),delete b.meta,_(d.fields).forEach(function(a,b){a.name=b});var e=this._super(a,b);return e._meta=e.prototype._meta=new p(e,d),e}}),r=j.extend({Metaclass:q,init:function(a){this._meta.init_instance(this,a)},pk:function(){return this.get(this._meta.pkname)},id:function(){return this.pk()||this._id},isNew:function(){return this.pk()?!1:!0},isDeleted:function(){return this._deleted===!0},fields:function(){return this._fields},backend_data:function(){var a={};return _(this._fields).forEach(function(b,c){a[c]=b instanceof Date?.001*b.getTime():b}),{id:this.id(),fields:a}},set:function(a,b){var c=this._meta.set_field(this,a,b);void 0!==c&&(this._changed[a]=c,this.trigger("change",this,a))},changedFields:function(a){return a?"string"==typeof a?this._changed[a]:this._changed:this._changed},hasChanged:function(){return _.size(this._changed)>0},get:function(a){return this._fields[a]},update:function(a){if(a===Object(a)){var b=this;_(a).forEach(function(a,c){b.set(c,a)})}},sync:function(a){return this._meta.sync.call(this,a)},destroy:function(a){this._deleted=!0,this.isNew()?(this._meta.liveStorage.removeItem(this.id()),a&&a.success&&a.success(this)):a&&a.wait||this.sync(a)},toString:function(){return this._meta.name+"."+this.id()},get_form:function(){},update_form:function(a){_(this.fields()).forEach(function(b,d){var e=a.find("[name="+d+"]");e.length&&c.set_value(e,b)})},set_form_fields:function(a){var b={},c=this;_(a).forEach(function(a){var c=b[a.name];void 0===c?b[a.name]=a.value:$.isArray(c)?c.push(a.value):b[a.name]=[c,a.value]}),_(this._meta.fields).forEach(function(a){var d=a.validate(c,b[a.name]);void 0!==d?b[a.name]=d:delete b[a.name]}),this._fields=b,this.trigger("change",this)}});c.View=i.extend({remove:function(){return this.elem.remove(),this}}),c.Type=h,c.Class=i,c.EventClass=j,c.Model=r,c.ModelType=q,c.Exception=l,c.ModelException=m,c.NotImplementedError=n,c.Ordered=i.extend({init:function(){this.all={},this.order=[]},set:function(a,b){this.all[a]?this.all[a]=b:a&&(this.order.push(a),this.all[a]=b)},get:function(a){return this.all[a]},at:function(a){return a<this.order.length?this.all[this.order[a]]:void 0},size:function(){return this.order.length},each:function(a,b){_(this.order).forEach(function(c,d){a.call(b,this.all[c],c,d)},this)},ordered:function(){var a=[];return _(this.order).forEach(function(b){a.push(this.all[b])},this),a}});var s=32,t=c.SkipList=function(b,c){b=Math.min(s,Math.max(8,b?b:s));var d,e=function(a){for(var c=[],d=b;d--;)c.push(a);return c},f=Math.log(2),g=0,h=new a("HEAD",null,new Array(b),e(1)),i=1;Object.defineProperty(this,"length",{get:function(){return g}}),Object.defineProperty(this,"levels",{get:function(){return levels}}),_.extend(this,{insert:function(j,k){var l,m,n=new Array(b),o=e(0),p=h;for(d=i-1;d>=0;d--){for(o[d]=d===i-1?0:o[d+1];p.next[d]&&p.next[d].key<=j;)o[d]+=p.width[d],p=p.next[d];n[d]=p}if(n[0].key===j&&c)return g;var q=Math.min(b,1-Math.round(Math.log(Math.random())/f));if(q>i){for(d=i;q>d;d++)o[d]=0,n[d]=h,n[d].width[d]=g;i=q}for(p=new a(j,k,new Array(b),new Array(b)),d=0;q>d;d++)l=n[d],m=o[0]-o[d],p.next[d]=l.next[d],p.width[d]=l.width[d]-m,l.next[d]=p,l.width[d]=m+1;for(d=q;i>d;d++)n[d].width[d]+=1;return g+=1},forEach:function(a){for(var b=h.next[0];b;)a(b.value,b.score),b=b.next[0]}})},u=[],v=c.web={options:{debug:!1,skins:[],media_url:"/media/",icon:"fontawesome"},extension_list:[],extensions:{},libraries:[],extension:function(a,b){return c.$?(b=this.create_extension(a,b),this.extension_list.push(b),this.extensions[a]=b,b):void u.push({name:a,ext:b})},ready:function(a,b){c.$&&(void 0===b?a():require(a,b))},refresh:function(a){return _(this.extension_list).forEach(function(b){b.refresh(a)}),a},add_lib:function(a){_.contains(this.libraries,a.name)||this.libraries.push(a)}};c.init_web=function(){c.$=$,$(document).ready(function(){var a=$(this),b=a.find("html").data()||{};v.options=_.extend(v.options,b),v.options.debug&&(v.logger.level="debug"),v.element=a;var c=u;u=[],_(c).forEach(function(a){v.extension(a.name,a.ext)}),v.refresh(a)})},c.set_value_hooks=[],c.set_value=function(a,b){for(var d=0;d<c.set_value_hooks.length;d++)if(c.set_value_hooks[d](a,b))return;a.val(b)},v.ExtInstance=c.Class.extend({selector:null,defaultElement:null,options:{fade:{duration:200}},init:function(a,b,c){this._id=a,this._element=b,this.options=$.extend(!0,{},this.options,c||{})},toString:function(){return this._id},element:function(){return this._element},container:function(){return this._element},id:function(){return this._id},lux_id:function(){return this._id},extension:function(){return this.constructor},destroy:function(){return this.constructor.destroy(this)},decorate:function(){},fadeIn:function(a){var b=this;b._element.fadeIn({duration:this.options.fade.duration,complete:function(){a&&a(b),b._element.trigger("show",b)}})},fadeOut:function(a){var b=this;b._element.fadeOut({duration:this.options.fade.duration,complete:function(){a&&a(b),b._element.trigger("hide",b)}})},get_skin:function(a){return v.get_skin(a?a:this.element())}}),v.create_extension=function(a,b,c){var d=[],e=a+"-",f="lux-"+a+"-id",g=0,h=function(){return g+=1,e+g};c=c?c:v.ExtInstance,b.options=$.extend(!0,{},c.prototype.options,b.options||{}),b.name=a;var i=c.extend(b);return i.instance=function(b){if(b){b=b.lux_id?b.lux_id():b;var c,e=d[b];return e||(c=$(b),c.length||"string"!=typeof b||(c=$("#"+b)),e=c.length?d[c.closest("."+a).data(f)]||null:null),e}return null},i.create=function(c,e){var f=this.instance(c);if(null!==f)return f;if(c=$(c),0===c.length)c=$(document.createElement(b.defaultElement));else{var g=c.data(a)||c.data();e=e?$.extend(g,e):g}h();return f=new i(h(),c,e),d[f.id()]=f,f.decorate(),f},i.destroy=function(a){if(a=this.instance(a)){delete d[a.id()];var b=a.container();b&&(b.trigger("remove",a),b.detach().trigger("removed",a),b.remove())}},i.toString=function(){return a},i.refresh=function(b){var c=[];if(i.prototype.selector){var d=$(i.prototype.selector,b);d.length&&(v.logger.info("Apply extension "+a+" to "+d.length+" elements"),d.each(function(){c.push(i.create(this))}))}return c},i.prototype.defaultElement&&(v[i.prototype.name]=function(a,b){var c=a;return(!a||$.isPlainObject(a))&&(c=null,b=a),i.create(c,b)}),i},v.add_lib({name:"RequireJs",web:"http://requirejs.org/",version:require.version}),v.add_lib({name:"Lo-Dash",web:"http://lodash.com/",version:_.VERSION}),v.add_lib({name:"jQuery",web:"http://jquery.com/",version:$.fn.jquery});var w=l.extend({name:"StopIteration"}),x=i.extend({init:function(a,b,c){this.deadline=a,this.cancelled=!1,this.callback=b,this.args=c},cancel:function(){this.cancelled=!0},reschedule:function(a){this._deadline=a,this._cancelled=!1}}),y=i.extend({init:function(a,b,c,d){var e,f=this,g=!1;this.callback=b,this.args=c;var h=function(){try{this.callback.call(this,f.args)}catch(a){return void f.cancel()}i()},i=function(){g||(d?(e.reschedule(a.time()+d),a.scheduled.insert(e.deadline,e)):a.callbacks.append(e))};d&&d>0?(d=d,e=a.call_later(d,h)):(d=null,e=a.call_soon(h)),_.extend(this,{get cancelled(){return g},cancel:function(){g=!0}})}}),z=c.EventLoop=i.extend({init:function(){var a=[],b=new t,c=!1,d=window.requestAnimationFrame,f=function(){var b=(this.time(),a.splice(0));_(b).forEach(function(a){a.cancelled||a.callback(a.args.splice(0))})},g=function(a){if(c){try{f(a)}catch(b){if("StopIteration"===b.name)return void(c=!1)}c&&d(g)}};_.extend(this,{get callbacks(){return a},get scheduled(){return b},call_soon:function(b){var c=new x(null,b,e(arguments,1));return a.append(c),c},call_later:function(a,c){var d=e.call(arguments,2),f=new x(this.time()+a,c,d);return b.insert(f.deadline,f),f},call_at:function(a,c){var d=e.call(arguments,2),f=new x(a,c,d);return b.insert(f.deadline,f),f},run:function(){c||(c=!0,d(g))},is_running:function(){return c}})},call_every:function(a){return new y(this,a,e(arguments,1))},time:function(){return(new Date).getTime()},stop:function(a){this.is_running()?this.call_soon(function(){if(a)try{a()}catch(b){console.log(b)}throw new w}):a&&a()}});c.eventloop=new z;c.CrudMethod={create:"POST",read:"GET",update:"PUT",destroy:"DELETE"};c.Backend=c.EventClass.extend({options:{submit:{dataType:"json"}},init:function(a,b,c){this.type=c,this.url=a,this.options=_.merge({},this.options,b),this.submit=this.options.submit||{}},send:function(){},submit_options:function(a){if(a!==Object(a))throw new TypeError("Send method requires an object as input");return _.extend({},this.submit,a)},toString:function(){return this.type+" "+this.url}});c.each;c.utils={detector:{canvas:!!window.CanvasRenderingContext2D,workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob},allClasses:function(a){var b={},c=[];return $(a).each(function(){this.className&&$.each(this.className.split(" "),function(){var a=this;""!==a&&void 0===b[a]&&(b[a]=a,c.push(a))})}),c},as_tag:function(a,b){var c=$(b);return c.length||"string"!=typeof b?c.length?(c.is(a)||(c=$("<"+a+">").append(c)),c):void 0:$("<"+a+">").html(b)},closest_color:function(a,b){var c=null;for(a=$(a);a.length&&null===c;)a=a.parent(),c=a.css(b),("inherit"==c||"transparent"==c)&&(c=null);return c},urljoin:function(){var a=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},b=[].slice.call(arguments,0).join("/");return a(b)},prettyTime:function(a){var b=Math.floor(a/86400);return 0===b&&(2>a&&"1 second ago"||60>a&&Math.floor(a)+" seconds ago"||120>a&&"1 minute ago"||3600>a&&Math.floor(a/60)+" minutes ago"||7200>a&&"1 hour ago"||86400>a&&Math.floor(a/3600)+" hours ago")||1===b&&"Yesterday"||7>b&&b+" days ago"||31>b&&Math.ceil(b/7)+" weeks ago"},asDate:function(a){if(a instanceof Date)return a;var b=parseFloat(a);if(b===b)return new Date(1e3*b);throw new TypeError("Could not convert "+a+" to a date")}},c.utils.Logger=function(a){function b(a,b){return b+": "+a}function c(){}function d(a,b){for(var c=0;c<f.length;++c)f[c].log(b,a)}function e(a){a=a||{};var d=a.level,e=a.formatter||b,f=a.log||c,i=function(){return h[d?d:g.level]},j=function(a,b){var c;return b=b?b:"info",b=b.toLowerCase(),c=h[b],void 0!==c&&c>=i()?{msg:e(a,b),level:b}:void 0};return d&&(d=d.toLowerCase(),h[d]||(d=null)),{level:function(){return d?d:g.level},format:j,log:function(a,b){var c=j(a,b);c&&f(c)}}}var f=[],g=this,h={debug:10,info:20,warning:30,error:40};return g.level=a&&h[a]?a:"info",$.each(h,function(a){g[a]=function(b){d(a,b)}}),$.extend(g,{handlers:f,addHandler:function(a){void 0!==a&&void 0!==a.log&&f.push(a)},log:function(a,b){d(b,a)},addConsole:function(a){if(void 0!==console&&void 0!==console.log){a=a||{},a.log=function(a){console.log(a.msg)};var b=e(a);return g.addHandler(b),b}},addElement:function(a,b){if(a=$(a),a.length){a.addClass("lux-logger"),b=$.extend({log:function(b){var c='<pre class="'+b.level+'">'+b.msg+"</pre>";a.prepend(c)}},b);var c=e(b);return c.htmlElement=a,g.addHandler(c),c}}})};var A={},B=Math.PI;c.math=A,$.extend(A,{point2d:function(a,b){return{x:a,y:b}},distance2d:function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))},angle2d:function(a,b,c,d,e,f){var g=a-c,h=b-d,i=e-c,j=f-d,k=Math.atan2(g,h),l=Math.atan2(i,j);return k-l},degree:function(a){return 180*a/B},radians:function(a){return B*a/180}});var C=Math.random,D=Math.log,E=4*Math.exp(-.5)/Math.sqrt(2);$.extend(A,{normalvariate:function(a,b){for(var c,d,e,f;;)if(c=C(),d=1-C(),e=E*(c-.5)/d,f=e*e/4,f<=-D(d))break;return a+e*b}})});