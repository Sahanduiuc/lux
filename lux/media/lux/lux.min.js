define(["jquery","angular","angular-sanitize"],function(a){"use strict";function b(a,b){angular.forEach(a,function(a){var d=b[a];d&&d.href&&"_self"!==d.target&&f.addRoute(d.href,c(d))})}function c(a){return{templateUrl:a.template_url,template:'<div ng-bind-html="page.content"></div>',controller:a.controller||"html5Page",resolve:{response:function(b,c){if(a.api){var d=b.api(a.api);return d.get(c.current.params)}}}}}function d(b){return function(c){if(angular.extend(c,k.csrf),"application/x-www-form-urlencoded"===b)return a.param(c);if("multipart/form-data"===b){var d=new FormData;return angular.forEach(c,function(a,b){d.append(b,a)}),d}return c}}function e(a,b,c){function e(b){angular.forEach(b,function(b,c){a.formMessages[c]=b})}c||(c={});var f=a.$parent?a.$parent.page:{};a.formModel=c.data||c,a.formClasses={},a.formErrors={},a.formMessages={},a.formModel.name&&(f.title="Update "+a.formModel.name),a.checkField=function(b){var c=a["check_"+b];if(c)c.call(a);else{var d=a.form[b];d.$valid?a.formClasses[b]="has-success":d.$dirty&&(a.formErrors[b]=b+" is not valid",a.formClasses[b]="has-error")}},a.showErrors=function(){var b=a.form.$error;angular.forEach(b.required,function(b){a.formClasses[b.$name]="has-error"})},a.processForm=function(c){c.preventDefault(),c.stopPropagation();var f,g,h=angular.element(c.target),i=h.attr("data-api"),j=h.attr("action");if(a.form.$invalid)return a.showErrors();if(!j&&i&&(g=b.api(i),g||b.log.error("Could not find api url for "+i)),a.formMessages={},j){var k=h.attr("enctype")||"",l=k.split(";")[0],m={url:j,method:h.attr("method")||"POST",data:a.formModel,transformRequest:d(l)};("application/x-www-form-urlencoded"===l||"multipart/form-data"===l)&&(m.headers={"content-type":void 0}),f=b.http(m)}else{if(!g)return void b.log.error("Could not process form. No target or api");f=g.put(a.formModel)}f.success(function(b,c){b.messages?angular.forEach(b.messages,function(b,c){a.formMessages[c]=b}):g?a.formMessages[u]=201===c?[{message:"Succesfully created"}]:[{message:"Succesfully updated"}]:window.location.href=b.redirect||"/"}).error(function(a,b){var c,d;a?(c=a.messages,c||(d=a.message,d||(b=b||a.status||501,d="Server error ("+a.status+")"),c={},c[u]=[{message:d,error:!0}])):(b=b||501,d="Server error ("+a.status+")",c={},c[u]=[{message:d,error:!0}]),e(c)})}}var f={},g={ngModules:[],ngDirectives:[],ngControllers:[]},h=window,i=[],j=[],k=a.extend(g,h.context);k.html5mode&&k.ngModules.push("ngRoute"),angular.element=a,f.$=a,f.context=k,f.services=angular.module("lux.services",[]),f.controllers=angular.module("lux.controllers",["lux.services"]),f.app=angular.module("lux",[]),f.addRoute=function(a,b){i.push([a,b])},f.add_ready_callback=function(a){j===!0?a():j.push(a)},a.each(["ngSanitize","lux.controllers","lux.services"],function(a,b){k.ngModules.push(b)});var l=/xyz/.test(function(){})?/\b_super\b/:/.*/,m=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&l.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},n=f.Type=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var g in b)"Metaclass"!==g&&(f[g]=m.call(a,c,g,b[g],e));if(d){for(g in e)void 0===f[g]&&(f[g]=e[g]);return f}var h=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return h.prototype=f,h.prototype.constructor=h,h.extend=a.extend,h},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),o=f.Class=function(a){return a.__class__=n,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),p=f.ApiTypes={};if(!k.csrf){var q=a("meta[name=csrf-param]").attr("content"),r=a("meta[name=csrf-token]").attr("content");q&&r&&(k.csrf={},k.csrf[q]=r)}f.services.service("$lux",function(a,b,c,d,e){var f=this;this.location=a,this.log=d,this.http=c,this.q=b,this.anchorScroll=e,this.post=function(a,b,d){return k.csrf&&(b||(b={}),angular.extend(b,k.csrf)),c.post(a,b,d)},this.api=function(a){Object(a)!==a&&(a={name:a});var b=p[a.name||"lux"];return b?new b(a.name,a.url,f):void f.log.error('Api provider "'+a.name+'" is not available')}});var s=f.ApiClient=o.extend({apiUrls:k.apiUrls,init:function(a,b,c){this.name=a,this.$lux=c,this.auth=null,this._url=b},url:function(a){return void 0!==a?self._url+"/"+a:self._url},authentication:function(a){this.auth={},this.call(a)},addAuth:function(){},httpOptions:function(a){var b=a.options;return b.url=this.url(a.urlparams),b},request:function(b,c,d,e){var f=this.$lux.q.defer(),g=f.promise,h={deferred:f,options:a.extend({method:b,data:e},d),urlparams:c,api:this,error:function(b,c,d){a.isString(b)&&(b={error:!0,message:b}),f.reject({data:b,status:c,headers:d})},success:function(a,b,c){f.resolve({data:a,status:b,headers:c})}};return g.success=function(a){return g.then(function(b){a(b.data,b.status,b.headers)}),g},g.error=function(a){return g.then(null,function(b){a(b.data,b.status,b.headers)}),g},this.call(h),g},get:function(a,b){return this.request("GET",a,b)},put:function(a,b){return a.id?this.request("POST",{id:a.id},b,a):this.request("POST",null,b,a)},getMany:function(a){return this.request("GET",null,a)},call:function(a){var b=this.$lux;if(!this._url&&!this.name)return a.error("api should have url or name");if(!this._url){if(!this.apiUrls){if(k.apiUrl){var c=this;return b.log.info("Fetching api info"),b.http.get(k.apiUrl).success(function(b){c.apiUrls=b,c.call(a)}).error(a.error)}return a.error("Api url not available")}if(this._url=this.apiUrls[this.name]||this.apiUrls[this.name+"_url"],!this.url)return a.error("Could not find a valid url for "+this.name)}if(!this.auth)return this.authentication(a);this.addAuth(a);var d=this.httpOptions(a);d.url?b.http(d).success(a.success).error(a.error):a.error("Api url not available")}});f.createApi=function(a,b){return p[a]=s.extend(b),p[a]},f.createApi("lux",{authentication:function(a){var b=this;return k.user?($lux.log.info("Fetching authentication token"),$lux.post("/_token").success(function(c){b.auth={user_token:c.token},b.call(a)}).error(a.error),a.deferred.promise):(b.auth={},void b.call(a))},addAuth:function(a,b){if(this.user_token){var c=b.headers;c||(b.headers=c={}),c.Authorization="Bearer "+this.user_token}}}),f.createApi("static",{httpOptions:function(a){var b=a.options,c=a.api.url,d=a.urlparams.path;return d&&(c+="/"+d),".json"!==c.substring(c.length-5)&&(c+=".json"),b.url=c,b}}),f.createApi("googlesheets",{endpoint:"https://spreadsheets.google.com",url:function(){return this._url?this.endpoint+"/feeds/list/"+this._url+"/public/values?alt=json":void 0},getMany:function(a){var b=this.Model,c=this.$lux;return this.request("GET",null,a).success(function(a){return new b(c,a)})},Model:function(a,b){var c,d,e,f;if(this.column_names=[],this.name=b.feed.title.$t,this.elements=[],this.raw=b,"undefined"==typeof b.feed.entry)return void a.log.warn("Missing data for "+this.name+", make sure you didn't forget column headers");for(var g in b.feed.entry[0])/^gsx/.test(g)&&this.column_names.push(g.replace("gsx$",""));for(c=0,e=b.feed.entry.length;e>c;c++){var h=b.feed.entry[c],i={};for(d=0,f=this.column_names.length;f>d;d++){var j=h["gsx$"+this.column_names[d]];i[this.column_names[d]]="undefined"!=typeof j?""===j.$t||isNaN(j.$t)?j.$t:+j.$t:""}void 0===i.rowNumber&&(i.rowNumber=c+1),this.elements.push(i)}}});var t=new RegExp("^([a-z]+://|//)");f.controllers.controller("page",["$scope","$lux",function(b,c){c.log.info("Setting up angular page"),angular.extend(b,k);var d=b.page;b.page=d=d&&b.pages?b.pages[d]:{},b.windowHeight=function(){return h.window.innerHeight>0?h.window.innerHeight:h.screen.availHeight},b.search_text="",b.sidebarCollapse="",b.logout=function(a,b){a.preventDefault(),a.stopPropagation(),c.post(b).success(function(a){a.redirect&&window.location.replace(a.redirect)})},b.search=function(){b.search_text&&(window.location.href="/search?"+a.param({q:b.search_text}))},b.dismiss=function(a){c.post("/_dismiss_message",{message:a})},b.togglePage=function(a){a.preventDefault(),a.stopPropagation(),this.link.active=!this.link.active},b.loadPage=function(){b.page=this.link},b.collapse=function(){var a=h.window.innerWidth>0?h.window.innerWidth:h.screen.width;b.sidebarCollapse=a<k.navbarCollapseWidth?"collapse":""},b.collapse(),a(h).bind("resize",function(){b.collapse(),b.$apply()}),b.activeLink=function(a){var b;b=t.test(a)?c.location.absUrl():c.location.path();var d=b.substring(a.length),e=b.substring(0,a.length),f="/"===a.substring(a.length-1);return e===a&&(f||""===d||"/"===d.substring(0,1))},b.scrollToHash=function(b,d){var e=a(b.currentTarget.hash);e.length?(d=d?d:0,b.preventDefault(),b.stopPropagation(),c.log.info("Scrolling to target"),a("html,body").animate({scrollTop:e.offset().top+d},1e3)):c.log.warning("Cannot scroll, target not found")}}]),f.controllers.controller("html5Page",["$scope","$lux","response",function(a,b,c){var d=c.data;200===c.status&&(a.page=d,d.html_title&&(document.title=d.html_title))}]),b(k.hrefs,k.pages);var u="m__form";return f.app.directive("watchChange",function(){return{scope:{onchange:"&watchChange"},link:function(a,b){b.on("keyup",function(){a.$apply(function(){a.onchange()})}).on("change",function(){a.$apply(function(){a.onchange()})})}}}),f.controllers.controller("formController",["$scope","$lux","data",function(a,b,c){e(a,b,c)}]),f.controllers.controller("listgroup",["$scope","$lux","data",function(a,b,c){a.data=c.data}]),f.controllers.controller("userController",["$scope","$lux",function(b,c){e(b,c,k.user),b.unlink=function(b,c){b.preventDefault(),b.stopPropagation();var d="/oauth/"+c+"/remove";a.post(d).success(function(a){a.success&&$route.reload()})},b.check_password_repeat=function(){var a=this.formModel,b=this.form.password_repeat,c=a.password,d=a.password_repeat;c!==d&&b.$dirty?(this.formErrors.password_repeat="passwords don't match",b.$error.password_repeat=!0,this.formClasses.password_repeat="has-error"):b.$dirty&&(this.formClasses.password_repeat="has-success",delete this.form.$error.password_repeat)}}]),f.app.directive("luxElement",["$lux",function(a){return{restrict:"AE",link:function(b,c,d){var e=d.callback;if(e){var f=h[e];f?f(a,b,c,d):a.log.warn("Could not find callback "+e)}else a.log.warn("Could not find callback")}}}]),f.Viz=o.extend({init:function(b,c,d){b=a(b),this.element=b,this.attrs=c,this.$lux=d,this.elwidth=null,this.elheight=null;var e=this.element.parent();if(c.width?c.width=+c.width:(c.width=b.width(),c.width?this.elwidth=b:(c.width=e.width(),c.width?this.elwidth=e:c.width=400)),c.height?c.height.indexOf("%")===c.height.length-1&&(c.height_percentage=.01*parseFloat(c.height),c.height=c.height_percentage*c.width):(c.height=b.height(),c.height?this.elheight=b:(c.height=e.height(),c.height?this.elheight=e:c.height=400)),c.resize){var f=this;a(window).resize(function(){f.resize()})}this.build()},resize:function(a){var b,c;a?(b=a[0],c=a[1]):(b=this.elwidth?this.elwidth.width():this.attrs.width,c=this.attrs.height_percentage?b*this.attrs.height_percentage:this.elheight?this.elheight.height():this.attrs.height),(this.attrs.width!==b||this.attrs.height!==c)&&(this.attrs.width=b,this.attrs.height=c,this.build())},svg:function(a){return this.element.empty(),a.select(this.element[0]).append("svg").attr("width",this.attrs.width).attr("height",this.attrs.height)},size:function(){return[this.attrs.width,this.attrs.height]},sy:function(){var a=this.size();return a[1]/a[0]},build:function(){var a=this;require(["d3"],function(b){a.d3build(b)})},d3build:function(){}}),f.vizDirectiveFactory=function(a){return["$lux",function(b){return{restrict:"AE",link:function(c,d,e){new a(d,e,b)}}}]},f.app.directive("flickr",["$lux",function(a){function b(){}return{restrict:"AE",link:function(c,d,e){var f=e.id;a.http({method:"get",data:{id:f,format:"json"}}).success(function(a){b(a)})}}}]),f.bootstrap=function(){function b(){a.each(k.ngModules,function(a,b){-1===f.app.requires.indexOf(b)&&f.app.requires.push(b)}),angular.bootstrap(document,["lux"]),angular.forEach(j,function(a){a()}),j=!0}a(document).ready(function(){k.html5mode?require(["angular-route"],function(){if(i.length){var c=i;i=[],f.app.config(["$routeProvider","$locationProvider",function(b,d){angular.forEach(c,function(c){var d=c[0],e=c[1];a.isFunction(e)&&(e=e()),b.when(d,e)}),d.html5Mode(!0)}])}b()}):b()})},f});