define(["lodash","jquery"],function(a,b){"use strict";function c(a,b,c,d){this.key=a,this.value=b,this.next=c,this.width=d}var d=window,e=d.lux,f=Array.prototype.slice;lux=d.lux={debug:!1,skins:[],libraries:[],media_url:"/media/",icon:"fontawesome",data_api:!0,set_value_hooks:[],setValue:function(a,b){for(var c=0;c<lux.set_value_hooks.length;c++)if(lux.set_value_hooks[c](a,b))return;a.val(b)},addLib:function(b){a.contains(lux.libraries,b.name)||lux.libraries.push(b)},s4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){var a=lux.s4;return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},isnothing:function(a){return void 0===a||null===a},sorted:function(b,c){var d=[];a(b).forEch(function(a,b){d.push(b)}),d.sort(),a(d).forEach(function(a){c(b[a],a)})}},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},lux.addLib({name:"RequireJs",web:"http://requirejs.org/",version:require.version}),lux.addLib({name:"Lo-Dash",web:"http://lodash.com/",version:a.VERSION}),lux.addLib({name:"jQuery",web:"http://jquery.com/",version:b.fn.jquery});{var g=/xyz/.test(function(){})?/\b_super\b/:/.*/,h=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&g.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},i=lux.Type=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var g in b)"Metaclass"!==g&&(f[g]=h.call(a,c,g,b[g],e));if(d){for(g in e)void 0===f[g]&&(f[g]=e[g]);return f}var i=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return i.prototype=f,i.prototype.constructor=i,i.extend=a.extend,i},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),j=lux.Class=function(a){return a.__class__=i,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),k=j.extend({bindToElement:function(a){this._jquery_element=a},trigger:function(b,c){c?(a.isArray(c)||(c=[c]),c.splice(0,0,this)):c=[this],this.jElem().trigger(b,c)},on:function(a,b){this.jElem().on(a,b,f.call(arguments,2))},jElem:function(){return this._jquery_element?this._jquery_element:b(window)}}),l=j.extend({name:"Exception",init:function(a){this.message=a||""},toString:function(){return this.name+": "+this.message}}),m=l.extend({name:"ModelException"}),n=l.extend({name:"NotImplementedError"}),o={pkname:"id",name:"model",defaults:{}},p=lux.Meta=j.extend({init:function(b,c){this.model=b,a.extend(this,c),this.title=this.title||this.name},init_instance:function(b,c){b._fields={},b._changed={},b.cid=a.uniqueId("model"),c===Object(c)&&a(c).forEach(function(a,c){this.set_field(b,c,a,!0)},this)},get:function(c,d){if(!this._backend)throw new m("Cannot sync "+this+". No backend registered.");d||(d={}),b.isArray(c)||(c=[c]);var e={},f=this;a(c).forEach(function(a){f._add_to_crud(e,"read",a,d)}),f._backend.send(e.read)},update:function(b){var c=this,d=[];return a(b).forEach(function(a){var b=c.liveStorage.getItem(a.id);b?(b.update(a.fields),b._changed={}):b=new c.model(a.fields),d.push(b)}),d},set_field:function(b,c,d,e){if(void 0!==d){if(this.fields){var f=this.fields[c];if(f)d=f.validate(b,d);else if(null===f)return void(b[c]=d)}if(!e){var g=b.get(c);if(a.isEqual(d,g))return;return b._fields[c]=d,void 0===g?null:g}b._fields[c]=d}},toString:function(){return this.name}}),q=lux.ModelType=i.extend({new_class:function(b,c){c||(c={});var d=b._meta,e=a.merge({},o,c.meta);d&&d.fields&&(e.fields=this.mergeFields([d.fields,e.fields]));var f=this._super(b,c);return f._meta=f.prototype._meta=new p(f,e),f},mergeFields:function(b){var c={},d=[],e=[];return a(b).forEach(function(b){a(b).forEach(function(a){c[a.name]?c[a.name]=a:(c[a.name]=a,d.push(a.name))})}),a(d).forEach(function(a){e.push(c[a])}),e}}),r=lux.Model=k.extend({Metaclass:q,init:function(a){this._meta.init_instance(this,a)},pk:function(){return this.get(this._meta.pkname)},isNew:function(){return this.pk()?!1:!0},isDeleted:function(){return this._deleted===!0},fields:function(){return this._fields},toJSON:function(b){var c={},d=this._fields,e=d;return b&&!this.isNew()&&(e=this._changed),a(e).forEach(function(a,b){a=d[b],c[b]=a instanceof Date?.001*a.getTime():a}),c},set:function(a,b){var c=this._meta.set_field(this,a,b);void 0!==c&&(this._changed[a]=c,this.trigger("change",[this,a]))},changedFields:function(a){return a?"string"==typeof a?this._changed[a]:this._changed:this._changed},hasChanged:function(){return a.size(this._changed)>0},previous:function(a){return this._changed[a]},get:function(a){return this._fields[a]},update:function(b){if(b===Object(b)){var c=this;a(b).forEach(function(a,b){c.set(b,a)})}},"delete":function(){this._deleted=!0},sync:function(a,b){b||(b={});var c=b.success,d=this._sync_data(b),e=this;return d?(d.model=this._meta.name,d.success=function(a,b,d){e.sync_callback(a,b,d),c&&c(e)},a.execute(d)):void(c&&c(e))},sync_callback:function(a,b,c){200===c.status||201===c.status?(this._changed={},this.update(a)):c.crud===C.delete?this.trigger("deleted"):B.warning("Could not understand response")},toString:function(){return this._meta.name+"-"+this.cid},get_form:function(){},update_form:function(b){a(this.fields()).forEach(function(a,c){var d=b.find("[name="+c+"]");d.length&&lux.set_value(d,a)})},replace:function(b){var c=this;a(this._fields).forEach(function(a,d){void 0===b[d]&&(delete c._fields[d],c.trigger("change",d))}),this.update(b)},_sync_data:function(b){b||(b={});var c=this.pk();if(this.isDeleted()&&c)b.crud=C.delete,b.item={pk:c};else if(c&&this.hasChanged())b.crud=C.update,b.item={pk:c,data:this.toJSON()};else{if(c)return;var d=this.toJSON();if(!a.size(d))return;b.crud=C.create,b.item={data:d}}return b}});lux.Collection=j.extend({init:function(b,c){var d=this,e=[],f={},g=d.model=b||r.extend({});d.store=F(c),Object.defineProperty(d,"length",{get:function(){return e.length}}),a.extend(d,{at:function(a){var b=e[a];return b?f[b]:void 0},get:function(a){return f[a]},add:function(b,c){var d,h=[];return c||(c={}),a.isArray(b)||(b=[b]),a(b).forEach(function(a){a instanceof g||(a=new g(a)),d=f[a.cid],d?c.merge&&(d.update(a.fields()),d.hasChanged()&&h.push(d)):(f[a.cid]=a,e.push(a.cid),h.push(a))}),h},set:function(b){a(b).forEach(function(a){var b=a.id(),c=f[b];c?c.update(a.fields()):(f[b]=a,e.push(b))})},clear:function(){e=[],f={}},forEach:function(a){for(var b=e.length,c=0;b>c&&a(f[e[c]],c)!==!1;c++);},each:function(a){d.forEach(a)}})},reset:function(a){this.clear(),this.set(a)},fetch:function(a){a||(a={});var b=this;a.success||a.success||function(a){a=b.parse(a),b.reset(a)},a.meta=this.model._meta,b.store.execute(a)},sync:function(a){a||(a={});{var b=this.store;a.success,a.error}this.forEach(function(c){c.sync(b,a)})},parse:function(a){return a},toString:function(){return this.model._meta.name+"["+this.length+"]"},afterSync:function(a){a===C.delete||a===C.create||a===C.update}})}lux.EventClass=k,lux.Exception=l,lux.ModelException=m,lux.NotImplementedError=n;var s=lux.autoViews=[],t=lux.SKIN_NAMES=["default","primary","success","inverse","error"],u=(lux.getSkin=function(a,b){if(a){b=b?b+"-":"";for(var c=0;c<t.length;c++){var d=t[c];if(a.hasClass(b+d))return d}}},lux.setSkin=function(b,c,d){t.indexOf(c)>-1&&(d=d?d+"-":"",a(t).forEach(function(a){b.removeClass(d+a)}),b.addClass(d+c))},/^(\S+)\s*(.*)$/),v=["model","collection","elem","id","attributes","className","tagName","name","events"],w=lux.View=j.extend({tagName:"div",defaults:null,init:function(c){this.cid=a.uniqueId("view"),c||(c={}),this.defaults&&(c=a.extend({},this.defaults,c)),a.extend(this,a.pick(c,v)),this.elem?(this.elem=b(a.result(this,"elem")),this.setElement(this.elem,!1)):this.setElement(b(document.createElement(this.tagName)),!1),this.instance_key&&this.elem.data(this.instance_key,this),this.initialise(c)},initialise:function(){},remove:function(){return this.elem.remove(),this},delegateEvents:function(b){if(b=b||this.events,!b)return this;this.undelegateEvents();for(var c in b){var d=b[c];if(a.isFunction(d)||(d=this[d]),d){var e=c.match(u),f=e[1],g=e[2];d=a.bind(d,this),f+=".delegateEvents"+this.cid,""===g?this.elem.on(f,d):this.elem.on(f,g,d)}}return this},undelegateEvents:function(){return this.elem.off(".delegateEvents"+this.cid),this},render:function(){return this},setElement:function(a,c){return this.elem&&this.undelegateEvents(),this.elem=b(a),c!==!1&&this.delegateEvents(),this},show:function(){this.elem.show(),this.elem.trigger("show",this)},hide:function(){this.elem.hide(),this.elem.trigger("hide",this)},fadeIn:function(a){if(a||(a={}),!a.complete){var b=this;a.complete=function(){b.show()}}this.elem.fadeIn(a)},fadeOut:function(a){if(a||(a={}),!a.complete){var b=this;a.complete=function(){b.hide()}}this.elem.fadeOut(a)},getSkin:function(a){return lux.getSkin(this.elem,a||this.className)},setSkin:function(a,b){lux.setSkin(this.elem,a,b||this.className)},addStyle:function(a,c){if(a.length){var d,e=b("head");c&&(d=e.find("#"+c),d.length||(d=null)),d||(d=b("<style type='text/css' rel='stylesheet' />").appendTo(e).attr("id",c),d[0].styleSheet?d[0].styleSheet.cssText=a.join(" "):d[0].appendChild(document.createTextNode(a.join(" "))))}}});lux.createView=function(c,d,e){var f=d.jQuery,g=c+"-view";delete d.jQuery,d.name=c,d.instance_key=g,e=e||w;var h=e.extend(d),i=h.prototype,j=function(b,c,d){var e=b.data(g);return e||(c||(c={}),lux.data_api&&(c=a.extend({},b.data(),c)),c.elem=b,e=new h(c),d&&e.render()),e};return f&&(b.fn[c]=function(a){return"instance"===a?this.data(g):j(this,a).elem}),i.selector&&s.push({selector:i.selector,load:function(a){j(b(a),null,!0)}}),h},lux.loadViews=function(c){c=b(c||document),a(s).forEach(function(a){b(a.selector,c).each(function(){a.load(this)})})},lux.initWeb=function(){b(document).ready(function(){var c=b(this),d=c.find("html").data()||{},e=c.find("body");a.extend(lux,d),lux.debug&&(B.config({level:"debug"}),B.handlers.length||B.addHandler()),e.css({opacity:0});try{lux.loadViews(c),e.fadeIn(100)}finally{e.css({opacity:1})}})};var x={debug:10,info:20,warning:30,error:40,critical:50},y="info",z=lux.Logger=j.extend({init:function(b,c){var d=this,e={},f={level:y,formatter:function(a,b){return b+": "+a}};a(x).forEach(function(a,b){d[b]=function(a){d.log(a,b)}}),a.extend(d,{handlers:[],config:function(a){return a=Object(a),a.level&&x[a.level]&&(f.level=a.level),f},getConfig:function(){return f},log:function(a,b){var c=x[b]||0;if(c>x[f.level])for(var e,g=d.getHandlers(),h=0;h<g.length;h++)e=g[h],c>=e.nlevel&&e.log(a,b)},get:function(a){var b=e[a];return b||(b=new z({namespace:a},d),e[a]=b),b},getHandlers:function(){return!d.handlers.length&&c?c.getHandlers():d.handlers}}),d.config(b)},addHandler:function(b,c){c=c||new A,c.config(a.extend({},this.getConfig(),b)),this.handlers.push(c)}}),A=lux.LogHandler=j.extend({config:function(b){a.extend(this,b),this.nlevel=x[this.level]||0},log:function(a,b){console.log(this.formatter(a,b))}}),B=(lux.HtmlLogHandler=A.extend({init:function(a){this.elem=b(a),this.elem.addClass("lux-logger")},log:function(a,b){a=this.formatter(a,b),a='<pre class="'+b+'">'+a+"</pre>",this.elem.prepend(a)}}),new z);lux.getLogger=function(b,c){var d=B;return b&&a.each(b.split("."),function(a){d=d.get(a)}),c&&d.config(c),d};var C={create:"create",read:"read",update:"update","delete":"delete"},D=(lux.CrudMethod={create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},{}),E=lux.register_store=function(a,b){D[a]=b},F=lux.create_store=function(b,c){if(b instanceof G)return b;if(a.isString(b)){var d=b.search("://"),e=-1===d?"http":b.substr(0,d),f=D[e];if(f&&b)return new f(b,c,e)}return new G(b,c,"dummy")},G=lux.Backend=lux.Class.extend({options:{dataType:"json"},init:function(b,c,d){this.type=d,this.url=b,this.options=a.merge({},this.options,c)},execute:function(a){a.success&&a.success([])},toString:function(){return this.type+" "+this.url}}),H=lux.Backend.extend({init:function(a,b){this._super(a,b,"ajax")},execute:function(a){var c=this.url,d=(a.model,a.item);delete a.model,a.type=lux.CrudMethod[a.crud]||a.type||"GET",d&&(delete a.item,d.pk&&(c=lux.utils.urljoin(c,d.pk)),a.data=d.data),b.ajax(c,a)}});E("http",H),E("https",H);var I=lux.Backend.extend({options:{resource:null,reconnecting:1,hartbeat:5,maxDelay:3600,maxRetries:null,factor:2.718281828459045,jitters:0,jitter:.11962656472},init:function(a,b){var c=this;a=this.websocket_uri(a),this._super(a,b,"websocket"),this._retries=0,this._transport=null,this._opened=!1,this._pending_messages={},this._delay=this.options.reconnecting,this._queue=[],c.connect()},opened:function(){return this._opened},connect:function(){var a=this.options,b=this.url,c=this;a.resource&&(b+=a.resource),B.info("Connecting with "+c),this._transport=new WebSocket(b),this._transport.onopen=function(){c.onopen()},this._transport.onmessage=function(a){"message"===a.type&&c.onmessage(a)},this._transport.onclose=function(){c.onclose()}},onopen:function(){if(this._opened=!0,B.info(this+" opened."),this.options.onopen&&this.options.onopen.call(this),this._queue){var b=this._queue;this._queue=[],a(b).forEach(function(a){this._transport.send(a)},this)}},reconnect:function(){var a=this.options,b=this;return this._delay?(this._retries+=1,null!==a.maxRetries&&this._retries>a.maxRetries?void web.logger.info("Exiting websocket after "+this.retries+" retries."):(this._delay=Math.min(this._delay*a.factor,a.maxDelay),a.jitter&&(this._delay=lux.math.normalvariate(this._delay,this._delay*a.jitter)),web.logger.info("Try to reconnect websocket in "+this._delay+" seconds"),this.trigger("reconnecting",this._delay),void(this._reconnect=lux.eventloop.call_later(this._delay,function(){b._reconnect=null,b.connect()})))):void web.logger.info("Exiting websocket")},execute:function(b){if(!b.beforeSend||b.beforeSend.call(b,this)!==!1){var c={mid:this.new_mid(b),action:b.action||lux.CrudMethod[b.crud]||b.crud,model:b.model};b.item?a.extend(c,b.item):c.data=b.data,c=JSON.stringify(c),this._opened?this._transport.send(c):this._queue.push(c)}},onmessage:function(a){var b=JSON.parse(a.data),c=b.mid,d=c?this._pending_messages[c]:void 0,e=b.data;b.response=a,b.backend=this,d&&delete this._pending_messages[c],b.error?d&&d.error?d.error(b,"error",b.error):B.error(this.toString()+" - "+b.error):d&&d.success?d.success(e,"success",b):B.warning(this.toString()+" - Got message with no callback registered")},onclose:function(){this._opened=!1,B.warning(this+" closed."),this.reconnect()},new_mid:function(b){if(b.success||b.error){var c=a.uniqueId("ws-message");return this._pending_messages[c]=b,c}},websocket_uri:function(a){var b=window.location;if(a||(a=b.href.split("?")[0]),"http://"===a.substring(0,7))return"ws://"+a.substring(7);if("https://"===a.substring(0,8))return"wss://"+a.substring(8);if("ws://"===a.substring(0,5)||"wss://"===a.substring(0,6))return a;var c="http:"===b.protocol?"ws:":"wss:";return lux.utils.urljoin(c,b.host,b.pathname,a)}});E("ws",I),E("wss",I);var J="ABCDEFGHIJKLMNOPQRSTUVWXYZ";lux.num_to_letter=function(a){for(var b=J.length,c="";a>=b;){var d=a%b;a=Math.floor(a/b),c+=J[d]}return c+=J[a]},lux.fields_from_array=function(b){var c={};return a(b).forEach(function(b){var d=c[b.name];void 0===d?c[b.name]=b.value:a.isArray(d)?d.push(b.value):c[b.name]=[d,b.value]}),c},lux.Ordered=j.extend({init:function(){this.all={},this.order=[]},set:function(a,b){this.all[a]?this.all[a]=b:a&&(this.order.push(a),this.all[a]=b)},get:function(a){return this.all[a]},at:function(a){return a<this.order.length?this.all[this.order[a]]:void 0},size:function(){return this.order.length},each:function(b,c){a(this.order).forEach(function(a,d){b.call(c,this.all[a],a,d)},this)},ordered:function(){var b=[];return a(this.order).forEach(function(a){b.push(this.all[a])},this),b}});{var K=32,L=lux.SkipList=function(b,d){b=Math.min(K,Math.max(8,b?b:K));var e,f=function(a){for(var c=[],d=b;d--;)c.push(a);return c},g=Math.log(2),h=0,i=new c("HEAD",null,new Array(b),f(1)),j=1;Object.defineProperty(this,"length",{get:function(){return h}}),Object.defineProperty(this,"levels",{get:function(){return levels}}),a.extend(this,{insert:function(a,k){var l,m,n=new Array(b),o=f(0),p=i;for(e=j-1;e>=0;e--){for(o[e]=e===j-1?0:o[e+1];p.next[e]&&p.next[e].key<=a;)o[e]+=p.width[e],p=p.next[e];n[e]=p}if(n[0].key===a&&d)return h;var q=Math.min(b,1-Math.round(Math.log(Math.random())/g));if(q>j){for(e=j;q>e;e++)o[e]=0,n[e]=i,n[e].width[e]=h;j=q}for(p=new c(a,k,new Array(b),new Array(b)),e=0;q>e;e++)l=n[e],m=o[0]-o[e],p.next[e]=l.next[e],p.width[e]=l.width[e]-m,l.next[e]=p,l.width[e]=m+1;for(e=q;j>e;e++)n[e].width[e]+=1;return h+=1},forEach:function(a){for(var b=i.next[0];b;)a(b.value,b.score),b=b.next[0]}})};lux.icons={fontawesome:function(a,c){var d=(b("i",a).remove(),'<i class="fa fa-'+c.icon+'"></i>');a[0].text&&(a[0].text=" "+a[0].text),a.prepend(d)}}}lux.addIcon=function(a,b){var c=lux.icons[lux.icon];c&&!a.is("html")&&(b||(b=a.data()),b.icon&&c(a,b))},lux.autoViews.push({selector:"[data-icon]",load:function(a){lux.addIcon(b(a))}});{var M=["large","normal","small","mini"],N=lux.buttonGroup=function(a){a||(a={});var c=b(document.createElement("div"));return c.addClass(a.vertical?"btn-group-vertical":"btn-group"),a.radio&&c.data("toggle","buttons-radio"),c},O=lux.Button=lux.createView("button",{tagName:"button",selector:".btn",defaults:{skin:"default"},className:"btn",initialise:function(a){var b=this.elem;b.addClass(this.className).attr({type:a.type,title:a.title,href:a.href}).addClass(a.classes),this.setSkin(a.skin),this.setSize(a.size),a.text&&b.html(a.text),a.icon&&lux.addIcon(b,a),a.block&&b.addClass("btn-block")},setSize:function(b){if(M.indexOf(b)>-1){var c=this.elem,d=this.className+"-";a(M).forEach(function(a){c.removeClass(d+a)}),c.addClass(d+b)}}}),P=(lux.Form=lux.createView("form",{tagName:"form",defaults:{dataType:"json",layout:null,groupClass:"form-group",controlClass:"form-control",skin:"default",ajax:!1,complete:null,error:null,success:null},initialise:function(a){this.options=a,this.elem.hasClass("horizontal")?a.layout="horizontal":this.elem.hasClass("inline")&&(a.layout="inline"),a.layout&&this.elem.addClass("form-"+a.layout),lux.setSkin(this.elem,a.skin)},addFields:function(b){var c=[],d=this;return a(b).forEach(function(a){a&&a.name&&-1===c.indexOf(a.name)&&(c.push(a.name),a.render(d))}),this},addSubmit:function(a){a||(a={}),a.skin||(a.skin=this.options.skin),a.tagName||(a.tagName="button",a.text||(a.text="Submit"));var b=new O(a);this.elem.append(b.elem)},render:function(){if(this.options.layout){var a=this["render_"+this.options.layout];a.call(this)}else{var c=this;b("input,select,textarea",this.elem).each(function(){var a=b(this);"checkbox"!==a.attr("type")&&a.addClass(c.options.controlClass)})}return this},render_horizontal:function(){var a,c,d,e,f,g=this;b("input,select,textarea",this.elem).each(function(){a=b(this).addClass(g.options.controlClass),e=a.closest(g.options.groupClass),e.length&&(d=a.parent(),d.is("label")||(d=a),e=b(document.createElement("div")).addClass("controls"),d.before(e).appendTo(e),f=e.parent(),e.hasClass("control-group")||(c=e.prev(),f=b(document.createElement("div")).addClass("control-group"),e.before(f).appendTo(f),c.is("label")&&f.prepend(c.addClass("control-label"))))})},fieldset:function(a){var c,d=this.elem.children("fieldset");return a?(fs=a instanceof jQuery?a:a instanceof HTMLElement?b(a):a.id?this.elem.find("#"+a.id):a.Class?this.elem.find("."+a.Class):d.last(),fs.length?c=fs:(c=b(document.createElement("fieldset")).appendTo(this.elem),a.id?c.attr(id,a.id):a.Class&&c.addClass(a.Class))):c=d.length?d.first():b(document.createElement("fieldset")).appendTo(this.elem),c}}),lux.Field=lux.Class.extend({fieldOptions:["tagName","type","label","placeholder","autocomplete","required","fieldset"],tagName:"input",type:"text",init:function(b,c){c||(c={}),this.name=b,a.extend(this,a.pick(c,this.fieldOptions)),this.label=this.label||this.name.capitalize(),this.required&&(this.required="required")},validate:function(a,b){return b||0===b?b+"":void 0},setValue:function(a,b){a&&b.val(a.get(this.name))},render:function(a){var c=b(document.createElement(this.tagName)).attr({name:this.name,type:this.type,title:this.title||this.name,autocomplete:this.autocomplete,placeholder:this.getPlaceholder()});this.setValue(a.model,c),a.elem.append(this.outerContainer(c,a))},getPlaceholder:function(){return this.placeholder!==!1?this.placeholder?this.placeholder:this.label:void 0},outerContainer:function(c,d){if("inline"!==d.layout){var e=c.attr("id");e||(e=a.uniqueId("field"),c.attr("id",e));var f=b(document.createElement("label")).html(this.label).attr("for",e),g=b(document.createElement("div")).addClass(d.options.groupClass);return g.append(f).append(c)}return c}})),Q=(lux.Field=P.extend({type:"number",validate:function(a,b){return parseInt(b,10)}}),lux.FloatField=P.extend({type:"number",validate:function(a,b){return parseFloat(b)}}),lux.BooleanField=P.extend({type:"checkbox",setValue:function(a,b){if(a){var c=a.get(this.name)?!0:!1;b.prop("checked",c)}},validate:function(a,b){return void 0!==b?b===!0||"on"===b:void 0},render:function(a){var c=b(document.createElement(this.tagName)).attr({name:this.name,type:this.type,title:this.title});this.setValue(a.model,c);var d=b(document.createElement("label")),e=b(document.createElement("div")).addClass("checkbox");c=e.append(d.append(c).append(this.label)),a.elem.append(c)}}),lux.ChoiceField=P.extend({fieldOptions:a.union(P.prototype.fieldOptions,["choices","select2"]),tagName:"select",type:null,setValue:function(a,b){if(a){var c=a.get(this.name);b.is("select")||b.val()===c&&b.prop("checked",!0)}},render:function(c){var d,e,f=this,g=this.choices;if(a.isFunction(g)&&(g=g()),"select"===this.tagName){if(d=b(document.createElement(this.tagName)).attr({name:this.name}).append(b("<option></option>")),a(g).forEach(function(c){a.isString(c)?e=c:(e=c.text||c.value,c=c.value),d.append(b("<option></option>").val(c).text(e))}),f.setValue(c.model,d),c.elem.append(f.outerContainer(d,c)),this.select2){var h=this.select2;h.placeholder||(h.placeholder=this.getPlaceholder()),d.Select(h)}}else"input"===this.tagName&&"radio"===this.type&&(a(g).forEach(function(a){a instanceof string?e=a:(e=a.text||a.value,a=a.value),d=b(document.createElement(this.tagName)).attr({type:"radio",name:f.name,value:a}).html(e),f.setValue(c.model,d)}),c.elem.append(d))}}));lux.MultiField=Q.extend({init:function(a){this.options=Object(a),this.options.multiple="multiple"}}),lux.TextArea=P.extend({tagName:"textarea"}),lux.KeywordsField=P.extend({validate:function(b,c){if(a.isString(c)){var d=[];return a(c.split(",")).forEach(function(a){a=a.trim(),a&&d.push(a)}),d}if(a.isArray(c))return c;var e=[];return a(c).forEach(function(a){e.push(a)}),e}})}b.fn.Select=function(b){b||(b={});var c=this;return require(["select"],function(){a.isObject(b)&&(b.width="element"),c.select2(b)}),this};var R=function(a,b){return a.hasClass("select2-offscreen")?(a.select2("val",b),!0):void 0};lux.set_value_hooks.push(R);var S=(lux.Grid=lux.createView("grid",{initialise:function(b){var c=this;this.elem.addClass("grid").addClass("fluid"),b.rows&&a(b.rows).forEach(function(a){c.addRow(a)})},addRow:function(c){var d=b(document.createElement("div")).addClass("row").addClass("grid24").appendTo(this.elem);return a(c).forEach(function(a){var c="span"+a;d.append(b(document.createElement("div")).addClass("column").addClass(c))}),d}}),lux.Fullscreen=lux.createView("fullscreen",{defaults:{zindex:2010,icon:"times-circle",themes:["default","inverse"]},initialise:function(a){var c=b(document.createElement("div")).addClass("fullscreen").css({"z-index":a.zindex});this.wrap=b(document.createElement("div")).addClass("fullscreen-container").appendTo(c),this.side=b(document.createElement("div")).addClass("fullscreen-sidebar").appendTo(c),this.sidebar=N({vertical:!0}).appendTo(this.side),this.themes=a.themes,this.theme=1,this.exit=new O({icon:a.icon,title:"Exit full screen"}),this.exit.elem.appendTo(this.sidebar),this.theme_button=new O({icon:"laptop",title:"theme"}),this.theme_button.elem.appendTo(this.sidebar),this._wrapped={elem:this.elem,previous:this.elem.prev(),parent:this.elem.parent()},this.setElement(c),this.toggle_skin()},render:function(){var a=this;a.elem.parent().length||(a.exit.elem.click(function(){a.remove()}),a.theme_button.elem.click(function(){a.toggle_skin()}),a.wrap.append(this._wrapped.elem),a.elem.appendTo(document.body))},remove:function(){var a=this._wrapped;return a.previous.length?a.previous.after(a.elem):a.parent.prepend(a.elem),this._super()},toggle_skin:function(){var a=this.themes,b=this.theme;this.theme=b?0:1,this.theme_button.setSkin(a[b]),this.setSkin(a[this.theme])}})),T=(lux.Dialog=lux.createView("dialog",{jQuery:!0,selector:".dialog",defaultElement:"div",defaults:{className:null,show:!0,keyboard:!0,closable:null,collapsable:!1,collapsed:!1,dragdrop:!1,fullscreen:!1,title:null,body:null,footer:null,modal:!1,modal_zindex:1040,autoOpen:!0,width:null,height:null,top:null,skin:"default",icons:{open:"plus-circle",close:"minus-circle",remove:"times",fullscreen:"arrows-alt"},buttons:{size:"mini"}},initialise:function(c){var d=this,e=this.elem.addClass("dialog").addClass(c.className).hide(),f=c.closable,g=e.attr("title")||c.title,h=b(document.createElement("div")).addClass("header"),i=b(document.createElement("div")).addClass("body-wrap"),j=b(document.createElement("h3"));e.attr("id")||e.attr("id",this.cid),this.setSkin(c.skin),this._body=b(document.createElement("div")).addClass("body").append(e.contents()),this._foot=null,d.buttons=b(document.createElement("div")).addClass("btn-group").addClass("pull-right"),h.append(d.buttons).append(j),g&&j.append(g),e.empty().append(h).append(i.append(this._body)),c.body&&this._body.append(c.body),this.createButton=function(b){return b=a.extend(b||{},c.buttons),b.skin||(b.skin=this.getSkin()),new O(b)};var k=c.width;if(c.modal){k=this._modalCss(c),e.appendTo(document.body),f=null===f?!0:f;var l=b(document.createElement("div")).addClass("modal-backdrop fullscreen").css("z-index",c.modal_zindex);e.on("remove",function(){l.remove()}).on("show",function(){l.appendTo(document.body)}).on("hide",function(){l.detach()})}k&&e.width(k),c.height&&this._body.height(c.height),c.collapsable&&d._addCollapsable(c),f&&this._addClosable(c),c.fullscreen&&this._addFullscreen(c),c.movable&&this._addMovable(c),c.autoOpen&&d.show()},body:function(){return this._body},foot:function(){return this._foot},header:function(){return this.element().children(".header")},title:function(a){return this.header().children("h3").html(a)},_addClosable:function(a){var b=a.destroy,c=this,d=this.createButton({icon:a.icons.remove});d.elem.appendTo(this.buttons).click(function(){c.fadeOut({complete:function(){b?c.destroy():c.hide()}})})},_addCollapsable:function(a){var b=this,c=this.elem.children(".body-wrap"),d=b.createButton(),e=!1;a.collapsed&&(e=!0,c.hide().addClass("in").one("hide",function(){c.removeClass("collapse")})),c.on("show",function(){e&&(e=!1,c.addClass("collapse").show()),b.elem.removeClass("collapsed"),lux.addIcon(d.elem,{icon:a.icons.close})}).on("hidden",function(){b.element().addClass("collapsed"),lux.addIcon(d.elem,{icon:a.icons.open})}),a.collapsed||c.height("auto"),d.elem.appendTo(this.buttons).mousedown(function(a){a.stopPropagation()}).click(function(){return c.collapse("toggle"),!1}),require(["bootstrap"],function(){b.elem.children(".body-wrap").collapse()})},_addFullscreen:function(a){var b=a.fullscreen,c=this.createButton({icon:a.icons.fullscreen,title:"Full screen mode"});b.render||(b=new S({elem:this.body()})),c.elem.prependTo(this.buttons).on("click",function(){b.render()})},_addMovable:function(){},_modalCss:function(a){var b=a.width||500;return rules=["#"+this.attr("id")+"{","    margin-left: -"+b/2+"px,","    left: 50%,","    position: absolute,","z-index: "+(a.modal_zindex+10)+",","top: "+(a.top||"25%"),"}"],this.addStyle(rules),b}}),l.extend({name:"StopIteration"})),U=j.extend({init:function(a,b,c){this.deadline=a,this.cancelled=!1,this.callback=b,this.args=c},cancel:function(){this.cancelled=!0},reschedule:function(a){this._deadline=a,this._cancelled=!1}}),V=j.extend({init:function(b,c,d,e){var f,g=this,h=!1;this.callback=c,this.args=d;var i=function(){try{this.callback.call(this,g.args)}catch(a){return void g.cancel()}j()},j=function(){h||(e?(f.reschedule(b.time()+e),b.scheduled.insert(f.deadline,f)):b.callbacks.append(f))};e&&e>0?(e=e,f=b.call_later(e,i)):(e=null,f=b.call_soon(i)),a.extend(this,{get cancelled(){return h},cancel:function(){h=!0}})}}),W=lux.EventLoop=j.extend({init:function(){var b=[],c=new L,d=!1,e=window.requestAnimationFrame,g=function(){var c=(this.time(),b.splice(0));a(c).forEach(function(a){a.cancelled||a.callback(a.args.splice(0))})},h=function(a){if(d){try{g(a)}catch(b){if("StopIteration"===b.name)return void(d=!1)}d&&e(h)}};a.extend(this,{get callbacks(){return b},get scheduled(){return c},call_soon:function(a){var c=new U(null,a,f(arguments,1));return b.append(c),c},call_later:function(a,b){var d=f.call(arguments,2),e=new U(this.time()+a,b,d);return c.insert(e.deadline,e),e},call_at:function(a,b){var d=f.call(arguments,2),e=new U(a,b,d);return c.insert(e.deadline,e),e},run:function(){d||(d=!0,e(h))},is_running:function(){return d}})},call_every:function(a){return new V(this,a,f(arguments,1))},time:function(){return(new Date).getTime()},stop:function(a){this.is_running()?this.call_soon(function(){if(a)try{a()}catch(b){console.log(b)}throw new T}):a&&a()}});lux.eventloop=new W;lux.each;lux.utils={detector:{canvas:!!window.CanvasRenderingContext2D,workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob},allClasses:function(a){var c={},d=[];return b(a).each(function(){this.className&&b.each(this.className.split(" "),function(){var a=this;""!==a&&void 0===c[a]&&(c[a]=a,d.push(a))})}),d},as_tag:function(a,c){var d=b(c);return d.length||"string"!=typeof c?d.length?(d.is(a)||(d=b("<"+a+">").append(d)),d):void 0:b("<"+a+">").html(c)},closest_color:function(a,c){var d=null;for(a=b(a);a.length&&null===d;)a=a.parent(),d=a.css(c),("inherit"==d||"transparent"==d)&&(d=null);return d},urljoin:function(){var a=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},b=[].slice.call(arguments,0).join("/");return a(b)},prettyTime:function(a){var b=Math.floor(a/86400);return 0===b&&(2>a&&"1 second ago"||60>a&&Math.floor(a)+" seconds ago"||120>a&&"1 minute ago"||3600>a&&Math.floor(a/60)+" minutes ago"||7200>a&&"1 hour ago"||86400>a&&Math.floor(a/3600)+" hours ago")||1===b&&"Yesterday"||7>b&&b+" days ago"||31>b&&Math.ceil(b/7)+" weeks ago"},asDate:function(a){if(a instanceof Date)return a;var b=parseFloat(a);if(b===b)return new Date(1e3*b);throw new TypeError("Could not convert "+a+" to a date")}};var X={},Y=Math.PI;lux.math=X,b.extend(X,{point2d:function(a,b){return{x:a,y:b}},distance2d:function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))},angle2d:function(a,b,c,d,e,f){var g=a-c,h=b-d,i=e-c,j=f-d,k=Math.atan2(g,h),l=Math.atan2(i,j);return k-l},degree:function(a){return 180*a/Y},radians:function(a){return Y*a/180}});var Z=Math.random,$=Math.log,_=4*Math.exp(-.5)/Math.sqrt(2);return b.extend(X,{normalvariate:function(a,b){for(var c,d,e,f;;)if(c=Z(),d=1-Z(),e=_*(c-.5)/d,f=e*e/4,f<=-$(d))break;return a+e*b}}),a.extend(lux,e)});