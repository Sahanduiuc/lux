define(["jquery","angular","angular-route","angular-sanitize"],function(a){"use strict";function b(a,b,c){var d=this;this.lux=c,this.name=a,this.get=function(){},this.put=function(a,c){return c=a.id?angular.extend({url:function(b){return b+"/"+a.id},data:a,method:"POST"},c):angular.extend({data:a,method:"POST"},c),b.call(d,c)},this.getMany=function(a){return a=angular.extend({method:"GET"},a),b.call(d,a)}}function c(a){angular.forEach(a,function(a){c(a.links),a.href&&"_self"!==a.target&&f.addRoute(a.href,{templateUrl:a.href+"/html"})})}function d(b){return function(c){if("application/x-www-form-urlencoded"===b)return a.param(options.data);if("multipart/form-data"===b){var d=new FormData;return angular.forEach(c,function(a,b){d.append(b,a)}),d}return c}}function e(a,b,c){function e(b){angular.forEach(b,function(b,c){a.formMessages[c]=b})}c||(c={}),a.formModel=c,a.formClasses={},a.formErrors={},a.formMessages={},a.checkField=function(b){var c=a["check_"+b];if(c)c.call(a);else{var d=a.form[b];d.$valid?a.formClasses[b]="has-success":d.$dirty&&(a.formErrors[b]=b+" is not valid",a.formClasses[b]="has-error")}},a.showErrors=function(){var b=a.form.$error;angular.forEach(b.required,function(b){a.formClasses[b.$name]="has-error"})},a.processForm=function(c){c.preventDefault(),c.stopPropagation();var f,g,h=angular.element(c.target),i=h.attr("data-api"),j=h.attr("action");if(a.form.$invalid)return a.showErrors();if(!j&&i&&(g=b.api(i),g||b.log.error("Could not find api url for "+i)),a.formMessages={},j){var k=h.attr("enctype")||"",l=k.split(";")[0],n={url:j,method:h.attr("method")||"POST",data:a.formModel,transformRequest:d(l)};("application/x-www-form-urlencoded"===l||"multipart/form-data"===l)&&(n.headers={"content-type":void 0}),f=b.http(n)}else{if(!g)return void b.log.error("Could not process form. No target or api");f=g.put(a.formModel)}f.then(function(b){b.messages?angular.forEach(b.messages,function(b,c){a.formMessages[c]=b}):window.location.href=b.redirect||"/"},function(a,b){var c,d;a?(c=a.messages,c||(d=a.message,d||(b=b||a.status||501,d="Server error ("+a.status+")"),c={},c[m]=[{message:d,error:!0}])):(b=b||501,d="Server error ("+a.status+")",c={},c[m]=[{message:d,error:!0}]),e(c)})}}var f={},g={},h=window,i=[],j=[],k=angular.extend(g,h.context);f.$=a,f.context=k,f.services=angular.module("lux.services",[]),f.controllers=angular.module("lux.controllers",["lux.services"]),f.app=angular.module("lux",["ngRoute","ngSanitize","lux.controllers","lux.services"]),f.addRoute=function(a,b){i.push([a,b])},f.add_ready_callback=function(a){j===!0?a():j.push(a)},f.bootstrap=function(){angular.element(document).ready(function(){if(i.length&&k.html5mode){var a=i;i=[],f._setupRouter(a)}angular.bootstrap(document,["lux"]),angular.forEach(j,function(a){a()}),j=!0})},f._setupRouter=function(b){f.app.config(["$routeProvider","$locationProvider",function(c,d){angular.forEach(b,function(b){var d=b[0],e=b[1];a.isFunction(e)&&(e=e()),c.when(d,e)}),d.html5Mode(!0)}])};f.services.service("$lux",function(a,b,c,d){var e=this;this.location=a,this.log=d,this.http=c,this.q=b,this.api=function(a,b){return b||(b=l),b.api(a,e)}});var l={api:function(a,c){return new b(a,this,c)},call:function(b,c,d,e){function f(a,b,c){e.reject(a,b,c)}var g=this,h=b.lux;if(e||(e=h.q.defer()),this._api){var i=this._api[b.name+"_url"];if(i)if(void 0===this.user_token&&k.user)h.log.info("Fetching authentication token"),h.http.post("/_token").success(function(a){g.user_token=a.token||null,g.call(b,c,d,e)}).error(f);else{if(this.user_token){var j=c.headers;j||(c.headers=j={}),j.Authorization="Bearer "+this.user_token}var l=c.url;a.isFunction(l)&&(l=l(i)),l||(l=i),c.url=l,h.http(c).success(function(a){e.resolve(d?d(a):a)}).error(f)}else e.reject("Could not find a valid url for "+b.name)}else k.apiUrl?(h.log.info("Fetching api info"),h.http.get(k.apiUrl).success(function(a){g._api=a,g.call(b,c,d,e)}).error(f)):e.resolve({message:"Api url not available"});return e.promise}};f.controllers.controller("page",["$scope","$http","$location",function(b,c){angular.extend(b,k),b.search_text="",b.page=k.page||{},b.sidebar_collapse="",b.logout=function(b,c){b.preventDefault(),b.stopPropagation(),a.post(c).success(function(a){a.redirect&&window.location.replace(a.redirect)})},b.search=function(){b.search_text&&(window.location.href="/search?"+a.param({q:b.search_text}))},b.dismiss=function(a){c.post("/_dismiss_message",a)},b.togglePage=function(a){a.preventDefault(),a.stopPropagation(),this.link.active=!this.link.active},b.loadPage=function(){b.page=this.link},b.collapse=function(){var a=h.window.innerWidth>0?h.window.innerWidth:h.screen.width;b.sidebar_collapse=a<k.collapse_width?"collapse":""},b.collapse(),a(h).bind("resize",function(){b.collapse(),b.$apply()})}]),c(k.sitemap);var m="m__form";return f.app.directive("watchChange",function(){return{scope:{onchange:"&watchChange"},link:function(a,b){b.on("keyup",function(){a.$apply(function(){a.onchange()})}),b.on("change",function(){a.$apply(function(){a.onchange()})})}}}),f.controllers.controller("formController",["$scope","$lux",function(a,b){e(a,b)}]),f.controllers.controller("userController",["$scope","$lux",function(b,c){e(b,c,k.user),b.unlink=function(b,c){b.preventDefault(),b.stopPropagation();var d="/oauth/"+c+"/remove";a.post(d).success(function(a){a.success&&$route.reload()})},b.check_password_repeat=function(){var a=this.formModel,b=this.form.password_repeat,c=a.password,d=a.password_repeat;c!==d&&b.$dirty?(this.formErrors.password_repeat="passwords don't match",b.$error.password_repeat=!0,this.formClasses.password_repeat="has-error"):b.$dirty&&(this.formClasses.password_repeat="has-success",delete this.form.$error.password_repeat)}}]),f});