define(["lodash","jquery"],function(){"use strict";function a(a,b,c,d){this.key=a,this.value=b,this.next=c,this.width=d}var b=window,c={},d=Array.prototype.slice;b.lux=c,c.showdown={},c.s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},c.guid=function(){var a=c.s4;return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},c.isnothing=function(a){return void 0===a||null===a},c.sorted=function(a,b){var c=[];_(a).forEch(function(a,b){c.push(b)}),c.sort(),_(c).forEach(function(c){b(a[c],c)})},c.event=function(){return $.Event()};{var e="cid",f="cidchange",g=/xyz/.test(function(){})?/\b_super\b/:/.*/,h=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&g.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},i=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var g in b)"Metaclass"!==g&&(f[g]=h.call(a,c,g,b[g],e));if(d){for(g in e)void 0===f[g]&&(f[g]=e[g]);return f}var i=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return i.prototype=f,i.prototype.constructor=i,i.extend=a.extend,i},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),j=function(a){return a.__class__=i,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),k=j.extend({bindToElement:function(a){this._jquery_element=a},trigger:function(a){this.jElem().trigger(a,this,d.call(arguments,1))},on:function(a,b){this.jElem().on(a,b,d.call(arguments,2))},jElem:function(){return this._jquery_element?this._jquery_element:$(window)}}),l=j.extend({name:"Exception",init:function(a){this.message=a||""},toString:function(){return this.name+": "+this.message}}),m=l.extend({name:"ModelException"}),n=l.extend({name:"NotImplementedError"}),o={pkname:"id",name:"model",defaults:{}},p=j.extend({init:function(a,b){this.model=a,_.extend(this,b),this.title=this.title||this.name},init_instance:function(a,b){a._fields={},a._changed={},b===Object(b)&&_(b).forEach(function(b,c){this.set_field(a,c,b)},this),a.pk()||(a._id=e+c.s4())},get:function(a,b){if(!this._backend)throw new m("Cannot sync "+this+". No backend registered.");b||(b={}),$.isArray(a)||(a=[a]);var c={},d=this;_(a).forEach(function(a){d._add_to_crud(c,"read",a,b)}),d._backend.send(c.read)},update:function(a){var b=this,c=[];return _(a).forEach(function(a){var d=b.liveStorage.getItem(a.id);d?(d.update(a.fields),d._changed={}):d=new b.model(a.fields),c.push(d)}),c},set_field:function(a,b,c){if(void 0!==c){if(this.fields){var d=this.fields[b];d&&(c=d.validate(a,c))}var e=a.get(b);if(c!==e){if(b===this.pkname){if(!c)return;var g=a.cid();a._fields[b]=c,delete a._id,g!==a.cid()&&a.trigger(f,[a,g])}else a._fields[b]=c;return void 0===e?null:e}}},toString:function(){return this.name}}),q=i.extend({new_class:function(a,b){var c={},d=a._meta;d&&d.fields&&(c.fields=_.extend({},d.fields)),d=_.merge(c,o,b.meta),delete b.meta,_(d.fields).forEach(function(a,b){a.name=b});var e=this._super(a,b);return e._meta=e.prototype._meta=new p(e,d),e}}),r=k.extend({Metaclass:q,init:function(a){this._meta.init_instance(this,a)},pk:function(){return this.get(this._meta.pkname)},cid:function(){return this._meta.name+"-"+(this.pk()||this._id)},isNew:function(){return this.pk()?!1:!0},isDeleted:function(){return this._deleted===!0},fields:function(){return this._fields},backend_data:function(){var a={};return _(this._fields).forEach(function(b,c){a[c]=b instanceof Date?.001*b.getTime():b}),a},set:function(a,b){var c=this._meta.set_field(this,a,b);void 0!==c&&(this._changed[a]=c,this.trigger("change",[this,a]))},changedFields:function(a){return a?"string"==typeof a?this._changed[a]:this._changed:this._changed},hasChanged:function(){return _.size(this._changed)>0},get:function(a){return this._fields[a]},update:function(a){if(a===Object(a)){var b=this;_(a).forEach(function(a,c){b.set(c,a)})}},"delete":function(){this._deleted=!0},sync:function(a,b){b=Object(b);var c,d=this.pk();if(this.isDeleted()&&d)b.type=y.delete,b.model={pk:d};else if(d&&this.hasChanged())c=this.backend_data(),delete c[this._meta.pkname],b.type=y.update,b.model={data:c,pk:d};else{if(d)return;if(c=this.backend_data(),!c)return;b.type=y.create,b.model={data:c,cid:this.cid()}}return a.execute(b)},toString:function(){return this.cid()},get_form:function(){},update_form:function(a){_(this.fields()).forEach(function(b,d){var e=a.find("[name="+d+"]");e.length&&c.set_value(e,b)})},set_form_fields:function(a){var b={},c=this;_(a).forEach(function(a){var c=b[a.name];void 0===c?b[a.name]=a.value:$.isArray(c)?c.push(a.value):b[a.name]=[c,a.value]}),_(this._meta.fields).forEach(function(a){var d=a.validate(c,b[a.name]);void 0!==d?b[a.name]=d:delete b[a.name]}),this._fields=b,this.trigger("change",this)}});c.Collection=j.extend({init:function(a,b){var c=this,d=[],e={},f=c.model=a||r.extend({});c.store=B(b),Object.defineProperty(c,"length",{get:function(){return d.length}}),_.extend(c,{at:function(a){var b=d[a];return b?e[b]:void 0},get:function(a){return e[a]},add:function(a,b){var g,h,i=[];return b=Object(b),_.isArray(a)||(a=[a]),_(a).forEach(function(a){a instanceof c.model||(a=new f(a)),h=a.cid(),g=e[h],g?b.merge&&(g.update(a.fields()),g.hasChanged()&&i.push(g)):(e[h]=a,d.push(h),i.push(a))}),i},set:function(a){_(a).forEach(function(a){var b=a.id(),c=e[b];c?c.update(a.fields()):(e[b]=a,d.push(b))})},clear:function(){d=[],e={}},forEach:function(a){for(var b=d.length,c=0;b>c&&a(e[d[c]],c)!==!1;c++);},each:function(a){c.forEach(a)}})},reset:function(a){this.clear(),this.set(a)},fetch:function(a){a=Object(a);var b=this;a.success||a.success||function(a){a=b.parse(a),b.reset(a)},a.meta=this.model._meta,b.store.execute(a)},sync:function(a){a=Object(a);var b,c,d=this,e={},f=a.success,g=a.error;this.forEach(function(a){var d;a.isNew()?(d=y.create,c=a.backend_fields()):mode.isDeleted()?(d=y.delete,c=a.pk()):mode.hasChanged()&&(d=y.update,c=a.backend_fields()),d&&(b=e[d],b||(b=e[d]=[]),b.push(c))});var h=[],i=[];fire=function(){h.length===e.length&&(i.length?g&&g(d,h,i):f&&f(d))},_(e).forEach(function(a,b){d.store.execute({meta:d.model._meta,type:b,data:a,success:function(a){h.push(b);try{d.afterSync(b,a)}finally{fire()}},error:function(){h.push(b),i.push(b),fire()}})})},parse:function(a){return a},toString:function(){return this.model._meta.name+"["+this.length+"]"},afterSync:function(a){a===y.delete||a===y.create||a===y.update}})}c.View=j.extend({remove:function(){return this.elem.remove(),this}}),c.Type=i,c.Class=j,c.EventClass=k,c.Model=r,c.ModelType=q,c.Exception=l,c.ModelException=m,c.NotImplementedError=n;var t={debug:10,info:20,warning:30,error:40,critical:50},u="info",v=c.Logger=j.extend({init:function(a,b){var c=this,d={},e={level:u,formatter:function(a,b){return b+": "+a}};_(t).forEach(function(a,b){c[b]=function(a){c.log(a,b)}}),_.extend(c,{handlers:[],config:function(a){return a=Object(a),a.level&&t[a.level]&&(e.level=a.level),e},getConfig:function(){return e},log:function(a,b){var d=t[b]||0;if(d>t[e.level])for(var f,g=c.getHandlers(),h=0;h<g.length;h++)f=g[h],d>=f.nlevel&&f.log(a,b)},get:function(a){var b=d[a];return b||(b=new v({namespace:a},c),d[a]=b),b},getHandlers:function(){return!c.handler.length&&b?b.getHandlers():c.handlers}}),c.config(a)},addHandler:function(a,b){b=b||new w,b.config(_.extend({},this.getConfig(),a)),this.handler.push(b)}}),w=c.LogHandler=j.extend({config:function(a){_.extend(this,a),this.nlevel=t[this.level]||0},log:function(a,b){console.log(this.format_message(a,b))}}),x=(c.HtmlLogHandler=w.extend({init:function(a){this.elem=$(a),this.elem.addClass("lux-logger")},log:function(a,b){a=this.format_message(a,b),a='<pre class="'+b+'">'+a+"</pre>",self.elem.prepend(a)}}),new v);c.getLogger=function(a,b){var c=x;return a&&_.each(a.split("."),function(a){c=c.get(a)}),b&&c.config(b),c};var y={create:"create",read:"read",update:"update","delete":"delete"},z=(c.CrudMethod={create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},{}),A=c.register_store=function(a,b){z[a]=b},B=c.create_store=function(a,b){if(a instanceof C)return a;if(_.isString(a)){var c=a.search("://");if(c>-1){var d=a.substr(0,c),e=z[d];if(e)return new e(a,b,d)}}return new C(a,b,"dummy")},C=c.Backend=c.Class.extend({options:{dataType:"json"},init:function(a,b,c){this.type=c,this.url=a,this.options=_.merge({},this.options,b)},execute:function(a){a.success&&a.success([])},toString:function(){return this.type+" "+this.url}}),D=c.Backend.extend({init:function(a,b){this._super(a,b,"ajax")},execute:function(a){var b=this.url,d=a.model;a.type=c.CrudMethod[a.type]||s.type||"GET",d&&(delete a.model,d.pk&&(b=c.utils.urljoin(b,pk)),a.data=d.data),$.ajax(b,a)}});A("http",D),A("https",D);var E=c.Backend.extend({options:{resource:null,reconnecting:1,hartbeat:5,maxDelay:3600,maxRetries:null,factor:2.718281828459045,jitters:0,jitter:.11962656472},init:function(a,b){var c=this;a=this.websocket_uri(a),this._super(a,b,"websocket"),this._retries=0,this._transport=null,this._opened=!1,this._pending_messages={},this._delay=this.options.reconnecting,this._queue=[],c.connect()},opened:function(){return this._opened},connect:function(){var a=this.options,b=this.url,c=this;a.resource&&(b+=a.resource),x.info("Connecting with "+c),this._transport=new WebSocket(b),this._transport.onopen=function(){c.onopen()},this._transport.onmessage=function(a){"message"===a.type&&c.onmessage(a)},this._transport.onclose=function(){c.onclose()}},onopen:function(){if(this._opened=!0,x.info(this+" opened."),this.options.onopen&&this.options.onopen.call(this),this._queue){var a=this._queue;this._queue=[],_(a).forEach(function(a){this._transport.send(a)},this)}},reconnect:function(){var a=this.options,b=this;return this._delay?(this._retries+=1,null!==a.maxRetries&&this._retries>a.maxRetries?void J.logger.info("Exiting websocket after "+this.retries+" retries."):(this._delay=Math.min(this._delay*a.factor,a.maxDelay),a.jitter&&(this._delay=c.math.normalvariate(this._delay,this._delay*a.jitter)),J.logger.info("Try to reconnect websocket in "+this._delay+" seconds"),this.trigger("reconnecting",this._delay),void(this._reconnect=c.eventloop.call_later(this._delay,function(){b._reconnect=null,b.connect()})))):void J.logger.info("Exiting websocket")},execute:function(a){if(!a.beforeSend||a.beforeSend.call(a,this)!==!1){var b={mid:this.new_mid(a),action:a.action||c.CrudMethod[a.type]||a.type,model:a.model,data:a.data};b=JSON.stringify(b),this._opened?this._transport.send(b):this._queue.push(b)}},onmessage:function(a){var b=JSON.parse(a.data),c=b.mid,d=c?this._pending_messages[c]:void 0;return d?(delete this._pending_messages[c],b.error?d.error?d.error(b.error,this,b):b:d.success?d.success(b.data,this,b):b):void J.logger.error("No message")},onclose:function(){this._opened=!1,x.warning(this+" closed."),this.reconnect()},new_mid:function(a){if(a.success||a.error){for(var b=c.s4();this._pending_messages[b];)b=c.s4();return this._pending_messages[b]=a,b}},websocket_uri:function(a){var b=window.location;if(a||(a=b.href.split("?")[0]),"http://"===a.substring(0,7))return"ws://"+a.substring(7);if("https://"===a.substring(0,8))return"wss://"+a.substring(8);if("ws://"===a.substring(0,5)||"wss://"===a.substring(0,6))return a;var d="http:"===b.protocol?"ws:":"wss:";return c.utils.urljoin(d,b.host,b.pathname,a)}});A("ws",E),A("wss",E);var F="ABCDEFGHIJKLMNOPQRSTUVWXYZ";c.num_to_letter=function(a){for(var b=F.length,c="";a>=b;){var d=a%b;a=Math.floor(a/b),c+=F[d]}return c+=F[a]},c.Ordered=j.extend({init:function(){this.all={},this.order=[]},set:function(a,b){this.all[a]?this.all[a]=b:a&&(this.order.push(a),this.all[a]=b)},get:function(a){return this.all[a]},at:function(a){return a<this.order.length?this.all[this.order[a]]:void 0},size:function(){return this.order.length},each:function(a,b){_(this.order).forEach(function(c,d){a.call(b,this.all[c],c,d)},this)},ordered:function(){var a=[];return _(this.order).forEach(function(b){a.push(this.all[b])},this),a}});var G=32,H=c.SkipList=function(b,c){b=Math.min(G,Math.max(8,b?b:G));var d,e=function(a){for(var c=[],d=b;d--;)c.push(a);return c},f=Math.log(2),g=0,h=new a("HEAD",null,new Array(b),e(1)),i=1;Object.defineProperty(this,"length",{get:function(){return g}}),Object.defineProperty(this,"levels",{get:function(){return levels}}),_.extend(this,{insert:function(j,k){var l,m,n=new Array(b),o=e(0),p=h;for(d=i-1;d>=0;d--){for(o[d]=d===i-1?0:o[d+1];p.next[d]&&p.next[d].key<=j;)o[d]+=p.width[d],p=p.next[d];n[d]=p}if(n[0].key===j&&c)return g;var q=Math.min(b,1-Math.round(Math.log(Math.random())/f));if(q>i){for(d=i;q>d;d++)o[d]=0,n[d]=h,n[d].width[d]=g;i=q}for(p=new a(j,k,new Array(b),new Array(b)),d=0;q>d;d++)l=n[d],m=o[0]-o[d],p.next[d]=l.next[d],p.width[d]=l.width[d]-m,l.next[d]=p,l.width[d]=m+1;for(d=q;i>d;d++)n[d].width[d]+=1;return g+=1},forEach:function(a){for(var b=h.next[0];b;)a(b.value,b.score),b=b.next[0]}})},I=[],J=c.web={options:{debug:!1,skins:[],media_url:"/media/",icon:"fontawesome"},extension_list:[],extensions:{},libraries:[],extension:function(a,b){return c.$?(b=this.create_extension(a,b),this.extension_list.push(b),this.extensions[a]=b,b):void I.push({name:a,ext:b})},ready:function(a,b){c.$&&(void 0===b?a():require(a,b))},refresh:function(a){return _(this.extension_list).forEach(function(b){b.refresh(a)}),a},add_lib:function(a){_.contains(this.libraries,a.name)||this.libraries.push(a)}};c.init_web=function(){c.$=$,$(document).ready(function(){var a=$(this),b=a.find("html").data()||{};J.options=_.extend(J.options,b),J.options.debug&&(x.config({level:"debug"}),x.handlers.length||x.addHandler()),J.element=a;var c=I;I=[],_(c).forEach(function(a){J.extension(a.name,a.ext)}),J.refresh(a)})},c.set_value_hooks=[],c.set_value=function(a,b){for(var d=0;d<c.set_value_hooks.length;d++)if(c.set_value_hooks[d](a,b))return;a.val(b)},J.ExtInstance=c.Class.extend({selector:null,defaultElement:null,options:{fade:{duration:200}},init:function(a,b,c){this._id=a,this._element=b,this.options=_.merge({},this.options,c)},toString:function(){return this._id},element:function(){return this._element},container:function(){return this._element},id:function(){return this._id},lux_id:function(){return this._id},extension:function(){return this.constructor},destroy:function(){return this.constructor.destroy(this)},decorate:function(){},fadeIn:function(a){var b=this;b._element.fadeIn({duration:this.options.fade.duration,complete:function(){a&&a(b),b._element.trigger("show",b)}})},fadeOut:function(a){var b=this;b._element.fadeOut({duration:this.options.fade.duration,complete:function(){a&&a(b),b._element.trigger("hide",b)}})},get_skin:function(a){return J.get_skin(a?a:this.element())}}),J.create_extension=function(a,b,c){var d=[],e=a+"-",f="lux-"+a+"-id",g=0,h=function(){return g+=1,e+g};c=c?c:J.ExtInstance,b.options=_.merge({},c.prototype.options,b.options),b.name=a;var i=c.extend(b);return i.instance=function(b){if(b){b=b.lux_id?b.lux_id():b;var c,e=d[b];return e||(c=$(b),c.length||"string"!=typeof b||(c=$("#"+b)),e=c.length?d[c.closest("."+a).data(f)]||null:null),e}return null},i.create=function(c,e){var f=this.instance(c);if(null!==f)return f;if(c=$(c),0===c.length)c=$(document.createElement(b.defaultElement));else{var g=c.data(a)||c.data();e=e?_.extend(e,g):g}h();return f=new i(h(),c,e),d[f.id()]=f,f.decorate(),f},i.destroy=function(a){if(a=this.instance(a)){delete d[a.id()];var b=a.container();b&&(b.trigger("remove",a),b.detach().trigger("removed",a),b.remove())}},i.toString=function(){return a},i.refresh=function(b){var c=[];if(i.prototype.selector){var d=$(i.prototype.selector,b);d.length&&(x.info("Apply extension "+a+" to "+d.length+" elements"),d.each(function(){c.push(i.create(this))}))}return c},i.prototype.defaultElement&&(J[i.prototype.name]=function(a,b){var c=a;return(!a||$.isPlainObject(a))&&(c=null,b=a),i.create(c,b)}),i},J.add_lib({name:"RequireJs",web:"http://requirejs.org/",version:require.version}),J.add_lib({name:"Lo-Dash",web:"http://lodash.com/",version:_.VERSION}),J.add_lib({name:"jQuery",web:"http://jquery.com/",version:$.fn.jquery});var K=l.extend({name:"StopIteration"}),L=j.extend({init:function(a,b,c){this.deadline=a,this.cancelled=!1,this.callback=b,this.args=c},cancel:function(){this.cancelled=!0},reschedule:function(a){this._deadline=a,this._cancelled=!1}}),M=j.extend({init:function(a,b,c,d){var e,f=this,g=!1;this.callback=b,this.args=c;var h=function(){try{this.callback.call(this,f.args)}catch(a){return void f.cancel()}i()},i=function(){g||(d?(e.reschedule(a.time()+d),a.scheduled.insert(e.deadline,e)):a.callbacks.append(e))};d&&d>0?(d=d,e=a.call_later(d,h)):(d=null,e=a.call_soon(h)),_.extend(this,{get cancelled(){return g},cancel:function(){g=!0}})}}),N=c.EventLoop=j.extend({init:function(){var a=[],b=new H,c=!1,e=window.requestAnimationFrame,f=function(){var b=(this.time(),a.splice(0));_(b).forEach(function(a){a.cancelled||a.callback(a.args.splice(0))})},g=function(a){if(c){try{f(a)}catch(b){if("StopIteration"===b.name)return void(c=!1)}c&&e(g)}};_.extend(this,{get callbacks(){return a},get scheduled(){return b},call_soon:function(b){var c=new L(null,b,d(arguments,1));return a.append(c),c},call_later:function(a,c){var e=d.call(arguments,2),f=new L(this.time()+a,c,e);return b.insert(f.deadline,f),f},call_at:function(a,c){var e=d.call(arguments,2),f=new L(a,c,e);return b.insert(f.deadline,f),f},run:function(){c||(c=!0,e(g))},is_running:function(){return c}})},call_every:function(a){return new M(this,a,d(arguments,1))},time:function(){return(new Date).getTime()},stop:function(a){this.is_running()?this.call_soon(function(){if(a)try{a()}catch(b){console.log(b)}throw new K}):a&&a()}});c.eventloop=new N;c.each;c.utils={detector:{canvas:!!window.CanvasRenderingContext2D,workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob},allClasses:function(a){var b={},c=[];return $(a).each(function(){this.className&&$.each(this.className.split(" "),function(){var a=this;""!==a&&void 0===b[a]&&(b[a]=a,c.push(a))})}),c},as_tag:function(a,b){var c=$(b);return c.length||"string"!=typeof b?c.length?(c.is(a)||(c=$("<"+a+">").append(c)),c):void 0:$("<"+a+">").html(b)},closest_color:function(a,b){var c=null;for(a=$(a);a.length&&null===c;)a=a.parent(),c=a.css(b),("inherit"==c||"transparent"==c)&&(c=null);return c},urljoin:function(){var a=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},b=[].slice.call(arguments,0).join("/");return a(b)},prettyTime:function(a){var b=Math.floor(a/86400);return 0===b&&(2>a&&"1 second ago"||60>a&&Math.floor(a)+" seconds ago"||120>a&&"1 minute ago"||3600>a&&Math.floor(a/60)+" minutes ago"||7200>a&&"1 hour ago"||86400>a&&Math.floor(a/3600)+" hours ago")||1===b&&"Yesterday"||7>b&&b+" days ago"||31>b&&Math.ceil(b/7)+" weeks ago"},asDate:function(a){if(a instanceof Date)return a;var b=parseFloat(a);if(b===b)return new Date(1e3*b);throw new TypeError("Could not convert "+a+" to a date")}};var O={},P=Math.PI;c.math=O,$.extend(O,{point2d:function(a,b){return{x:a,y:b}},distance2d:function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))},angle2d:function(a,b,c,d,e,f){var g=a-c,h=b-d,i=e-c,j=f-d,k=Math.atan2(g,h),l=Math.atan2(i,j);return k-l},degree:function(a){return 180*a/P},radians:function(a){return P*a/180}});var Q=Math.random,R=Math.log,S=4*Math.exp(-.5)/Math.sqrt(2);$.extend(O,{normalvariate:function(a,b){for(var c,d,e,f;;)if(c=Q(),d=1-Q(),e=S*(c-.5)/d,f=e*e/4,f<=-R(d))break;return a+e*b}})});