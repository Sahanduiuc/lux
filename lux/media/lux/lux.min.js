define(["lodash","jquery"],function(a,b){"use strict";function c(a,b,c,d){this.key=a,this.value=b,this.next=c,this.width=d}var d=window,e=d.lux,f=Array.prototype.slice;lux=d.lux={debug:!1,skins:[],libraries:[],media_url:"/media/",icon:"fontawesome",data_api:!0,set_value_hooks:[],setValue:function(a,b){for(var c=0;c<lux.set_value_hooks.length;c++)if(lux.set_value_hooks[c](a,b))return;a.val(b)},addLib:function(b){a.contains(lux.libraries,b.name)||lux.libraries.push(b)},s4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){var a=lux.s4;return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},isnothing:function(a){return void 0===a||null===a},sorted:function(b,c){var d=[];a(b).forEch(function(a,b){d.push(b)}),d.sort(),a(d).forEach(function(a){c(b[a],a)})},niceStr:function(a){return a.capitalize().replace("_"," ")}},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},lux.addLib({name:"RequireJs",web:"http://requirejs.org/",version:require.version}),lux.addLib({name:"Lo-Dash",web:"http://lodash.com/",version:a.VERSION}),lux.addLib({name:"jQuery",web:"http://jquery.com/",version:b.fn.jquery});{var g=/xyz/.test(function(){})?/\b_super\b/:/.*/,h=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&g.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},i=lux.Type=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var g in b)"Metaclass"!==g&&(f[g]=h.call(a,c,g,b[g],e));if(d){for(g in e)void 0===f[g]&&(f[g]=e[g]);return f}var i=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return i.prototype=f,i.prototype.constructor=i,i.extend=a.extend,i},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),j=lux.Class=function(a){return a.__class__=i,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),k=j.extend({bindToElement:function(a){this._jquery_element=a},trigger:function(b,c){c?(a.isArray(c)||(c=[c]),c.splice(0,0,this)):c=[this],this.jElem().trigger(b,c)},on:function(a,b){this.jElem().on(a,b,f.call(arguments,2))},jElem:function(){return this._jquery_element?this._jquery_element:b(window)}}),l=j.extend({name:"Exception",init:function(a){this.message=a||""},toString:function(){return this.name+": "+this.message}}),m=l.extend({name:"ModelException"}),n=l.extend({name:"NotImplementedError"}),o={pkname:"id",name:"model",defaults:{}},p=lux.Meta=j.extend({init:function(b,c){this.model=b,a.extend(this,c),this.title=this.title||this.name},init_instance:function(b,c){b._fields={},b._changed={},b.cid=a.uniqueId("model"),c===Object(c)&&a(c).forEach(function(a,c){this.set_field(b,c,a,!0)},this)},get:function(c,d){if(!this._backend)throw new m("Cannot sync "+this+". No backend registered.");d||(d={}),b.isArray(c)||(c=[c]);var e={},f=this;a(c).forEach(function(a){f._add_to_crud(e,"read",a,d)}),f._backend.send(e.read)},update:function(b){var c=this,d=[];return a(b).forEach(function(a){var b=c.liveStorage.getItem(a.id);b?(b.update(a.fields),b._changed={}):b=new c.model(a.fields),d.push(b)}),d},set_field:function(b,c,d,e){if(void 0!==d){if(this.fields){var f=this.fields[c];if(f)d=f.validate(b,d);else if(null===f)return void(b[c]=d)}if(!e){var g=b.get(c);if(a.isEqual(d,g))return;return b._fields[c]=d,void 0===g?null:g}b._fields[c]=d}},toString:function(){return this.name}}),q=lux.ModelType=i.extend({new_class:function(b,c){c||(c={});var d=b._meta,e=a.merge({},o,c.meta);d&&d.fields&&(e.fields=this.mergeFields([d.fields,e.fields]));var f=this._super(b,c);return f._meta=f.prototype._meta=new p(f,e),f},mergeFields:function(b){var c={},d=[],e=[];return a(b).forEach(function(b){a(b).forEach(function(a){c[a.name]?c[a.name]=a:(c[a.name]=a,d.push(a.name))})}),a(d).forEach(function(a){e.push(c[a])}),e}}),r=lux.Model=k.extend({Metaclass:q,init:function(a){this._meta.init_instance(this,a)},pk:function(){return this.get(this._meta.pkname)},isNew:function(){return this.pk()?!1:!0},isDeleted:function(){return this._deleted===!0},fields:function(){return this._fields},toJSON:function(b){var c={},d=this._fields,e=d;return b&&!this.isNew()&&(e=this._changed),a(e).forEach(function(a,b){a=d[b],c[b]=a instanceof Date?.001*a.getTime():a}),c},set:function(a,b){var c=this._meta.set_field(this,a,b);void 0!==c&&(this._changed[a]=c,this.trigger("change",[this,a]))},changedFields:function(a){return a?"string"==typeof a?this._changed[a]:this._changed:this._changed},hasChanged:function(){return a.size(this._changed)>0},previous:function(a){return this._changed[a]},get:function(a){return this._fields[a]},update:function(b){if(b===Object(b)){var c=this;a(b).forEach(function(a,b){c.set(b,a)})}},"delete":function(){this._deleted=!0},sync:function(a,b){b||(b={});var c=b.success,d=this._sync_data(b),e=this;return d?(d.model=this._meta.name,d.success=function(a,b,d){e.sync_callback(a,b,d),c&&c(e)},a.execute(d)):void(c&&c(e))},sync_callback:function(a,b,c){200===c.status||201===c.status?(this._changed={},this.update(a)):c.crud===C.delete?this.trigger("deleted"):B.warning("Could not understand response")},toString:function(){return this._meta.name+"-"+this.cid},getForm:function(a){a||(a={}),a.model=this;var b=new S(a);return b.setFields(this._meta.fields),a.callback&&a.callback(b),b},updateForm:function(b){a(this.fields()).forEach(function(a,c){var d=b.find("[name="+c+"]");d.length&&lux.setValue(d,a)})},replace:function(b){var c=this;a(this._fields).forEach(function(a,d){void 0===b[d]&&(delete c._fields[d],c.trigger("change",d))}),this.update(b)},_sync_data:function(b){b||(b={});var c=this.pk();if(this.isDeleted()&&c)b.crud=C.delete,b.item={pk:c};else if(c&&this.hasChanged())b.crud=C.update,b.item={pk:c,data:this.toJSON()};else{if(c)return;var d=this.toJSON();if(!a.size(d))return;b.crud=C.create,b.item={data:d}}return b}});lux.Collection=j.extend({init:function(b,c){var d=this,e=[],f={},g=d.model=b||r.extend({});d.store=F(c),Object.defineProperty(d,"length",{get:function(){return e.length}}),a.extend(d,{at:function(a){var b=e[a];return b?f[b]:void 0},get:function(a){return f[a]},add:function(b,c){var d,h=[];return c||(c={}),a.isArray(b)||(b=[b]),a(b).forEach(function(a){a instanceof g||(a=new g(a)),d=f[a.cid],d?c.merge&&(d.update(a.fields()),d.hasChanged()&&h.push(d)):(f[a.cid]=a,e.push(a.cid),h.push(a))}),h},set:function(b){a(b).forEach(function(a){var b=a.id(),c=f[b];c?c.update(a.fields()):(f[b]=a,e.push(b))})},clear:function(){e=[],f={}},forEach:function(a){for(var b=e.length,c=0;b>c&&a(f[e[c]],c)!==!1;c++);},each:function(a){d.forEach(a)}})},reset:function(a){this.clear(),this.set(a)},fetch:function(a){a||(a={});var b=this;a.success||a.success||function(a){a=b.parse(a),b.reset(a)},a.meta=this.model._meta,b.store.execute(a)},sync:function(a){a||(a={});{var b=this.store;a.success,a.error}this.forEach(function(c){c.sync(b,a)})},parse:function(a){return a},toString:function(){return this.model._meta.name+"["+this.length+"]"},afterSync:function(a){a===C.delete||a===C.create||a===C.update}})}lux.EventClass=k,lux.Exception=l,lux.ModelException=m,lux.NotImplementedError=n;var s=lux.autoViews=[],t=lux.SKIN_NAMES=["default","primary","success","inverse","error"],u=(lux.getSkin=function(a,b){if(a){b=b?b+"-":"";for(var c=0;c<t.length;c++){var d=t[c];if(a.hasClass(b+d))return d}}},lux.setSkin=function(b,c,d){t.indexOf(c)>-1&&(d=d?d+"-":"",a(t).forEach(function(a){b.removeClass(d+a)}),b.addClass(d+c))},/^(\S+)\s*(.*)$/),v=["model","collection","elem","id","attributes","className","tagName","name","events"],w=lux.View=j.extend({tagName:"div",defaults:null,init:function(c){this.cid=a.uniqueId("view"),c||(c={}),this.defaults&&(c=a.extend({},this.defaults,c)),a.extend(this,a.pick(c,v)),this.elem?(this.elem=b(a.result(this,"elem")),this.setElement(this.elem,!1)):this.setElement(b(document.createElement(this.tagName)),!1),this.instance_key&&this.elem.data(this.instance_key,this),this.initialise(c)},initialise:function(){},remove:function(){return this.elem.remove(),this},delegateEvents:function(b){if(b=b||this.events,!b)return this;this.undelegateEvents();for(var c in b){var d=b[c];if(a.isFunction(d)||(d=this[d]),d){var e=c.match(u),f=e[1],g=e[2];d=a.bind(d,this),f+=".delegateEvents"+this.cid,""===g?this.elem.on(f,d):this.elem.on(f,g,d)}}return this},undelegateEvents:function(){return this.elem.off(".delegateEvents"+this.cid),this},render:function(){return this},setElement:function(a,c){return this.elem&&this.undelegateEvents(),this.elem=b(a),c!==!1&&this.delegateEvents(),this},show:function(){this.elem.show(),this.elem.trigger("show",this)},hide:function(){this.elem.hide(),this.elem.trigger("hide",this)},fadeIn:function(a){if(a||(a={}),!a.complete){var b=this;a.complete=function(){b.show()}}this.elem.fadeIn(a)},fadeOut:function(a){if(a||(a={}),!a.complete){var b=this;a.complete=function(){b.hide()}}this.elem.fadeOut(a)},getSkin:function(a){return lux.getSkin(this.elem,a||this.className)},setSkin:function(a,b){lux.setSkin(this.elem,a,b||this.className)},eventName:function(a){var b=this.instance_key?this.instance_key:"view";return a+".lux."+b},enforceFocus:function(){var a=this.eventName("focusin"),c=this;b(document).off(a).on(a,function(a){c.elem[0]===a.target||c.elem.has(a.target).length||c.elem.trigger("focus")})},addStyle:function(a,c){if(a.length){var d,e=b("head");c&&(d=e.find("#"+c),d.length||(d=null)),d||(d=b("<style type='text/css' rel='stylesheet' />").appendTo(e).attr("id",c),d[0].styleSheet?d[0].styleSheet.cssText=a.join("\n"):d[0].appendChild(document.createTextNode(a.join("\n"))))}}});lux.createView=function(c,d,e){var f=d.jQuery,g=c+"-view";delete d.jQuery,d.name=c,d.instance_key=g,e=e||w;var h=e.extend(d),i=h.prototype,j=function(b,c,d){var e=b.data(g);if(!e){if(c||(c={}),lux.data_api){var f=b.data();a.forEach(f,function(a,b){""===a&&(f[b]=!0)}),c=a.extend({},f,c)}c.elem=b,e=new h(c),d&&e.render()}return e};return h.getInstance=function(a){return a.data(g)},f&&(b.fn[c]=function(a){return"instance"===a?this.data(g):j(this,a).elem}),i.selector&&s.push({selector:i.selector,load:function(a){j(b(a),null,!0)}}),h},lux.loadViews=function(c){c=b(c||document),a(s).forEach(function(a){b(a.selector,c).each(function(){a.load(this)})})},lux.initWeb=function(){b(document).ready(function(){var c=b(this),d=c.find("html").data()||{},e=c.find("body");a.extend(lux,d),lux.debug&&(B.config({level:"debug"}),B.handlers.length||B.addHandler()),e.css({opacity:0});try{lux.loadViews(c),e.fadeIn(100)}finally{e.css({opacity:1})}})};var x={debug:10,info:20,warning:30,error:40,critical:50},y="info",z=lux.Logger=j.extend({init:function(b,c){var d=this,e={},f={level:y,formatter:function(a,b){return b+": "+a}};a(x).forEach(function(a,b){d[b]=function(a){d.log(a,b)}}),a.extend(d,{handlers:[],config:function(a){return a=Object(a),a.level&&x[a.level]&&(f.level=a.level),f},getConfig:function(){return f},log:function(a,b){var c=x[b]||0;if(c>x[f.level])for(var e,g=d.getHandlers(),h=0;h<g.length;h++)e=g[h],c>=e.nlevel&&e.log(a,b)},get:function(a){var b=e[a];return b||(b=new z({namespace:a},d),e[a]=b),b},getHandlers:function(){return!d.handlers.length&&c?c.getHandlers():d.handlers}}),d.config(b)},addHandler:function(b,c){c=c||new A,c.config(a.extend({},this.getConfig(),b)),this.handlers.push(c)}}),A=lux.LogHandler=j.extend({config:function(b){a.extend(this,b),this.nlevel=x[this.level]||0},log:function(a,b){console.log(this.formatter(a,b))}}),B=(lux.HtmlLogHandler=A.extend({init:function(a){this.elem=b(a),this.elem.addClass("lux-logger")},log:function(a,b){a=this.formatter(a,b),a='<pre class="'+b+'">'+a+"</pre>",this.elem.prepend(a)}}),new z);lux.getLogger=function(b,c){var d=B;return b&&a.each(b.split("."),function(a){d=d.get(a)}),c&&d.config(c),d};var C={create:"create",read:"read",update:"update","delete":"delete"},D=(lux.CrudMethod={create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},{}),E=lux.register_store=function(a,b){D[a]=b},F=lux.create_store=function(b,c){if(b instanceof G)return b;if(a.isString(b)){var d=b.search("://"),e=-1===d?"http":b.substr(0,d),f=D[e];if(f&&b)return new f(b,c,e)}return new G(b,c,"dummy")},G=lux.Backend=lux.Class.extend({options:{dataType:"json"},init:function(b,c,d){this.type=d,this.url=b,this.options=a.merge({},this.options,c)},execute:function(a){a.success&&a.success([])},toString:function(){return this.type+" "+this.url}}),H=lux.Backend.extend({init:function(a,b){this._super(a,b,"ajax")},execute:function(a){var c=this.url,d=(a.model,a.item);delete a.model,a.type=lux.CrudMethod[a.crud]||a.type||"GET",d&&(delete a.item,d.pk&&(c=lux.utils.urljoin(c,d.pk)),a.data=d.data),b.ajax(c,a)}});E("http",H),E("https",H);var I=lux.Backend.extend({options:{resource:null,reconnecting:1,hartbeat:5,maxDelay:3600,maxRetries:null,factor:2.718281828459045,jitters:0,jitter:.11962656472},init:function(a,b){var c=this;a=this.websocket_uri(a),this._super(a,b,"websocket"),this._retries=0,this._transport=null,this._opened=!1,this._pending_messages={},this._delay=this.options.reconnecting,this._queue=[],c.connect()},opened:function(){return this._opened},connect:function(){var a=this.options,b=this.url,c=this;a.resource&&(b+=a.resource),B.info("Connecting with "+c),this._transport=new WebSocket(b),this._transport.onopen=function(){c.onopen()},this._transport.onmessage=function(a){"message"===a.type&&c.onmessage(a)},this._transport.onclose=function(){c.onclose()}},onopen:function(){if(this._opened=!0,B.info(this+" opened."),this.options.onopen&&this.options.onopen.call(this),this._queue){var b=this._queue;this._queue=[],a(b).forEach(function(a){this._transport.send(a)},this)}},reconnect:function(){var a=this.options,b=this;return this._delay?(this._retries+=1,null!==a.maxRetries&&this._retries>a.maxRetries?void B.info("Exiting websocket after "+this.retries+" retries."):(this._delay=Math.min(this._delay*a.factor,a.maxDelay),a.jitter&&(this._delay=lux.math.normalvariate(this._delay,this._delay*a.jitter)),B.info("Try to reconnect websocket in "+this._delay+" seconds"),this.trigger("reconnecting",this._delay),void(this._reconnect=lux.eventloop.call_later(this._delay,function(){b._reconnect=null,b.connect()})))):void B.info("Exiting websocket")},execute:function(b){if(!b.beforeSend||b.beforeSend.call(b,this)!==!1){var c={mid:this.new_mid(b),action:b.action||lux.CrudMethod[b.crud]||b.crud,model:b.model};b.item?a.extend(c,b.item):c.data=b.data,c=JSON.stringify(c),this._opened?this._transport.send(c):this._queue.push(c)}},onmessage:function(a){var b=JSON.parse(a.data),c=b.mid,d=c?this._pending_messages[c]:void 0,e=b.data;b.response=a,b.backend=this,d&&delete this._pending_messages[c],b.error?d&&d.error?d.error(b,"error",b.error):B.error(this.toString()+" - "+b.error):d&&d.success?d.success(e,"success",b):B.warning(this.toString()+" - Got message with no callback registered")},onclose:function(){this._opened=!1,B.warning(this+" closed."),this.reconnect()},new_mid:function(b){if(b.success||b.error){var c=a.uniqueId("ws-message");return this._pending_messages[c]=b,c}},websocket_uri:function(a){var b=window.location;if(a||(a=b.href.split("?")[0]),"http://"===a.substring(0,7))return"ws://"+a.substring(7);if("https://"===a.substring(0,8))return"wss://"+a.substring(8);if("ws://"===a.substring(0,5)||"wss://"===a.substring(0,6))return a;var c="http:"===b.protocol?"ws:":"wss:";return lux.utils.urljoin(c,b.host,b.pathname,a)}});E("ws",I),E("wss",I);var J="ABCDEFGHIJKLMNOPQRSTUVWXYZ";lux.num_to_letter=function(a){for(var b=J.length,c="";a>=b;){var d=a%b;a=Math.floor(a/b),c+=J[d]}return c+=J[a]},lux.fields_from_array=function(b){var c={};return a(b).forEach(function(b){var d=c[b.name];void 0===d?c[b.name]=b.value:a.isArray(d)?d.push(b.value):c[b.name]=[d,b.value]}),c},lux.Ordered=j.extend({init:function(){this.all={},this.order=[]},set:function(a,b){this.all[a]?this.all[a]=b:a&&(this.order.push(a),this.all[a]=b)},get:function(a){return this.all[a]},at:function(a){return a<this.order.length?this.all[this.order[a]]:void 0},size:function(){return this.order.length},each:function(b,c){a(this.order).forEach(function(a,d){b.call(c,this.all[a],a,d)},this)},ordered:function(){var b=[];return a(this.order).forEach(function(a){b.push(this.all[a])},this),b}});{var K=32,L=lux.SkipList=function(b,d){b=Math.min(K,Math.max(8,b?b:K));var e,f=function(a){for(var c=[],d=b;d--;)c.push(a);return c},g=Math.log(2),h=0,i=new c("HEAD",null,new Array(b),f(1)),j=1;Object.defineProperty(this,"length",{get:function(){return h}}),Object.defineProperty(this,"levels",{get:function(){return levels}}),a.extend(this,{insert:function(a,k){var l,m,n=new Array(b),o=f(0),p=i;for(e=j-1;e>=0;e--){for(o[e]=e===j-1?0:o[e+1];p.next[e]&&p.next[e].key<=a;)o[e]+=p.width[e],p=p.next[e];n[e]=p}if(n[0].key===a&&d)return h;var q=Math.min(b,1-Math.round(Math.log(Math.random())/g));if(q>j){for(e=j;q>e;e++)o[e]=0,n[e]=i,n[e].width[e]=h;j=q}for(p=new c(a,k,new Array(b),new Array(b)),e=0;q>e;e++)l=n[e],m=o[0]-o[e],p.next[e]=l.next[e],p.width[e]=l.width[e]-m,l.next[e]=p,l.width[e]=m+1;for(e=q;j>e;e++)n[e].width[e]+=1;return h+=1},forEach:function(a){for(var b=i.next[0];b;)a(b.value,b.score),b=b.next[0]}})};lux.DragDrop=lux.Class.extend({defaults:{opacity:.6,over_class:"over",dropzone:null,placeholder:null,dummy:"droppable-dummy",dummy_heigh:30,onStart:function(){},onDrag:function(){},onDrop:function(){}},init:function(c){this.options=c=a.extend({},this.defaults,c),this.candrag=!1;var d=this,e=(c.dropzone,c.dummy);this.placeholder(this.options.placeholder);var f=b(document),g=c.dropzone;"string"!=typeof g?(f=b(c.dropzone),g=null):e&&(g+=", ."+e,this.dummy=b(document.createElement("div")).addClass(e).css("height",c.dummy_heigh)),f.on("dragenter",g,function(a){d.e_dragenter(this,a)}).on("dragover",g,function(a){return a.preventDefault(),d.e_dragover(this,a),!1}).on("dragleave",g,function(a){d.e_dragleave(this,a)}).on("drop",g,function(a){return d.e_drop(this,a),!1})},placeholder:function(a){if(a){this._placeholder=b(a===!0?document.createElement("div"):a);var c=this;this._placeholder.addClass("draggable-placeholder").unbind("dragover").unbind("drop").bind("dragover",function(a){return a.preventDefault(),!1}).bind("drop",function(a){return c.e_drop(this,a),!1})}else this._placeholder=null},add:function(a,c){var d=this,e=b(document),f=a,g=c,h=!0;"string"!=typeof a?(e=b(a).attr("draggable",!0),c=c?b(c):e,f=g=null,h=!1):c=e,c.on("mouseenter",g,function(){b(this).addClass("draggable")}).on("mouseleave",g,function(){b(this).removeClass("draggable")}).on("mousedown",g,function(){d.candrag=!0,a=h?b(this).closest(f).attr("draggable",!0):e,a.attr("id")||a.attr("id",lux.s4())}),e.on("dragstart",f,function(a){return d.candrag&&d.options.onStart.call(this,a,d)!==!1?(B.debug("Start dragging "+this.id),d.e_dragstart(this,a)):void a.preventDefault()}).on("dragend",f,function(a){return B.debug("Ended dragging "+this.id),d.candrag=!1,d.e_dragend(this,a)}).on("drag",f,function(a){d.options.onDrag.call(this,a,d)})},reposition:function(a,b,c){var d=b.originalEvent.clientX-c.left,e=b.originalEvent.clientY-c.top;a.css({top:e,left:d})},moveElement:function(a,c){if(a=b(a),c=b(c),a[0]!==c[0]){var d=a.parent(),e=c.parent();this._placeholder?this._placeholder.after(a).detach():this.move(a,c,d,e),this.dummy&&d[0]!==e[0]&&(d.children().length||d.append(this.dummy),e.children("."+this.options.dummy).length&&this.dummy.detach())}},move:function(a,b,c,d,e){if(e||(e=a),b.prev().length){if(c[0]===d[0])for(var f=b.nextAll(),g=0;g<f.length;g++)if(f[g]===a[0])return void b.before(e);b.after(e)}else b.before(e)},swapElements:function(a,c){if(a=b(a),c=b(c),a[0]!==c[0]){var d=a.next(),e=a.parent(),f=c.next(),g=c.parent(),h=function(a,b,c){b.length?b.before(a):c.append(a)};h(c,d,e),h(a,f,g)}},e_dragstart:function(a,c){a=b(a);var d=c.originalEvent.dataTransfer,e=a.position(),f=c.originalEvent.clientX-e.left,g=c.originalEvent.clientY-e.top;if(d.effectAllowed="move",d.setData("text/plain",a[0].id+","+f+","+g),a.fadeTo(10,this.options.opacity),this._placeholder){var h=Math.min(a.height(),400);this._placeholder.height(h)}},e_dragend:function(a){this._placeholder&&this._placeholder.detach(),b(a).fadeTo(10,1)},e_dragenter:function(a,c){var d=c.originalEvent.dataTransfer,e=this.options,f=d.getData("text/plain").split(",")[0];if(a=b(a).addClass(e.over_class),a[0].id!==f){if(B.debug("Draggable "+f+" entering dropzone"),this._placeholder){var g=b("#"+f);this.move(g,a,g.parent(),a.parent(),this._placeholder)}}else this._placeholder&&this._placeholder.detach()},e_dragover:function(){},e_dragleave:function(a){b(a).removeClass(this.options.over_class)},e_drop:function(a,c){c.preventDefault(),b(a).removeClass(this.options.over_class);var d=c.originalEvent.dataTransfer,e=d.getData("text/plain").split(","),f=b("#"+e[0]),g={left:parseInt(e[1],10),top:parseInt(e[2],10)};f.length&&(B.info("Dropping "+f.attr("id")),this.options.onDrop.call(a,f,c,g,this))}}),lux.icons={fontawesome:function(a,c){var d=(b("i",a).remove(),'<i class="fa fa-'+c.icon+'"></i>');a[0].text&&(a[0].text=" "+a[0].text),a.prepend(d)}}}lux.addIcon=function(a,b){var c=lux.icons[lux.icon];c&&!a.is("html")&&(b||(b=a.data()),b.icon&&c(a,b))},lux.autoViews.push({selector:"[data-icon]",load:function(a){lux.addIcon(b(a))}}),lux.ajaxResponses=[],lux.ajaxResponse=function(b,c,d){a(lux.ajaxResponses).forEach(function(a){return a(b,d)})},lux.ajaxElement=function(a){var c=a.is("a")?a.attr("href"):a.data("href"),d={type:a.data("action")||"get",success:lux.ajaxResponse};a.click(function(a){a.preventDefault(),b.ajax(c,d)})},lux.autoViews.push({selector:'[data-ajax="true"]',load:function(a){lux.ajaxElement(b(a))}}),lux.ajaxResponses.push(function(a){return a.redirect?(window.location=a.redirect,!0):void 0}),lux.ajaxResponses.push(function(a){a.html});{var M=["large","normal","small","mini"],N=lux.buttonGroup=function(a){a||(a={});var c=b(document.createElement("div"));return c.addClass(a.vertical?"btn-group-vertical":"btn-group"),a.radio&&c.data("toggle","buttons-radio"),c},O=lux.Button=lux.createView("button",{tagName:"button",defaults:{skin:"default"},className:"btn",initialise:function(a){var b=this.elem;b.addClass(this.className).attr({type:a.type,title:a.title,href:a.href}).addClass(a.classes),this.setSkin(a.skin),this.setSize(a.size),a.text&&b.html(a.text),a.icon&&lux.addIcon(b,a),a.block&&b.addClass("btn-block")},setSize:function(b){if(M.indexOf(b)>-1){var c=this.elem,d=this.className+"-";a(M).forEach(function(a){c.removeClass(d+a)}),c.addClass(d+b)}}}),P=["title"],Q=["checkbox","radio"],R="form-control",S=lux.Form=lux.createView("form",{selector:"form[data-lux]",tagName:"form",defaults:{dataType:"json",layout:null,ajax:!1,complete:null,error:null,validate:!1,success:lux.ajaxResponse},initialise:function(a){var c=this.elem;c.hasClass("horizontal")?a.layout="horizontal":c.hasClass("inline")&&(a.layout="inline"),a.layout&&(this.layout=a.layout,c.addClass("form-"+this.layout)),(a.ajax||c.hasClass("ajax"))&&this.ajax(a),a.validate!==!1&&(a.validate=!0,require(["parsley"],function(){c.attr("novalidate","novalidate").parsley({successClass:"success",errorClass:"error",classHandler:function(a){return b(a).closest(".control-group")},errorsWrapper:'<span class="help-inline"></span>',errorElem:"<span></span>"})}))},ajax:function(a){var b=this.elem;require(["jquery-form"],function(){b.ajaxForm(a)})},addFields:function(b,c){var d=[],e=this;return a(b).forEach(function(a){a&&a.name&&-1===d.indexOf(a.name)&&(d.push(a.name),a.render(e,c))}),this},addSubmit:function(a){a||(a={}),a.tagName||(a.tagName="button",a.text||(a.text="Submit"));var b=new O(a);return this.fieldset(a.fieldset).append(b.elem),b},render:function(){if(this.layout){var a=this["render_"+this.layout];a.call(this)}else{b("input,select,textarea",this.elem).each(function(){var a=b(this);-1===Q.indexOf(a.attr("type"))&&a.addClass(R)})}return this},render_inline:function(){b("input,select",this.elem).each(function(){var a=b(this);-1===Q.indexOf(a.attr("type"))&&(a.parent().find("label").addClass("sr-only"),a.addClass(R))})},render_horizontal:function(){var a,c,d,e,f,g=this;b("input,select",this.elem).each(function(){a=b(this).addClass(R),e=a.closest(g.groupClass),e.length&&(d=a.parent(),d.is("label")||(d=a),e=b(document.createElement("div")).addClass("controls"),d.before(e).appendTo(e),f=e.parent(),e.hasClass("control-group")||(c=e.prev(),f=b(document.createElement("div")).addClass("control-group"),e.before(f).appendTo(f),c.is("label")&&f.prepend(c.addClass("control-label"))))})},fieldset:function(a){if(a){if(a instanceof jQuery)return a;if(a instanceof HTMLElement)return b(a);var c=this.elem.find(a);return c.length||(c=this.elem.find("."+a)),c.length?c:this.elem}return this.elem}}),T=lux.Field=lux.Class.extend({fieldOptions:["tagName","type","label","placeholder","fieldset"],attributes:a.union(["accept","alt","autocomplete","autofocus","disabled","form","formaction","readonly","required"],P),formGroup:"form-group",tagName:"input",type:"text",init:function(b,c){c||(c={}),this.name=b,a.extend(this,a.pick(c,this.fieldOptions)),this.attributes=a.pick(c,this.attributes),this.attributes.title||(this.attributes.title=this.name),this.label!==!1&&(this.label=this.getLabel()),this.required&&(this.required="required")},validate:function(a,b){return b||0===b?b+"":void 0},setValue:function(a,b){a&&b.val(a.get(this.name))},render:function(c){var d=b(document.createElement(this.tagName)).attr(this.attributes),e=this.getPlaceholder();d.attr("name",this.name),"input"===this.tagName&&d.attr("type",this.type);var f=d.attr("type");-1===Q.indexOf(f)&&d.addClass(R),e&&d.attr("placeholder",e),a.isFunction(c)?c(d):(this.setValue(c.model,d),"hidden"!==f&&(d=this.outerContainer(d,c)),c.fieldset(this.fieldset).append(d))},getPlaceholder:function(){return this.placeholder!==!1?this.placeholder?this.placeholder:this.getLabel():void 0},getLabel:function(){return this.label||lux.niceStr(this.name)},outerContainer:function(c){var d=b(document.createElement("div")).addClass(this.formGroup);if(this.label){var e=c.attr("id");e||(e=a.uniqueId("field"),c.attr("id",e)),b(document.createElement("label")).html(this.label).attr("for",e).appendTo(d)}return d.append(c)}}),U=(lux.Field=T.extend({type:"number",validate:function(a,b){return parseInt(b,10)}}),lux.FloatField=T.extend({type:"number",validate:function(a,b){return parseFloat(b)}}),lux.BooleanField=T.extend({type:"checkbox",controlClass:null,setValue:function(a,b){if(a){var c=a.get(this.name)?!0:!1;b.prop("checked",c)}},validate:function(a,b){return void 0!==b?b===!0||"on"===b:void 0},outerContainer:function(a,c){var d=b(document.createElement("label")),e=b(document.createElement("div")).addClass("checkbox");return a=e.append(d.append(a).append(this.label)),c.fieldset(this.fieldset).append(a),a}}),lux.ChoiceField=T.extend({fieldOptions:a.union(T.prototype.fieldOptions,["choices","select2"]),tagName:"select",type:null,setValue:function(a,b){if(a){var c=a.get(this.name);b.is("select")||b.val()===c&&b.prop("checked",!0)}},render:function(c){var d,e,f=this,g=this.choices;if(a.isFunction(g)&&(g=g(c)),"select"===this.tagName){d=b(document.createElement(this.tagName)).attr({name:this.name}).append(b("<option></option>")).addClass(R),a(g).forEach(function(c){c instanceof jQuery||(a.isString(c)?e=c:(e=c.text||c.value,c=c.value),c=b("<option></option>").val(c).text(e)),d.append(c)}),a.isFunction(c)?c(d):(f.setValue(c.model,d),c.fieldset(this.fieldset).append(f.outerContainer(d,c)));var h=this.select2;return a.isFunction(h)&&(h=h(c)),h&&(h.placeholder||(h.placeholder=this.getPlaceholder()),d.Select(h)),d}"input"===this.tagName&&"radio"===this.type&&(a(g).forEach(function(a){a instanceof string?e=a:(e=a.text||a.value,a=a.value),d=b(document.createElement(this.tagName)).attr({type:"radio",name:f.name,value:a}).html(e),f.setValue(c.model,d)}),c.elem.append(d))}}));lux.MultiField=U.extend({render:function(a){if("select"===this.tagName){var b=this._super(a);return b}}}),lux.TextArea=T.extend({tagName:"textarea",formGroup:"textarea",attributes:a.union(T.prototype.attributes,["rows","cols"])}),lux.KeywordsField=T.extend({validate:function(b,c){if(a.isString(c)){var d=[];return a(c.split(",")).forEach(function(a){a=a.trim(),a&&d.push(a)}),d}if(a.isArray(c))return c;var e=[];return a(c).forEach(function(a){e.push(a)}),e}})}b.fn.Select=function(a){a||(a={});var b=this;return require(["select"],function(){b.select2(a)}),this};var V=function(a,b){return a.hasClass("select2-offscreen")?(a.select2("val",b),!0):void 0};lux.set_value_hooks.push(V);var W=lux.createView("gridrow",{initialise:function(c){var d=this;this.elem.addClass("row").addClass("grid24"),a(c.columns).forEach(function(a){var c="span"+a;d.elem.append(b(document.createElement("div")).addClass("column").addClass(c))})},column:function(a){return a=a||0,this.elem.children().eq(a)}}),X=(lux.Grid=lux.createView("grid",{defaults:{type:"fluid"},initialise:function(b){var c=this;this.elem.addClass("grid").addClass(b.type),b.rows&&a(b.rows).forEach(function(a){c.addRow(a)})},addRow:function(a){var b=new W({columns:a});return b.elem.appendTo(this.elem),b},row:function(a){return a=a||0,W.getInstance(this.elem.children().eq(a))}}),lux.Fullscreen=lux.createView("fullscreen",{defaults:{zindex:2010,icon:"times-circle",themes:["default","inverse"]},initialise:function(a){var c=b(document.createElement("div")).addClass("fullscreen").css({"z-index":a.zindex});this.wrap=b(document.createElement("div")).addClass("fullscreen-container").appendTo(c),this.side=b(document.createElement("div")).addClass("fullscreen-sidebar").appendTo(c),this.sidebar=N({vertical:!0}).appendTo(this.side),this.themes=a.themes,this.theme=1,this.exit=new O({icon:a.icon,title:"Exit full screen"}),this.exit.elem.appendTo(this.sidebar),this.theme_button=new O({icon:"laptop",title:"theme"}),this.theme_button.elem.appendTo(this.sidebar),this._wrapped={elem:this.elem,previous:this.elem.prev(),parent:this.elem.parent()},this.setElement(c),this.toggle_skin()},render:function(){var a=this;a.elem.parent().length||(a.exit.elem.click(function(){a.remove()}),a.theme_button.elem.click(function(){a.toggle_skin()}),a.wrap.append(this._wrapped.elem),a.elem.appendTo(document.body))},remove:function(){var a=this._wrapped;return a.previous.length?a.previous.after(a.elem):a.parent.prepend(a.elem),this._super()},toggle_skin:function(){var a=this.themes,b=this.theme;this.theme=b?0:1,this.theme_button.setSkin(a[b]),this.setSkin(a[this.theme])}})),Y=(lux.Dialog=lux.createView("dialog",{jQuery:!0,selector:".dialog",defaultElement:"div",default_modals:{backdrop:!0,keyboard:!0,width:400},defaults:{className:null,show:!0,keyboard:!0,closable:null,collapsable:!1,collapsed:!1,dragdrop:!1,fullscreen:!1,title:null,body:null,footer:null,modal:!1,autoOpen:!0,width:null,height:null,top:null,skin:"default",icons:{open:"plus-circle",close:"minus-circle",remove:"times",fullscreen:"arrows-alt"},buttons:{size:"mini"}},initialise:function(c){var d=this,e=this.elem.addClass("dialog").addClass(c.className).hide(),f=(c.closable,e.attr("title")||c.title),g=b(document.createElement("div")).addClass("header"),h=b(document.createElement("div")).addClass("body-wrap"),i=b(document.createElement("h3"));this.setSkin(c.skin),this._body=b(document.createElement("div")).addClass("body").append(e.contents()),this._foot=null,d.buttons=b(document.createElement("div")).addClass("btn-group").addClass("pull-right"),g.append(d.buttons).append(i),f&&i.append(f),e.empty().append(g).append(h.append(this._body)),c.body&&this._body.append(c.body),this.createButton=function(b){return b=a.extend(b||{},c.buttons),b.skin||(b.skin=this.getSkin()),new O(b)},c.modal&&d._addModal(c),c.width&&e.width(c.width),c.height&&this._body.height(c.height),c.collapsable&&d._addCollapsable(c),c.closable&&this._addClosable(c),c.fullscreen&&this._addFullscreen(c),c.movable&&this._addMovable(c),c.autoOpen&&d.render()
},body:function(){return this._body},foot:function(){return this._foot},header:function(){return this.elem.children(".header")},title:function(a){return this.header().children("h3").html(a)},render:function(){this.fadeIn()},_addModal:function(c){var d=this,e=a.extend({},d.default_modals,a.isObject(c.modal)?c.modal:null),f=b(document.createElement("div")).attr({tabindex:-1,role:"dialog"}).addClass("modal fullscreen").hide().appendTo(document.body),g=b(document.createElement("div")).addClass("modal-backdrop fullscreen"),h=this.eventName("click");f.on(h,function(){d.fadeOut()}),this.elem.off(h).on(h,function(a){a.stopPropagation()}),e.keyboard&&(h=this.eventName("keyup"),f.off(h).on(h,function(a){27===a.which&&d.fadeOut()})),this.enforceFocus(),c.collapsable=!1,c.width=c.width||e.width,c.closable=null===c.closable?!0:c.closable,this.elem.appendTo(f).addClass("dialog-modal").on("remove",function(){g.remove(),f.remove()}).on("show",function(){e.backdrop&&g.appendTo(document.body),f.show(),b(document.body).addClass("modal-open")}).on("hide",function(){f.hide(),g.detach(),b(document.body).removeClass("modal-open")})},_addClosable:function(a){var b=a.destroy,c=this,d=this.createButton({icon:a.icons.remove});d.elem.appendTo(this.buttons).click(function(){c.fadeOut({complete:function(){b?c.destroy():c.hide()}})})},_addCollapsable:function(a){var b=this,c=this.elem.children(".body-wrap"),d=b.createButton(),e=!1;a.collapsed&&(e=!0,c.hide().addClass("in").one("hide",function(){c.removeClass("collapse")})),c.on("show",function(){e&&(e=!1,c.addClass("collapse").show()),b.elem.removeClass("collapsed"),lux.addIcon(d.elem,{icon:a.icons.close})}).on("hidden",function(){b.elem.addClass("collapsed"),lux.addIcon(d.elem,{icon:a.icons.open})}),a.collapsed||c.height("auto"),d.elem.appendTo(this.buttons).mousedown(function(a){a.stopPropagation()}).click(function(){return c.collapse("toggle"),!1}),require(["bootstrap"],function(){b.elem.children(".body-wrap").collapse()})},_addFullscreen:function(a){var b=a.fullscreen,c=this.createButton({icon:a.icons.fullscreen,title:"Full screen mode"});b.render||(b=new X({elem:this.body()})),c.elem.prependTo(this.buttons).on("click",function(){b.render()})},_addMovable:function(){}}),l.extend({name:"StopIteration"})),Z=j.extend({init:function(a,b,c){this.deadline=a,this.cancelled=!1,this.callback=b,this.args=c},cancel:function(){this.cancelled=!0},reschedule:function(a){this._deadline=a,this._cancelled=!1}}),$=j.extend({init:function(b,c,d,e){var f,g=this,h=!1;this.callback=c,this.args=d;var i=function(){try{this.callback.call(this,g.args)}catch(a){return void g.cancel()}j()},j=function(){h||(e?(f.reschedule(b.time()+e),b.scheduled.insert(f.deadline,f)):b.callbacks.append(f))};e&&e>0?(e=e,f=b.call_later(e,i)):(e=null,f=b.call_soon(i)),a.extend(this,{get cancelled(){return h},cancel:function(){h=!0}})}}),_=lux.EventLoop=j.extend({init:function(){var b=[],c=new L,d=!1,e=window.requestAnimationFrame,g=function(){var c=(this.time(),b.splice(0));a(c).forEach(function(a){a.cancelled||a.callback(a.args.splice(0))})},h=function(a){if(d){try{g(a)}catch(b){if("StopIteration"===b.name)return void(d=!1)}d&&e(h)}};a.extend(this,{get callbacks(){return b},get scheduled(){return c},call_soon:function(a){var c=new Z(null,a,f(arguments,1));return b.append(c),c},call_later:function(a,b){var d=f.call(arguments,2),e=new Z(this.time()+a,b,d);return c.insert(e.deadline,e),e},call_at:function(a,b){var d=f.call(arguments,2),e=new Z(a,b,d);return c.insert(e.deadline,e),e},run:function(){d||(d=!0,e(h))},is_running:function(){return d}})},call_every:function(a){return new $(this,a,f(arguments,1))},time:function(){return(new Date).getTime()},stop:function(a){this.is_running()?this.call_soon(function(){if(a)try{a()}catch(b){console.log(b)}throw new Y}):a&&a()}});lux.eventloop=new _;lux.each;lux.utils={detector:{canvas:!!window.CanvasRenderingContext2D,workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob},allClasses:function(a){var c={},d=[];return b(a).each(function(){this.className&&b.each(this.className.split(" "),function(){var a=this;""!==a&&void 0===c[a]&&(c[a]=a,d.push(a))})}),d},as_tag:function(a,c){var d=b(c);return d.length||"string"!=typeof c?d.length?(d.is(a)||(d=b("<"+a+">").append(d)),d):void 0:b("<"+a+">").html(c)},closest_color:function(a,c){var d=null;for(a=b(a);a.length&&null===d;)a=a.parent(),d=a.css(c),("inherit"==d||"transparent"==d)&&(d=null);return d},urljoin:function(){var a=function(a){return a.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")},b=[].slice.call(arguments,0).join("/");return a(b)},prettyTime:function(a){var b=Math.floor(a/86400);return 0===b&&(2>a&&"1 second ago"||60>a&&Math.floor(a)+" seconds ago"||120>a&&"1 minute ago"||3600>a&&Math.floor(a/60)+" minutes ago"||7200>a&&"1 hour ago"||86400>a&&Math.floor(a/3600)+" hours ago")||1===b&&"Yesterday"||7>b&&b+" days ago"||31>b&&Math.ceil(b/7)+" weeks ago"},asDate:function(a){if(a instanceof Date)return a;var b=parseFloat(a);if(b===b)return new Date(1e3*b);throw new TypeError("Could not convert "+a+" to a date")}};var ab={},bb=Math.PI;lux.math=ab,b.extend(ab,{point2d:function(a,b){return{x:a,y:b}},distance2d:function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))},angle2d:function(a,b,c,d,e,f){var g=a-c,h=b-d,i=e-c,j=f-d,k=Math.atan2(g,h),l=Math.atan2(i,j);return k-l},degree:function(a){return 180*a/bb},radians:function(a){return bb*a/180}});var cb=Math.random,db=Math.log,eb=4*Math.exp(-.5)/Math.sqrt(2);return b.extend(ab,{normalvariate:function(a,b){for(var c,d,e,f;;)if(c=cb(),d=1-cb(),e=eb*(c-.5)/d,f=e*e/4,f<=-db(d))break;return a+e*b}}),function(){var a="undefined"!=typeof module&&module.exports,b="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,c=function(){for(var a,b,c=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],d=0,e=c.length,f={};e>d;d++)if(a=c[d],a&&a[1]in document){for(d=0,b=a.length;b>d;d++)f[c[0][d]]=a[d];return f}return!1}(),d={request:function(a){var d=c.requestFullscreen;a=a||document.documentElement,/5\.1[\.\d]* Safari/.test(navigator.userAgent)?a[d]():a[d](b&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){document[c.exitFullscreen]()},toggle:function(a){this.isFullscreen?this.exit():this.request(a)},onchange:function(){},onerror:function(){},raw:c};return c?(Object.defineProperties(d,{isFullscreen:{get:function(){return!!document[c.fullscreenElement]}},element:{enumerable:!0,get:function(){return document[c.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return!!document[c.fullscreenEnabled]}}}),document.addEventListener(c.fullscreenchange,function(a){d.onchange.call(d,a)}),document.addEventListener(c.fullscreenerror,function(a){d.onerror.call(d,a)}),void(a?module.exports=d:window.screenfull=d)):void(a?module.exports=!1:window.screenfull=!1)}(),a.extend(lux,e)});