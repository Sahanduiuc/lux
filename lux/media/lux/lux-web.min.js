define(["jquery","lux","bootstrap"],function(a,b){"use strict";var c=b.web,d=["default","primary","success","inverse","error"],e=(Array.prototype.slice,new b.getLogger);c.SKIN_NAMES=d,c.get_skin=function(a,b){if(a){b=b?b+"-":"";for(var c=0;c<d.length;c++){var e=d[c];if(a.hasClass(b+e))return e}}};b.setSkin=function(a,b,c){d.indexOf(b)>-1&&(c=c?c+"-":"",_(d).forEach(function(b){a.removeClass(c+b)}),a.addClass(c+b))};c.extension("markdown",{selector:".markdown",defaultElement:"div",options:{extensions:["prettify"]},decorate:function(){var a,d=this.element().addClass("markdown"),e=this.options.extensions,f=[],g=d.html(),h=["showdown"];d.html(""),e.indexOf("prettify")>-1&&h.push("prettify"),require(h,function(){_(e).forEach(function(c){a=b.showdown[c],"function"==typeof a&&(Showdown.extensions[c]=a,f.push(c))});var h=new Showdown.converter({extensions:f}),i=h.makeHtml(g);d.html(i),window.prettyPrint?window.prettyPrint(function(){c.refresh(d)},d[0]):c.refresh(d)})}});b.icons={fontawesome:function(b,c){var d=(a("i",b).remove(),'<i class="fa fa-'+c.icon+'"></i>');b[0].text&&(b[0].text=" "+b[0].text),b.prepend(d)}};b.icon=c.icon=function(a,d){var e=b.icons[c.options.icon];e&&!a.is("html")&&(d||(d=a.data()),d.icon&&e(a,d))},a(document).ready(function(){a("[data-icon]").each(function(){c.icon(a(this))})}),c.extension("ajax",{selector:"a.ajax, button.ajax",options:{dataType:"json",success:null,error:null},decorate:function(){var b=this.element(),c=b.is("a")?b.attr("href"):b.data("href"),d=b.data("action")||"get",e=this.options,f=e.success,g=(e.error,this);e.type=d,e.success=function(a,b,c){g.on_success(a,b,c),f&&f(a,b,c)},b.click(function(b){b.preventDefault(),a.ajax(c,e)})},on_success:function(a){a.redirect&&(window.location=a.redirect)}}),c.BUTTON_SIZES=["large","normal","small","mini"],b.web.create_button=function(d){d=d?d:{};var e=(d.tag||"a").toLowerCase(),f=a(document.createElement(e)),g=d.skin||"default";return f.addClass("btn"),f.attr("type",d.type),f.attr("title",d.title),f.addClass(d.classes).addClass("btn-"+g),f.attr("href",d.href),d.size&&f.addClass("btn-"+d.size),d.icon&&c.icon(f,d),d.text&&f.append(" "+d.text),d.block&&f.addClass("btn-block"),d.data&&f.data(d.data),b.web.refresh(f)},b.web.button_group=function(b){b||(b={});var c=a(document.createElement("div"));return c.addClass(b.vertical?"btn-group-vertical":"btn-group"),b.radio&&c.data("toggle","buttons-radio"),c},c.extension("alert",{selector:"div.alert",defaultElement:"div",options:{message:null,type:null,skin:null,closable:!0},decorate:function(){var a=this.element().addClass("alert").addClass(this.options.skin),b=this.options,d=this;if(b.message&&a.html(b.message),b.skin=this.get_skin(),b.closable){var e=c.create_button({icon:"remove",skin:b.skin,size:"mini"}).addClass("right");a.append(e),e.click(function(){d.fadeOut(function(){d.destroy()})})}}}),c.extension("tooltip",{selector:".tooltip",decorate:function(){this.element().tooltip(this.options)}}),c.DragDrop=b.Class.extend({defaults:{opacity:.6,over_class:"over",dropzone:null,placeholder:null,dummy:"droppable-dummy",dummy_heigh:30,onStart:function(){},onDrag:function(){},onDrop:function(){}},init:function(b){this.options=b=_.extend({},this.defaults,b),this.candrag=!1;var c=this,d=(b.dropzone,b.dummy);this.placeholder(this.options.placeholder);var e=a(document),f=b.dropzone;"string"!=typeof f?(e=a(b.dropzone),f=null):d&&(f+=", ."+d,this.dummy=a(document.createElement("div")).addClass(d).css("height",b.dummy_heigh)),e.on("dragenter",f,function(a){c.e_dragenter(this,a)}).on("dragover",f,function(a){return a.preventDefault(),c.e_dragover(this,a),!1}).on("dragleave",f,function(a){c.e_dragleave(this,a)}).on("drop",f,function(a){return c.e_drop(this,a),!1})},placeholder:function(b){if(b){this._placeholder=a(b===!0?document.createElement("div"):b);var c=this;this._placeholder.addClass("draggable-placeholder").unbind("dragover").unbind("drop").bind("dragover",function(a){return a.preventDefault(),!1}).bind("drop",function(a){return c.e_drop(this,a),!1})}else this._placeholder=null},add:function(c,d){var f=this,g=a(document),h=c,i=d,j=!0;"string"!=typeof c?(g=a(c).attr("draggable",!0),d=d?a(d):g,h=i=null,j=!1):d=g,d.on("mouseenter",i,function(){a(this).addClass("draggable")}).on("mouseleave",i,function(){a(this).removeClass("draggable")}).on("mousedown",i,function(){f.candrag=!0,c=j?a(this).closest(h).attr("draggable",!0):g,c.attr("id")||c.attr("id",b.s4())}),g.on("dragstart",h,function(a){return f.candrag&&f.options.onStart.call(this,a,f)!==!1?(e.debug("Start dragging "+this.id),f.e_dragstart(this,a)):void a.preventDefault()}).on("dragend",h,function(a){return e.debug("Ended dragging "+this.id),f.candrag=!1,f.e_dragend(this,a)}).on("drag",h,function(a){f.options.onDrag.call(this,a,f)})},reposition:function(a,b,c){var d=b.originalEvent.clientX-c.left,e=b.originalEvent.clientY-c.top;a.css({top:e,left:d})},moveElement:function(b,c){if(b=a(b),c=a(c),b[0]!==c[0]){var d=b.parent(),e=c.parent();this._placeholder?this._placeholder.after(b).detach():this.move(b,c,d,e),this.dummy&&d[0]!==e[0]&&(d.children().length||d.append(this.dummy),e.children("."+this.options.dummy).length&&this.dummy.detach())}},move:function(a,b,c,d,e){if(e||(e=a),b.prev().length){if(c[0]===d[0])for(var f=b.nextAll(),g=0;g<f.length;g++)if(f[g]===a[0])return void b.before(e);b.after(e)}else b.before(e)},swapElements:function(b,c){if(b=a(b),c=a(c),b[0]!==c[0]){var d=b.next(),e=b.parent(),f=c.next(),g=c.parent(),h=function(a,b,c){b.length?b.before(a):c.append(a)};h(c,d,e),h(b,f,g)}},e_dragstart:function(b,c){b=a(b);var d=c.originalEvent.dataTransfer,e=b.position(),f=c.originalEvent.clientX-e.left,g=c.originalEvent.clientY-e.top;if(d.effectAllowed="move",d.setData("text/plain",b[0].id+","+f+","+g),b.fadeTo(10,this.options.opacity),this._placeholder){var h=Math.min(b.height(),400);this._placeholder.height(h)}},e_dragend:function(b){this._placeholder&&this._placeholder.detach(),a(b).fadeTo(10,1)},e_dragenter:function(b,c){var d=c.originalEvent.dataTransfer,f=this.options,g=d.getData("text/plain").split(",")[0];if(b=a(b).addClass(f.over_class),b[0].id!==g){if(e.debug("Draggable "+g+" entering dropzone"),this._placeholder){var h=a("#"+g);this.move(h,b,h.parent(),b.parent(),this._placeholder)}}else this._placeholder&&this._placeholder.detach()},e_dragover:function(){},e_dragleave:function(b){a(b).removeClass(this.options.over_class)},e_drop:function(b,c){c.preventDefault(),a(b).removeClass(this.options.over_class);var d=c.originalEvent.dataTransfer,f=d.getData("text/plain").split(","),g=a("#"+f[0]),h={left:parseInt(f[1],10),top:parseInt(f[2],10)};g.length&&(e.info("Dropping "+g.attr("id")),this.options.onDrop.call(b,g,c,h,this))}}),c.extension("select",{selector:"select",defaultElement:"select",decorate:function(){var a=this,b=a.options,c=a.element();c.select(b)},select2:function(){return this.element().data("select2")},container:function(){return this.select2().container}}),c.create_select=function(b){var c=a(document.createElement("select"));return c.append(a("<option></option>")),_(b).forEach(function(b){_.isString(b)&&(b={value:b}),c.append(a("<option></option>").val(b.value).text(b.text||b.value))}),c},c.extension("dialog",{selector:"div.dialog",defaultElement:"div",options:{class_name:null,show:!0,keyboard:!0,closable:null,collapsable:!1,collapsed:!1,dragdrop:!1,fullscreen:!1,title:null,body:null,footer:null,modal:!1,modal_zindex:1040,popup:null,autoOpen:!0,width:null,height:null,top:null,skin:"default",icons:{open:"plus-circle",close:"minus-circle",remove:"times",fullscreen:"arrows-alt"},buttons:{size:"mini"}},decorate:function(){var b=this,c=b.options,d=b.element().addClass("dialog").addClass(c.class_name).addClass(c.skin),e=c.closable,f=c.popup,g=d.attr("title")||c.title,h=a(document.createElement("div")).addClass("header"),i=a(document.createElement("div")).addClass("body-wrap"),j=a(document.createElement("h3"));this._body=a(document.createElement("div")).addClass("body").append(d.contents()),this._foot=null,c.skin=this.get_skin(),b.buttons=a(document.createElement("div")).addClass("btn-group").addClass("pull-right"),h.append(b.buttons).append(j),g&&j.append(g),d.empty().append(h).append(i.append(this._body)),c.body&&this._body.append(c.body);var k=c.width;if(c.modal){k=k||500,d.css({"margin-left":-k/2+"px",left:"50%",position:"absolute","z-index":c.modal_zindex+10,top:c.top||"25%"}).appendTo(document.body),f=!1,e=null===e?!0:e;var l=a(document.createElement("div")).addClass("modal-backdrop fullscreen").css("z-index",c.modal_zindex);d.on("remove",function(){l.remove()}).on("show",function(){l.appendTo(document.body)}).on("hide",function(){l.detach()})}if(0===d.parent().length&&(f=!0),f&&d.appendTo(document.body),k&&d.width(k),c.height&&this._body.height(c.height),c.collapsable){var m=b.collapsable();b.buttons.append(m)}e&&(c.closable=!1,this.closable(e)),b.fullscreen(),b.make_movable(),c.autoOpen&&b.fadeIn(),d.addClass("ready")},body:function(){return this._body},foot:function(){return this._foot},header:function(){return this.element().children(".header")},title:function(a){return this.header().children("h3").html(a)},create_button:function(b){return b=a.extend(b||{},this.options.buttons),b.skin||(b.skin=this.options.skin),c.create_button(b)},closable:function(a){var b=!0;if(_.isObject(a)&&(a=_.extend({destroy:!0},a),b=a.destroy),!this.options.closable){var c=this;this.options.closable=!0;var d=this.create_button({icon:this.options.icons.remove});this.buttons.append(d),d.click(function(){c.fadeOut(function(){b&&c.destroy()})})}},collapsable:function(){var a=this,b=this.element().children(".body-wrap"),d=a.create_button(),e=!1;return this.options.collapsed&&(e=!0,b.hide().addClass("in").one("hide",function(){b.removeClass("collapse")})),b.on("show",function(){e&&(e=!1,b.addClass("collapse").show()),a.element().removeClass("collapsed"),c.icon(d,{icon:a.options.icons.close})}).on("hidden",function(){a.element().addClass("collapsed"),c.icon(d,{icon:a.options.icons.open})}).collapse(),this.options.collapsed||b.height("auto"),d.mousedown(function(a){a.stopPropagation()}).click(function(){return b.collapse("toggle"),!1}),d},fullscreen:function(){var a=this,c=a.options.fullscreen;if(c){var d=a.create_button({icon:a.options.icons.fullscreen,title:"Full screen mode"});c.render||(c=new b.Fullscreen({elem:this.body()})),a.buttons.prepend(d),d.click(function(){c.render()})}},make_movable:function(){}}),a.fn.dialog=function(a){return this.each(function(){c.dialog(this,a)})};var f=(b.Fullscreen=b.createView("fullscreen",{defaults:{zindex:2010,icon:"times-circle",themes:["default","inverse"]},initialise:function(b){var d=a(document.createElement("div")).addClass("fullscreen").css({"z-index":b.zindex});this.wrap=a(document.createElement("div")).addClass("fullscreen-container").appendTo(d),this.side=a(document.createElement("div")).addClass("fullscreen-sidebar").appendTo(d),this.sidebar=c.button_group({vertical:!0}).appendTo(this.side),this.themes=b.themes,this.theme=1,this.exit=c.create_button({icon:b.icon,title:"Exit full screen"}).appendTo(this.sidebar),this.theme_button=c.create_button({icon:"laptop",title:"theme"}).appendTo(this.sidebar),this._wrapped={elem:this.elem,previous:this.elem.prev(),parent:this.elem.parent()},this.setElement(d),this.toggle_skin()},render:function(){var a=this;a.elem.parent().length||(a.exit.click(function(){a.remove()}),a.theme_button.click(function(){a.toggle_skin()}),a.wrap.append(this._wrapped.elem),a.elem.appendTo(document.body))},remove:function(){var a=this._wrapped;return a.previous.length?a.previous.after(a.elem):a.parent.prepend(a.elem),this._super()},toggle_skin:function(){var a=this.themes,c=this.theme;this.theme=c?0:1,b.setSkin(this.theme_button,a[c],"btn"),b.setSkin(this.elem,a[this.theme])}}),b.Backend.extend({init:function(a,c,d){this._super(a,c,d);var e=this.url.search("://");if(this.namespace=this.url.substr(e+3),"local"===this.type)this.storage=localStorage;else{if("session"!==this.type)throw new b.NotImplementedError("unknown storage "+this.type);this.storage=sessionStorage}},execute:function(a){if(!a.beforeSend||a.beforeSend.call(a,this)!==!1){a.item&&(a.data=[a.item]);var b=a.crud,c=this.storage,d=this.namespace;b===Crud.create?_(a.data).forEach(function(a){c.setItem(d+a.cid,JSON.stringify(a.fields))}):b===Crud.update?_(a.data).forEach(function(a){var b=c.getItem(d+a.cid);b&&(b=_.extend(SON.parse(b),a.fields),c.setItem(d+a.cid,JSON.stringify(b)))}):b===Crud.delete&&_(a.data).forEach(function(a){c.removeItem(d+a.cid)})}}}));b.register_store("local",f),b.register_store("session",f),c.extension("backend",{defaultElement:"div",defaults:{store:null,hartbeat:0},decorate:function(){var a=this,c=a.options,d=(Array.prototype.slice,c.host,{resource:c.resource});c.hartbeat&&(d.onopen=function(){a.check_status()}),a.element().addClass("socket-control").css({"float":"left"}),a.socket=b.create_store(c.store)},check_status:function(){var a=this;a.socket.send({type:"status",success:function(){a.status.apply(a,arguments)},error:function(){a.status.apply(a,arguments)}})},status:function(a,c,d){var e=this;d.error?e.element().html(a):void 0!==a.uptime&&e.element().html(b.utils.prettyTime(a.uptime)),b.eventloop.call_later(e.options.hartbeat,function(){e.check_status()})}});var g=b.TabView=b.View.extend({data_key:"tabview",initialise:function(b){var c=this;this.tabs=this.elem.children("ul"),this.content=this.elem.children("div"),this.tabs.length||(this.tabs=a(document.createElement("ul"))),this.content.length||(this.content=a(document.createElement("div"))),this.tabs.addClass(b.pills?"nav-pills":"nav-tabs"),this.elem.prepend(this.tabs.addClass("nav").addClass(b.skin)),this.elem.append(this.content.addClass("tab-content")),_(b.tabs).each(function(a){c.add_tab(a)}),require(["bootstrap"],function(){c.tabs.on("click","a",function(b){b.preventDefault(),a(this).tab("show")}),c.activate_tab()})},add_tab:function(b){_.isString(b)&&(b={name:b}),b.link||(b.link="#"+this.cid+"-"+b.name);var c=a(document.createElement("a")).attr({href:b.link,id:this.cid+"-name-"+b.name}).html(b.name),d=a(document.createElement("div")).addClass("tab-pane").html(b.content);"#"===b.link.substr(0,1)&&d.attr("id",b.link.substr(1)),this.tabs.append(a(document.createElement("li")).append(c)),this.content.append(d)},activate_tab:function(a){var b=this.tabs.find("a");a=a?b.find("#"+this.cid+"-name-"+a):b.first(),a.trigger("click")}});return a.fn.tabs=function(a){var b=this.data("tabview");return b||(a.elem=this,b=new g(a)),b.elem},b.showdown.github=function(){return[{type:"lang",regex:"(~T){2}([^~]+)(~T){2}",replace:function(a,b,c){return"<del>"+c+"</del>"}}]},b.showdown.prettify=function(){return[{type:"output",filter:function(a){return a.replace(/(<pre>)?<code>/gi,function(a,b){return b?'<pre class="prettyprint linenums" tabIndex="0"><code data-inner="1">':'<code class="prettyprint">'})}}]},b.showdown.twitter=function(){return[{type:"lang",regex:"\\B(\\\\)?@([\\S]+)\\b",replace:function(a,b,c){return"\\"===b?a:'<a href="http://twitter.com/'+c+'">@'+c+"</a>"}},{type:"lang",regex:"\\B(\\\\)?#([\\S]+)\\b",replace:function(a,b,c){return"\\"===b?a:'<a href="http://twitter.com/search/%23'+c+'">#'+c+"</a>"}},{type:"lang",regex:"\\\\@",replace:"@"}]},b.web});