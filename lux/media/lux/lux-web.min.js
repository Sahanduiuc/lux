define(["jquery","lux"],function(a){"use strict";{var b=lux.web,c=["default","primary","success","inverse","error"];Array.prototype.slice,new lux.getLogger}b.SKIN_NAMES=c,b.get_skin=function(a){if(a)for(var b=0;b<c.length;b++){var d=c[b];if(a.hasClass(d))return d}},b.extension("markdown",{selector:".markdown",defaultElement:"div",options:{extensions:["prettify"]},decorate:function(){var a,c=this.element().addClass("markdown"),d=this.options.extensions,e=[],f=c.html(),g=["showdown"];c.html(""),d.indexOf("prettify")>-1&&g.push("prettify"),require(g,function(){_(d).forEach(function(b){a=lux.showdown[b],"function"==typeof a&&(Showdown.extensions[b]=a,e.push(b))});var g=new Showdown.converter({extensions:e}),h=g.makeHtml(f);c.html(h),window.prettyPrint?window.prettyPrint(function(){b.refresh(c)},c[0]):b.refresh(c)})}}),b.extension("ajax",{selector:"a.ajax, button.ajax",options:{dataType:"json",success:null,error:null},decorate:function(){var b=this.element(),c=b.is("a")?b.attr("href"):b.data("href"),d=b.data("action")||"get",e=this.options,f=e.success,g=(e.error,this);e.type=d,e.success=function(a,b,c){g.on_success(a,b,c),f&&f(a,b,c)},b.click(function(b){b.preventDefault(),a.ajax(c,e)})},on_success:function(a){a.redirect&&(window.location=a.redirect)}}),b.iconProviders={fontawesome:{icon:function(b,c){b.data("iconProvider","fontawesome");var d=a("i",b),e='<i class="icon-'+c+'"></i>';d.length?d.replaceWith(e):b.prepend(e)}}},b.BUTTON_SIZES=["large","normal","small","mini"],b.icon=function(a,c,d){var e;e=d?d.iconProvider||a.data("iconProvider")||b.options.icon:a.data("iconProvider")||b.options.icon,b.iconProviders[e].icon(a,c)},lux.web.create_button=function(c){c=c?c:{};var d=(c.tag||"a").toLowerCase(),e=a(document.createElement(d));return e.addClass("btn"),e.attr("type",c.type),e.attr("title",c.title),e.addClass(c.classes),e.attr("href",c.href),c.size&&e.addClass("btn-"+c.size),c.skin&&"default"!==c.skin&&e.addClass(c.skin),c.icon&&b.icon(e,c.icon,c),c.text&&e.append(" "+c.text),c.block&&e.addClass("btn-block"),c.data&&e.data(c.data),lux.web.refresh(e)},lux.web.button_group=function(b){var c=a(document.createElement("div")).addClass("btn-group");return b.radio&&c.data("toggle","buttons-radio"),c},b.extension("alert",{selector:"div.alert",defaultElement:"div",options:{message:null,type:null,skin:null,closable:!0},decorate:function(){var a=this.element().addClass("alert").addClass(this.options.skin),c=this.options,d=this;if(c.message&&a.html(c.message),c.skin=this.get_skin(),c.closable){var e=b.create_button({icon:"remove",skin:c.skin,size:"mini"}).addClass("right");a.append(e),e.click(function(){d.fadeOut(function(){d.destroy()})})}}}),b.extension("tooltip",{selector:".tooltip",decorate:function(){this.element().tooltip(this.options)}}),b.DragDrop=lux.Class.extend({defaults:{opacity:.6,over_class:"over",dropzone:null,placeholder:null,dummy:"droppable-dummy",dummy_heigh:30,onStart:function(){},onDrag:function(){},onDrop:function(){}},init:function(b){this.options=b=_.extend({},this.defaults,b),this.candrag=!1;var c=this,d=(b.dropzone,b.dummy);this.placeholder(this.options.placeholder);var e=a(document),f=b.dropzone;"string"!=typeof f?(e=a(b.dropzone),f=null):d&&(f+=", ."+d,this.dummy=a(document.createElement("div")).addClass(d).css("height",b.dummy_heigh)),e.on("dragenter",f,function(a){c.e_dragenter(this,a)}).on("dragover",f,function(a){return a.preventDefault(),c.e_dragover(this,a),!1}).on("dragleave",f,function(a){c.e_dragleave(this,a)}).on("drop",f,function(a){return c.e_drop(this,a),!1})},placeholder:function(b){if(b){this._placeholder=a(b===!0?document.createElement("div"):b);var c=this;this._placeholder.addClass("draggable-placeholder").unbind("dragover").unbind("drop").bind("dragover",function(a){return a.preventDefault(),!1}).bind("drop",function(a){return c.e_drop(this,a),!1})}else this._placeholder=null},add:function(c,d){var e=this,f=a(document),g=c,h=d,i=!0;"string"!=typeof c?(f=a(c).attr("draggable",!0),d=d?a(d):f,g=h=null,i=!1):d=f,d.on("mouseenter",h,function(){a(this).addClass("draggable")}).on("mouseleave",h,function(){a(this).removeClass("draggable")}).on("mousedown",h,function(){e.candrag=!0,c=i?a(this).closest(g).attr("draggable",!0):f,c.attr("id")||c.attr("id",lux.s4())}),f.on("dragstart",g,function(a){return e.candrag&&e.options.onStart.call(this,a,e)!==!1?(b.logger.debug("Start dragging "+this.id),e.e_dragstart(this,a)):void a.preventDefault()}).on("dragend",g,function(a){return b.logger.debug("Ended dragging "+this.id),e.candrag=!1,e.e_dragend(this,a)}).on("drag",g,function(a){e.options.onDrag.call(this,a,e)})},reposition:function(a,b,c){var d=b.originalEvent.clientX-c.left,e=b.originalEvent.clientY-c.top;a.css({top:e,left:d})},moveElement:function(b,c){if(b=a(b),c=a(c),b[0]!==c[0]){var d=b.parent(),e=c.parent();this._placeholder?this._placeholder.after(b).detach():this.move(b,c,d,e),this.dummy&&d[0]!==e[0]&&(d.children().length||d.append(this.dummy),e.children("."+this.options.dummy).length&&this.dummy.detach())}},move:function(a,b,c,d,e){if(e||(e=a),b.prev().length){if(c[0]===d[0])for(var f=b.nextAll(),g=0;g<f.length;g++)if(f[g]===a[0])return void b.before(e);b.after(e)}else b.before(e)},swapElements:function(b,c){if(b=a(b),c=a(c),b[0]!==c[0]){var d=b.next(),e=b.parent(),f=c.next(),g=c.parent(),h=function(a,b,c){b.length?b.before(a):c.append(a)};h(c,d,e),h(b,f,g)}},e_dragstart:function(b,c){b=a(b);var d=c.originalEvent.dataTransfer,e=b.position(),f=c.originalEvent.clientX-e.left,g=c.originalEvent.clientY-e.top;if(d.effectAllowed="move",d.setData("text/plain",b[0].id+","+f+","+g),b.fadeTo(10,this.options.opacity),this._placeholder){var h=Math.min(b.height(),400);this._placeholder.height(h)}},e_dragend:function(b){this._placeholder&&this._placeholder.detach(),a(b).fadeTo(10,1)},e_dragenter:function(c,d){var e=d.originalEvent.dataTransfer,f=this.options,g=e.getData("text/plain").split(",")[0];if(c=a(c).addClass(f.over_class),c[0].id!==g){if(b.logger.debug("Draggable "+g+" entering dropzone"),this._placeholder){var h=a("#"+g);this.move(h,c,h.parent(),c.parent(),this._placeholder)}}else this._placeholder&&this._placeholder.detach()},e_dragover:function(){},e_dragleave:function(b){a(b).removeClass(this.options.over_class)},e_drop:function(c,d){d.preventDefault(),a(c).removeClass(this.options.over_class);var e=d.originalEvent.dataTransfer,f=e.getData("text/plain").split(","),g=a("#"+f[0]),h={left:parseInt(f[1],10),top:parseInt(f[2],10)};g.length&&(b.logger.info("Dropping "+g.attr("id")),this.options.onDrop.call(c,g,d,h,this))}}),b.extension("select",{selector:"select",defaultElement:"select",decorate:function(){var a=this,b=a.options,c=a.element();c.select(b)},select2:function(){return this.element().data("select2")},container:function(){return this.select2().container}}),b.create_select=function(b){var c=a(document.createElement("select"));return c.append(a("<option></option>")),_(b).forEach(function(b){c.append(a("<option></option>").val(b.value).text(b.text||b.value))}),c};var d=function(a,b){return a.hasClass("select2-offscreen")?(a.select2("val",b),!0):void 0};lux.set_value_hooks.push(d),a.fn.select=function(a){return a=a||{},a!==Object(a)||a.width||(a.width="element"),this.select2(a)},b.extension("dialog",{selector:"div.dialog",defaultElement:"div",options:{class_name:null,show:!0,keyboard:!0,closable:null,collapsable:!1,collapsed:!1,dragdrop:!1,fullscreen:!1,title:null,body:null,footer:null,modal:!1,modal_zindex:1040,popup:null,autoOpen:!0,width:null,height:null,top:null,skin:null,icons:{open:"plus-sign",close:"minus-sign",remove:"remove",fullscreen:"fullscreen"},buttons:{size:"mini"}},decorate:function(){var b=this,c=b.options,d=b.element().addClass("dialog").addClass(c.class_name).addClass(c.skin),e=c.closable,f=c.popup,g=d.attr("title")||c.title,h=a(document.createElement("div")).addClass("header"),i=a(document.createElement("div")).addClass("body-wrap"),j=a(document.createElement("h3"));this._body=a(document.createElement("div")).addClass("body").append(d.contents()),this._foot=null,c.skin=this.get_skin(),b.buttons=a(document.createElement("div")).addClass("btn-group").addClass("right"),h.append(b.buttons).append(j),g&&j.append(g),d.empty().append(h).append(i.append(this._body)),c.body&&this._body.append(c.body);var k=c.width;if(c.modal){k=k||500,d.css({"margin-left":-k/2+"px",left:"50%",position:"absolute","z-index":c.modal_zindex+10,top:c.top||"25%"}).appendTo(document.body),f=!1,e=null===e?!0:e;var l=a(document.createElement("div")).addClass("modal-backdrop fullscreen").css("z-index",c.modal_zindex);d.on("remove",function(){l.remove()}).on("show",function(){l.appendTo(document.body)}).on("hide",function(){l.detach()})}if(0===d.parent().length&&(f=!0),f&&d.appendTo(document.body),k&&d.width(k),c.height&&this._body.height(c.height),c.collapsable){var m=b.collapsable();b.buttons.append(m)}e&&(c.closable=!1,this.closable(e)),b.fullscreen(),b.make_movable(),c.autoOpen&&b.fadeIn(),d.addClass("ready")},body:function(){return this._body},foot:function(){return this._foot},header:function(){return this.element().children(".header")},title:function(a){return this.header().children("h3").html(a)},create_button:function(c){return c=a.extend(c||{},this.options.buttons),c.skin||(c.skin=this.options.skin),b.create_button(c)},closable:function(a){var b=!0;if(_.isObject(a)&&(a=_.extend({destroy:!0},a),b=a.destroy),!this.options.closable){var c=this;this.options.closable=!0;var d=this.create_button({icon:this.options.icons.remove});this.buttons.append(d),d.click(function(){c.fadeOut(function(){b&&c.destroy()})})}},collapsable:function(){var a=this,c=this.element().children(".body-wrap"),d=a.create_button(),e=!1;return this.options.collapsed&&(e=!0,c.hide().addClass("in").one("hide",function(){c.removeClass("collapse")})),c.on("show",function(){e&&(e=!1,c.addClass("collapse").show()),a.element().removeClass("collapsed"),b.icon(d,a.options.icons.close)}).on("hidden",function(){a.element().addClass("collapsed"),b.icon(d,a.options.icons.open)}).collapse(),this.options.collapsed||c.height("auto"),d.mousedown(function(a){a.stopPropagation()}).click(function(){return c.collapse("toggle"),!1}),d},fullscreen:function(){var c=this,d=c.options.fullscreen;if(d){var e=c.create_button({icon:c.options.icons.fullscreen,title:"Full screen mode"});a.isFunction(d)||(d=function(){b.fullscreen(this.body())}),c.buttons.prepend(e),e.click(function(){d.call(c)})}},make_movable:function(){}}),a.fn.dialog=function(a){return this.each(function(){b.dialog(this,a)})};var e=document.createElement("select"),f=document.createElement("option"),g=["checkbox","radio"],h=function(){return{name:"jquery-form",version:"3.48",web:"http://malsup.com/jquery/form/"}};b.extension("form",{selector:"form",defaultElement:"form",options:{dataType:"json",layout:"default",ajax:!1,complete:null,error:null,success:null},decorate:function(){var a=this,b=a.element();b.hasClass("ajax")&&(a.options.ajax=!0),b.hasClass("horizontal")?this.options.layout="horizontal":b.hasClass("inline")&&(this.options.layout="inline");var c=this["render_"+this.options.layout];c&&c.call(this),a.options.ajax&&(a.options.ajax=!1,a.ajax())},render_horizontal:function(){var b,c,d,e,f;a("input,select,textarea,button",this.element().addClass("horizontal")).each(function(){b=a(this),e=b.parent(),e.hasClass("controls")||(d=b.parent(),d.is("label")||(d=b),e=a(document.createElement("div")).addClass("controls"),d.before(e).appendTo(e)),f=e.parent(),e.hasClass("control-group")||(c=e.prev(),f=a(document.createElement("div")).addClass("control-group"),e.before(f).appendTo(f),c.is("label")&&f.prepend(c.addClass("control-label")))})},render_inline:function(){var b;a("input,select,button",this.element().addClass("inline")).each(function(){b=a(this),-1===g.indexOf(b.attr("type"))&&b.addClass("input-small")})},ajax:function(c){if(!this.options.ajax){c&&a.extend(this.options,c);var d=this;b.add_lib(h()),c=d.options,c.ajax=!0,c.error=c.error||d.on_error,c.success=c.success||d.on_success,this.element().ajaxForm(c)}},add_input:function(b,c){c=c||{};var d,e,f,h=c.label,i=this._element,j=i.children("fieldset"),k=c.fieldset,l=c.value;return delete c.fieldset,delete c.label,k?(f=k.id?i.find("#"+k.id):k.Class?i.find("."+k.Class):j.last(),f.length?e=f:(e=a(document.createElement("fieldset")).appendTo(i),k.id?e.attr(id,k.id):k.Class&&e.addClass(k.Class))):e=j.length?j.first():i.children().length?i:a(document.createElement("fieldset")).appendTo(i),d="textarea"===b?a(document.createElement("textarea")).attr(c).html(l):"submit"===b?this.submit(c):"select"===b?this.select(c):_.isString(b)?this.input(c):b,h&&(h=a(document.createElement("label")).html(h)),g.indexOf(d.attr("type"))>-1?(h||(h=a(document.createElement("label"))),e.append(h.addClass("checkbox").append(d))):(e.append(h),e.append(d)),d},input:function(b){return b||(b={}),b.type||(b.type="text"),a(document.createElement("input")).attr(b)},submit:function(a){return a||(a={}),a.tag||(a.tag="button",a.text=a.value),b.create_button(a)},select:function(b){var c,d,g,h;return b&&(delete b.type,c=b.value,delete b.value,g=b.options,delete b.options),d=e.cloneNode(!1),_(g).forEach(function(a){h=f.cloneNode(!1),h.value=a.value,h.text=a.text||a.value,d.appendChild(h)}),a(d).attr(b)},on_error:function(a){400===a.status},on_success:function(c,d,e,f){c.redirect?window.location=c.redirect:_(c).forEach(function(c,d){_(c).forEach(function(c){c.skin=c.error?"error":"success";var e,g=b.alert(c);if(d&&(e=f.find("input[name="+d+"]")),e.length)e.before(g.element());else if("form"===d)f.prepend(g.element());else{var h=a(".messages");h.length?h.append(g.element()):f.prepend(g.element())}})})}});var i=lux;i.Field=lux.Class.extend({tag:"input",type:"text",init:function(a){this.options=Object(a)},validate:function(a,b){return b},set_value:function(a,b){b.val(a.get(this.name))},add_to_form:function(a,b){var c=_.extend({name:this.name,type:this.type,title:this.name},this.options),d=a.add_input(this.tag,c);return b&&this.set_value(b,d),d}}),i.BooleanField=i.Field.extend({type:"checkbox",set_value:function(a,b){a.get(this.name)&&b.prop("checked",!0)},validate:function(a,b){return void 0!==b?b===!0||"on"===b:void 0}}),i.MultiField=i.Field.extend({tag:"select",init:function(a){this.options=Object(a),this.options.multiple="multiple"}}),i.TextArea=i.Field.extend({tag:"textarea"}),i.KeywordsField=i.Field.extend({validate:function(a,b){if(_.isString(b)){var c=[];return _(b.split(",")).forEach(function(a){a=a.trim(),a&&c.push(a)}),c}return b}}),b.extension("fullscreen",{defaultElement:"div",options:{zindex:2010,icon:"remove"},decorate:function(){var c=this,d=this.options,e=a(document.createElement("div")).addClass("fullscreen zen").css({"z-index":d.zindex}),f=this.element(),g=a(document.createElement("div")).addClass("fullscreen-container").appendTo(e),h=f.prev(),i=f.parent(),j=a(document.createElement("div")).addClass("fullscreen-sidebar").appendTo(e),k=b.create_button({icon:d.icon,title:"Exit full screen"}).appendTo(j);this._container=e,k.click(function(){h.length?h.after(f):i.prepend(f),c.destroy()}),g.append(f),e.appendTo(document.body)},container:function(){return this._container}});var j=lux.Backend.extend({init:function(a,b,c){if(this._super(null,a,c||"local"),"local"===this.type)this.storage=localStorage;else{if("session"!==this.type)throw new lux.NotImplementedError("unknown storage "+this.type);this.storage=sessionStorage}},send:function(a){var b=this.submit_options(a);if(!b.beforeSend||b.beforeSend.call(b,this)!==!1){var c,d=b.action||CrudMethod[b.type]||b.type;if(d&&(c=this[d.toLowerCase().replace("-","_")]),c){var e=this;c.call(this,b.data,b.model,function(a){a.action=d,a.error&&b.error?b.error(a.error,e,a):b.success&&!a.error&&b.success(a.data,e,a)})}else if(b.error){var f={error:'Unknown "'+d+'" action.',action:d};b.error(f.error,this,f)}}},ping:function(a,b,c){c({data:"pong"})},post:function(b,c,d){var e=this.storage;a.each(b,function(){for(var a,b,d=!0;d;)a=lux.s4(),b=c+"."+a,d=e.getItem(b);this.fields.id=a,e.setItem(b,JSON.stringify(this.fields))}),d({data:b})},get:function(b,c,d){var e=this.storage,f=[];a.each(b,function(){var a=c+"."+this,b=e.getItem(a);b&&f.push({id:this,fields:JSON.parse(b)})}),d({data:f})},put:function(b,c,d){var e=this.storage;a.each(b,function(){var a=c+"."+this.id;e.setItem(a,JSON.stringify(this.fields))}),d({data:b})},destroy:function(b,c,d){var e=this.storage;a.each(b,function(){e.removeItem(c+"."+this)}),d({data:b})}});lux.register_store("local",j),lux.register_store("session",j),b.extension("backend",{defaultElement:"div",defaults:{store:null,hartbeat:0},decorate:function(){var a=this,b=a.options,c=(Array.prototype.slice,b.host,{resource:b.resource});b.hartbeat&&(c.onopen=function(){a.check_status()}),a.element().addClass("socket-control").css({"float":"left"}),a.socket=lux.create_store(b.store)},check_status:function(){var a=this;a.socket.send({type:"status",success:function(){a.status.apply(a,arguments)},error:function(){a.status.apply(a,arguments)}})},status:function(a,b,c){var d=this;c.error?d.element().html(a):void 0!==a.uptime&&d.element().html(lux.utils.prettyTime(a.uptime)),lux.eventloop.call_later(d.options.hartbeat,function(){d.check_status()})}}),lux.showdown.github=function(){return[{type:"lang",regex:"(~T){2}([^~]+)(~T){2}",replace:function(a,b,c){return"<del>"+c+"</del>"}}]},lux.showdown.prettify=function(){return[{type:"output",filter:function(a){return a.replace(/(<pre>)?<code>/gi,function(a,b){return b?'<pre class="prettyprint linenums" tabIndex="0"><code data-inner="1">':'<code class="prettyprint">'})}}]},lux.showdown.twitter=function(){return[{type:"lang",regex:"\\B(\\\\)?@([\\S]+)\\b",replace:function(a,b,c){return"\\"===b?a:'<a href="http://twitter.com/'+c+'">@'+c+"</a>"}},{type:"lang",regex:"\\B(\\\\)?#([\\S]+)\\b",replace:function(a,b,c){return"\\"===b?a:'<a href="http://twitter.com/search/%23'+c+'">#'+c+"</a>"}},{type:"lang",regex:"\\\\@",replace:"@"}]}});