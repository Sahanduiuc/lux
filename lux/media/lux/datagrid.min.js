define(["lux"],function(){"use strict";{var a=lux,b=a.DataGridColumn=lux.createView("datagridcolumn",{jQuery:!0,tagName:"th",defaults:{resizable:!0,sortable:!1,focusable:!0,selectable:!0},initialise:function(a){this.options=a,this.a=$(document.createElement("a")),this.elem.empty().append(this.a),a.code||(a.code=a.name)},id:function(){return this.options.code||this.index()},label:function(){return this.options.name||this.letter()},datagrid:function(){var a=this.elem.closest(".datagrid");return a.datagrid("instance")},index:function(){return this.elem.index()},letter:function(){return lux.num_to_letter(this.elem.index())},render:function(){var a=this.options.name||this.letter();this.a.html(a)},inputData:function(){}}),c=a.DataGridColumn=lux.createView("datagridrow",{jQuery:!0,tagName:"tr",initialise:function(a){var b=a.datagrid?a.datagrid.columns:null,c=this.model;if(b)for(var d=0;d<b.length;d++){var e=b[d],f=new h({column:e,model:c});this.elem.append(f.elem)}}}),d=(lux.web,document.createElement("th"),document.createElement("tr"));document.createElement("td")}d.className="row";var e=lux.Class.extend({init:function(a,b){this.name=a,this.scope=b},on:function(a){this.scope.elem.bind(this.name,a)},one:function(a){this.scope.elem.one(this.name,a)},fire:function(a){var b=$.Event(this.name);return a=a||[],a.splice(0,0,this.scope),this.scope.elem.trigger(b,a),b}}),f=a.DataGrid=lux.createView("datagrid",{selector:".datagrid",jQuery:!0,extensions:[],defaults:{autoload:!0,model:null,store:null,minRows:0,minColumns:0,maxRows:1/0,maxColumns:1/0,columns:null,rows:null,rowHeaders:!1,foot:!1,onLoadError:null},classes:{container:"datagrid",header:"hd",top:"header",bottom:"footer"},initialise:function(a){var b=this.elem,c=this.classes;this.options=a,b.is("table")&&(b=$(document.createElement("div")),this.elem.before(b),b.append(elem),this.setElement(b)),b.addClass(c.container),b.attr("id")||b.attr("id",this.cid);var d=this.table();0===d.length&&(d=$(document.createElement("table")).appendTo(b)),d.removeClass(c.container),d.prepend(this._addtag("tbody")),d.prepend(this._addtag("tfoot").addClass("hd")),a.foot?this.show_tfoot():this.hide_tfoot(),d.prepend(this._addtag("thead").addClass("hd")),d.prepend(this._addtag("div."+c.top).addClass(c.top).hide()),a.data||(a.data=j(this)),k(this),a.rowHeaders&&this.show_row_headers(),a.foot&&this.show_tfoot(),self.onLoadError=a.onLoadError||function(){},a.rows&&(a.minRows=Math.max(a.rows,0)),delete a.rows,m(this),l(this),this.setData(a.data),delete a.data,this.onReady.fire().isDefaultPrevented()||a.autoload&&this.load({add:!0})},setData:function(a){if(this.data)this.data.reset(a);else{if(!(a instanceof lux.Collection)){var b=this.options;a=new lux.Collection(b.model,b.store)}this.data=a}this.tbody().html("")},load:function(a){var b=this,c=a.add;this.data.fetch({data:this.inputData(),success:function(a){c?b.data.add(a):b.setData(a),b.render()},error:function(a){b.onLoadError(a)}})},id:function(){return this.elem.attr("id")},table:function(){return this.elem.find("table")},thead:function(){return this.elem.find("thead")},tbody:function(){return this.elem.find("tbody")},tfoot:function(){return this.elem.find("tfoot")},headers:function(){var a=this.thead().children("tr");if(a.length){if(a.length>1){var b=this.thead().children("tr.headers");a=b.length?b:a.first()}}else a=$(document.createElement("tr")).appendTo(this.thead());return a.addClass("headers")},column:function(a){return a="string"==typeof a?th=this.thead().find("#"+a):$(a),a.closest("th").datagridcolumn("instance")},insertColumn:function(a,b){var c=this.head().find("tr.headers");void 0===b&&b>=c[0].children.length&&this.head().append(a)},inputData:function(){var a=this,b={field:this.fields()};return _(a.extensions).forEach(function(c){c.inputData(a,b)}),b},countRows:function(){return this.data.length},getDataAtCell:function(a,b){return a>=0&&a<this.data.length?this.data[a][b]:void 0},show_row_headers:function(){var a=this.thead(),b=a.find("th.row-header");if(!b.length){var c=a.children("tr");b=$(document.createElement("th")).addClass("row-header"),len(c.length)>1&&b.attr("rowspan",c),c.first().append(b)}},show_tfoot:function(){var a=this.tfoot().children("tr");a.length||(a=$(document.createElement("tr")).appendTo(this.tfoot()),_(this.columns).forEach(function(b){a.append("<td>"+b.name+"</td>")})),this.elem.addClass("footer"),this.tfoot().show()},hide_tfoot:function(){this.elem.removeClass("footer"),this.tfoot().hide()},toggle_tfoot:function(){this.elem.hasClass("footer")?this.hide_tfoot():this.show_tfoot()},_addtag:function(a){var b=this.elem.find(a);return b.length||(a=a.split(".")[0],b=$(document.createElement(a))),b},fields:function(){var a=[];return _(this.columns).forEach(function(b){var c=b.inputData();c&&a.push(c)}),a},render:function(){var a=this.tbody()[0],b=this.options.maxRows,d=this.options.minRows,e=(this.columns,this.data),f=this;if(_(this.columns).forEach(function(a){a.render()}),e.length<d){for(var g=[],h={},i=e.length;d>i;i++)g.push(h);e.add(g)}e.forEach(function(d,e){if(e>=b)return!1;var g=new c({model:d,datagrid:f});a.appendChild(g.elem[0])})},toString:function(){return"DataGrid - "+this.data.toString()}}),g=lux.Class.extend({inputData:function(){}});f.Extension=function(a,b){b.name=a,f.prototype.extensions.push(g.extend(b))};var h=a.Cell=lux.createView("datagridcell",{tagName:"td",initialise:function(a){var c=this.model;if(this.column=a.column,this.column instanceof b||(this.column=new b(this.column)),c){var d=c.get(this.column.id());d&&this.elem.html(d)}},exitEditMode:function(){this.elem.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.elem.removeClass("editor"),this.render()}});f.Extension("sorting",{defaults:{sortable:!1,sorting_icon:"sort",sorting_asc_icon:"sort-down",sorting_desc_icon:"sort-up"},classes:{enabled:"sortable",sorted:"sorted"},sort_string:{asc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?-1:a>b?1:0},desc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?1:a>b?-1:0}},sort_number:{is:function(a){return"number"!=typeof a?!isNaN(1*a):!0},asc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,a-b},desc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,b-a}},init:function(a){if(a.options.sortable){var b=this;a.sort=function(c,d){b.sort(a,c,d)},b._enable_sorting(a),a.elem.on("click","th",function(c){var d=a.column(c.currentTarget);d&&d.sorting!==!1&&b.sort(a,d)})}},sort:function(a,b){var c,d,e,f,g=this,h=b.data_type,i=b.index(),j=(this.classes,[]);a.options.rowHeaders&&i--,a.sortColumn===b?a.sortOrder="asc"===a.sortOrder?"desc":"asc":(a.sortColumn=b,a.sortOrder=b.direction?b.direction:"asc");for(var k=0;k<a.countRows();k++)f=a.getDataAtCell(k,i),j.push([k,f]),h||(e=g._guessType(f),"string"===e?h="string":void 0===d?d=e:d!==e&&(h="string"));if(h||(h=d),b.data_type=h,h){c=this["sort_"+h][a.sortOrder],j.sort(function(a,b){return c(a[1],b[1])});var l=[];_(j).forEach(function(b){l.push(a.data[b[0]])}),a.data=l,_(a.columns).forEach(function(c){c!==b&&g.set_icon(c,a.options.sorting_icon)}),g.set_icon(column,a.options["sorting_"+a.sortOrder+"_icon"]),a.render()}},_enable_sorting:function(a){var b=this.classes,c=(a.thead(),this);_(a.columns).forEach(function(d){d.sortable===!1?d.elem.removeClass(b.enabled):(d.elem.addClass(b.enabled),c.set_icon(d,a.options.sorting_icon))})},_guessType:function(a){return this.sort_number.is(a)?"number":"string"},set_icon:function(a,b){if(b){var c=a.elem.find(".sortable-toggle");c.length||(c=$(document.createElement("a")).addClass("sortable-toggle").appendTo(a.elem)),lux.icon(c,{icon:b})}}});var i=b.extend({});f.Extension("checkboxSelector",{defaults:{checkbox_selector:!1},init:function(a){a.options.checkbox_selector&&a.options.colHeaders&&a.options.colHeaders.splice(0,0,new i)}}),f.Extension("RowActions",{defaults:{row_actions:[]},init:function(a){var b=a.options;b.colHeaders&&b.row_actions&&b.row_actions.length&&(b.checkbox_selector||(b.checkbox_selector=!0,b.colHeaders.splice(0,0,new i)))}}),f.Extension("skin",{defaults:{styles:{plain:"",table:"table",grid:"grid"},style:"table",skin:"default",rowHeight:20,minWidth:30},init:function(a){var b=this;a.style=function(c){b.style(a,c)},a.setSkin(a.options.skin),a.style(a.options.style),a.options.rowHeight&&this._createCssRules(a)},style:function(a,b){void 0!==a.options.styles[b]&&(_(a.options.styles).forEach(function(b){a.elem.removeClass(b)}),a.elem.addClass(a.options.styles[b]))},_createCssRules:function(a){var b=0,c=a.elem[0].id,d=a.options.rowHeight-b,e=["#"+c+" .row { height:"+a.options.rowHeight+"px; }","#"+c+" .row > td { height:"+d+"px; }"];a.options.minWidth&&e.push("#"+c+" .row > th { min-width:"+a.options.minWidth+"px; }"),a.addStyle(e)}}),f.Extension("responsive",{init:function(a){if(a.options.responsive){var b=this;this.switched=!1,this._render=a.render,a.render=function(){b.render(a)},$(window).on("resize",function(){b.render(a)})}},render:function(a){var b=$(window).width();if(767>b&&!this.switched){this.switched=!0;var c=a.tbody();_(a.columns).forEach(function(a,b){b+=1,c.find("td:nth-of-type("+b+")").attr("data-content",a.name)})}else b>=767&&this.switched&&(this.switched=!1,this._render.call(a))}});var j=function(a){var c=a.thead().children("tr"),d=[];if(c.length){var e=this.thead().children("tr.headers");c=e.length?e:c.last(),c.children("th").each(function(){a.columns.push(new b(this))})}return a.tbody().children("tr").each(function(){var a={};$(this).children().each(function(){d.length<=length&&d.push(this.innerHTML)}),d.push(a)}),d},k=function(a){var c=[],e=d.cloneNode(!1),f=a.options,g=f.columns;if(a.columns=c,_.isNumber(g)){var h=parseInt(g,10);g=[];for(var i=0;h>i;i++)g.push(new b)}_(g).forEach(function(a){a instanceof b||("string"==typeof a&&(a={name:a}),a=new b(a)),e.appendChild(a.elem[0]),c.push(a)}),a.thead().append($(e))},l=function(a){var b=a.extensions,c=a.options;a.extensions={},_(b).forEach(function(b){_(b.prototype.defaults).forEach(function(a,b){b in c||(c[b]=a)}),a.extensions[b.prototype.name]=new b(a)})},m=function(a){_.extend(a,{onReady:new e("ready",a),onScroll:new e("scroll",a),onSort:new e("sort",a),onClick:new e("click",a),onColumn:new e("column",a)})};return f});