define(["lux-web"],function(){"use strict";var a=lux.web,b=document.createElement("th"),c=document.createElement("tr"),d=document.createElement("td"),e=document.createElement("tr"),f="DATAGRID",g="dg-hd-row",h=lux,i={resizable:!0,sortable:!1,focusable:!0,selectable:!0,minWidth:30};e.className=g,c.className="dg-bd-row";var j=(lux.Class.extend({init:function(a,b){this.name=a,this.scope=b},on:function(a){this.scope.elem.bind(this.name,a)},one:function(a){this.scope.elem.one(this.name,a)},fire:function(a){var b=$.Event(this.name);return a=a||[],a.splice(0,0,this.scope),this.scope.elem.trigger(b,a),b}}),h.DataGridColumn=lux.Class.extend({init:function(a){var c=this;a=_.extend({},i,a),this.th=$(b.cloneNode(!1)).data("column",this),a.code||(a.code=a.name),_.extend(this,{getOptions:function(){return a},id:function(){return a.id||c.index()},label:function(){return a.name||c.letter()}})},datagrid:function(){var a=this.th.closest(".datagrid");return a.datagrid("instance")},index:function(){return this.th.index()},letter:function(){return lux.num_to_letter(this.th.index())},render:function(){var a=this.name||this.letter();opts=this.getOptions(),th=this.th,opts.minWidth&&th.css("min-width",opts.minWidth+"px"),this.th.html(a)},input_data:function(){}}),h.DataGrid=lux.Class.extend({extensions:[],options:{minRows:0,minColumns:0,maxRows:1/0,maxColumns:1/0,columns:null,rowHeaders:!1,foot:!1},classes:{container:"datagrid",header:"hd",top:"header",bottom:"footer"},init:function(a,b){var c=$(a),d=this.classes;this.options=b=_.merge({},this.options,b),0===c.length?c=$(document.createElement("div")):a.is("table")&&(c=$(document.createElement("div")),a.before(c),c.append(a)),c.addClass(d.container),c.attr("id")||c.attr("id","dg-"+lux.s4()),this.elem=c,c.data(f,this);var e=this.table();0===e.length&&(e=$(document.createElement("table")).appendTo(c)),e.removeClass(d.container),e.prepend(this._addtag("tbody")),e.prepend(this._addtag("tfoot").addClass("hd")),b.foot?this.show_tfoot():this.hide_tfoot(),e.prepend(this._addtag("thead").addClass("hd")),e.prepend(this._addtag("div."+d.top).addClass(d.top).hide());var g;g=this.options.data?this.options.data:_getHTML(this),delete this.options.data,_initHeaders(this),b.rowHeaders&&this.show_row_headers(),b.foot&&this.show_tfoot(),_register_events(this),_add_extensions(this),this.onReady.fire().isDefaultPrevented()||(this.set_data(g),this.render())},set_data:function(a){a instanceof Collection||(a=new Collection(a)),this.data=a,this.tbody().html("")},id:function(){return this.elem.attr("id")},table:function(){return this.elem.find("table")},thead:function(){return this.elem.find("thead")},tbody:function(){return this.elem.find("tbody")},tfoot:function(){return this.elem.find("tfoot")},headers:function(){var a=this.thead().children("tr");if(a.length){if(a.length>1){var b=this.thead().children("tr.headers");a=b.length?b:a.first()}}else a=$(document.createElement("tr")).appendTo(this.thead());return a.addClass("headers")},column:function(a){return a="string"==typeof a?th=this.thead().find("#"+a):$(a),a.data("column")},insert_column:function(a,b){var c=this.head().find("tr.headers");void 0===b&&b>=c[0].children.length&&this.head().append(a)},input_data:function(){var a=this,b={field:this.fields()};return _(a.extensions).forEach(function(c){c.input_data(a,b)}),b},countRows:function(){return this.data.length},getDataAtCell:function(a,b){return a>=0&&a<this.data.length?this.data[a][b]:void 0},show_row_headers:function(){var a=this.thead(),b=a.find("th.row-header");if(!b.length){var c=a.children("tr");b=$(document.createElement("th")).addClass("row-header"),len(c.length)>1&&b.attr("rowspan",c),c.first().append(b)}},show_tfoot:function(){var a=this.tfoot().children("tr");a.length||(a=$(document.createElement("tr")).appendTo(this.tfoot()),_(this.columns).forEach(function(b){a.append("<td>"+b.name+"</td>")})),this.elem.addClass("footer"),this.tfoot().show()},hide_tfoot:function(){this.elem.removeClass("footer"),this.tfoot().hide()},toggle_tfoot:function(){this.elem.hasClass("footer")?this.hide_tfoot():this.show_tfoot()},_addtag:function(a){var b=this.elem.find(a);return b.length||(a=a.split(".")[0],b=$(document.createElement(a))),b},fields:function(){var a=[];return _(this.columns).forEach(function(b){var c=b.input_data();c&&a.push(c)}),a},render:function(){var a=this.tbody()[0],b=this.columns,e=this.data;if(e){_(this.columns).forEach(function(a){a.render()});for(var f=0;f<e.length();f++){for(var g=e.get_item(f),h=c.cloneNode(!1),i=0;i<b.length;i++){var j=b[i],k=(g[j.code()],d.cloneNode(!1));h.appendChild(k)}a.appendChild(h)}}}})),k=lux.Class.extend({input_data:function(){}});j.Extension=function(a,b){b.name=a,j.prototype.extensions.push(k.extend(b))},j.Extension("sorting",{options:{sortable:!1,sorting_icon:"sort",sorting_asc_icon:"sort-down",sorting_desc_icon:"sort-up"},classes:{enabled:"sortable",sorted:"sorted"},sort_string:{asc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?-1:a>b?1:0},desc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?1:a>b?-1:0}},sort_number:{is:function(a){return"number"!=typeof a?!isNaN(1*a):!0},asc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,a-b},desc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,b-a}},init:function(a){if(a.options.sortable){var b=this;a.sort=function(c,d){b.sort(a,c,d)},b._enable_sorting(a),a.elem.on("click","th",function(c){var d=a.column(c.currentTarget);d&&d.sorting!==!1&&b.sort(a,d)})}},sort:function(a,b){var c,d,e,f,g=this,h=b.data_type,i=b.index(),j=(this.classes,[]);a.options.rowHeaders&&i--,a.sortColumn===b?a.sortOrder="asc"===a.sortOrder?"desc":"asc":(a.sortColumn=b,a.sortOrder=b.direction?b.direction:"asc");for(var k=0;k<a.countRows();k++)f=a.getDataAtCell(k,i),j.push([k,f]),h||(e=g._guessType(f),"string"===e?h="string":void 0===d?d=e:d!==e&&(h="string"));if(h||(h=d),b.data_type=h,h){c=this["sort_"+h][a.sortOrder],j.sort(function(a,b){return c(a[1],b[1])});var l=[];_(j).forEach(function(b){l.push(a.data[b[0]])}),a.data=l,_(a.columns).forEach(function(b){g.set_icon(b,a.options.sorting_icon)}),this.set_icon(b,a.options["sorting_"+a.sortOrder+"_icon"]),a.render()}},_enable_sorting:function(a){var b=this.classes,c=(a.thead(),this);_(a.columns).forEach(function(d){d.sortable===!1?d.th.removeClass(b.enabled):(c.set_icon(d,a.options.sorting_icon),d.th.addClass(b.enabled))})},_guessType:function(a){return this.sort_number.is(a)?"number":"string"},set_icon:function(a,b){if(b){var c=a.th.find("a.sortable-toggle");c.length||(c=$(document.createElement("a")).addClass("sortable-toggle").appendTo(a.th)),c.html('<i class="icon-'+b+'"></i>')}}}),j.Extension("skin",{options:{styles:{plain:"",table:"table",grid:"table-grid"},style:"table",skin:"default"},init:function(a){var b=this;a.skin=function(c){b.skin(a,c)},a.style=function(c){b.style(a,c)},a.skin(a.options.skin),a.style(a.options.style)},skin:function(a,b){var c=lux.web;if(c){var d=c.get_skin(a.elem);d!==b&&a.elem.removeClass(d).addClass(b)}},style:function(a,b){void 0!==a.options.styles[b]&&(_(a.options.styles).forEach(function(b){a.elem.removeClass(b)}),a.elem.addClass(a.options.styles[b]))}}),j.Extension("responsive",{init:function(a){if(a.options.responsive){var b=this;this.switched=!1,this._render=a.render,a.render=function(){b.render(a)},$(window).on("resize",function(){b.render(a)})}},render:function(a){var b=$(window).width();if(767>b&&!this.switched){this.switched=!0;var c=a.tbody();_(a.columns).forEach(function(a,b){b+=1,c.find("td:nth-of-type("+b+")").attr("data-content",a.name)})}else b>=767&&this.switched&&(this.switched=!1,this._render.call(a))}}),$.fn.datagrid=function(a){var b=this.first(),c=b.data(f);return"instance"===a?c:(c||(c=new lux.DataGrid(b,a)),c.elem)},a.extension("datagrid",{selector:".datagrid",defaultElement:"div",decorate:function(){var a=$(this.element()).datagrid(this.options);this.datagrid=a.data(f)}})});