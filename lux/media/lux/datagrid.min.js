define(["jquery","lux"],function(a){"use strict";var b=lux.web,c=lux.each,d=lux.extend,e={},f=e.Column=lux.Class.extend({init:function(b){this.th=a(b);var c=this.th.data(),d=this.th.html(),e=c.code;if(e||(e=lux.s4(),this.th.data("code",e)),this.name=c.name||d,!d&&this.th.html(this.name),!this.th.attr("id")){var f=this.datagrid(),g=f.id()+"-"+e;this.th.attr("id",g)}this.th.data("column",this)},id:function(){return this.th.attr("id")},code:function(){return this.th.data("code")},datagrid:function(){var a=this.th.closest(".datagrid");return a.datagrid("instance")},index:function(){var a=this.th.index();return a}}),g=e.DataGridView=lux.Class.extend({init:function(a){this.g=a},render:function(){var b,d=this.g,e=d.tbody();e.html(""),c(this.g.data,function(f,g){b=a(document.createElement("tr")).appendTo(e),d.options.rowHeaders&&b.append(a(document.createElement("th")).html(g+1)),c(f,function(c){b.append(a(document.createElement("td")).html(c))})})}}),h=e.DataGrid=lux.Class.extend({extensions:[],options:{minRows:0,minColumns:0,maxRows:1/0,maxColumns:1/0,colHeaders:!1,rowHeaders:!1,foot:!1},classes:{container:"datagrid",header:"hd",top:"header",bottom:"footer"},init:function(b,c){var e=a(b),f=this.classes;this.options=c=d({},this.options,c||{}),0===e.length?e=a(document.createElement("div")):b.is("table")&&(e=a(document.createElement("div")),b.before(e),e.append(b)),e.addClass(f.container);var h=e.attr("id");h||e.attr("id","dg"+lux.s4()),this.elem=e,e.data("datagrid",this),this.data=[],this.columns=[];var i=this.table();0===i.length&&(i=a(document.createElement("table")).appendTo(e)),i.removeClass(f.container),i.prepend(this._addtag("tbody")),i.prepend(this._addtag("tfoot").addClass("hd")),c.foot?this.show_tfoot():this.hide_tfoot(),i.prepend(this._addtag("thead").addClass("hd")),i.prepend(this._addtag("div."+f.top).addClass(f.top).hide()),this.options.data?(this.data=this.options.data,delete this.options.data):this.initHTML(),this.options.colHeaders&&this.initHeaders(),c.rowHeaders&&this.show_row_headers(),c.foot&&this.show_tfoot(),this.view=new g(this),this.add_extensions();var j=a.Event("datagrid-initialised");this.elem.trigger(j),j.isDefaultPrevented()||this.render()},id:function(){return this.elem.attr("id")},table:function(){return this.elem.find("table")},thead:function(){return this.elem.find("thead")},headers:function(){var b=this.thead().children("tr");if(b.length){if(b.length>1){var c=this.thead().children("tr.headers");b=c.length?c:b.first()}}else b=a(document.createElement("tr")).appendTo(this.thead());return b.addClass("headers")},tbody:function(){return this.elem.find("tbody")},tfoot:function(){return this.elem.find("tfoot")},column:function(b){return b="string"==typeof b?th=this.thead().find("#"+b):a(b),b.data("column")},countRows:function(){return this.data.length},getDataAtCell:function(a,b){return a>=0&&a<this.data.length?this.data[a][b]:void 0},render:function(){this.view&&this.view.render()},show_row_headers:function(){var b=this.thead(),c=b.find("th.row-header");if(!c.length){var d=b.children("tr");c=a(document.createElement("th")).addClass("row-header"),len(d.length)>1&&c.attr("rowspan",d),d.first().append(c)}},show_tfoot:function(){var b=this.tfoot().children("tr");b.length||(b=a(document.createElement("tr")).appendTo(this.tfoot()),c(this.columns,function(a){b.append("<td>"+a.name+"</td>")})),this.elem.addClass("footer"),this.tfoot().show()},hide_tfoot:function(){this.elem.removeClass("footer"),this.tfoot().hide()},toggle_tfoot:function(){this.elem.hasClass("footer")?this.hide_tfoot():this.show_tfoot()},_addtag:function(b){var c=this.elem.find(b);return c.length||(b=b.split(".")[0],c=a(document.createElement(b))),c},initHTML:function(){{var b=this.thead().children("tr"),c=this;this.id()}if(b.length>1){var d=this.thead().children("tr.headers");b=d.length?d:b.last()}b.children("th").each(function(){c.columns.push(new f(this))});var e=c.columns.length;e&&this.tbody().children("tr").each(function(){var b=[];a(this).children().each(function(){b.length<=e&&b.push(this.innerHTML)}),c.data.push(b)})},initHeaders:function(){var b,d,e,g=this.columns,h=this.headers(),i={};c(this.columns,function(a){i[a.id()]=a}),c(this.options.colHeaders,function(c){if("string"==typeof c&&(c={name:c}),d=c.id,e=a(document.createElement("th")),d){if(e.attr(d),delete c.id,i[d])throw new lux.NotImplementedError}else b=new f(e.data(c).appendTo(h)),i[b.id()]=b,g.push(b)})},add_extensions:function(){var a=this;this.extensions={},c(this.constructor.prototype.extensions,function(b){var d=b.prototype.options,e=a.options;d&&c(d,function(a,b){void 0===e[b]&&(e[b]=a)}),a.extensions[name]=new b(a)})},input_data:function(){var a=this,b={field:this.fields()};return c(a.extensions,function(c){c.input_data(a,b)}),b},fields:function(){var a=[];return c(this.columns,function(b){a.push(b.code())}),a}}),i=lux.Class.extend({name:null,input_data:function(){}});return h.Extension=function(a,b){h.prototype.extensions.push(i.extend(b))},h.Extension("sorting",{options:{sortable:!1,sorting_icon:"sort",sorting_asc_icon:"sort-down",sorting_desc_icon:"sort-up"},classes:{enabled:"sortable",sorted:"sorted"},sort_string:{asc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?-1:a>b?1:0},desc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?1:a>b?-1:0}},sort_number:{is:function(a){return"number"!=typeof a?!isNaN(1*a):!0},asc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,a-b},desc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,b-a}},init:function(a){if(a.options.sortable){var b=this;this._enable_sorting(a),a.elem.on("click","th",function(c){var d=a.column(c.currentTarget);d&&d.sorting!==!1&&b.sort(a,d)})}},sort:function(a,b){var d,e,f,g,h=this,i=b.data_type,j=b.index(),k=(this.classes,[]);a.options.rowHeaders&&j--,a.sortColumn===b?a.sortOrder="asc"===a.sortOrder?"desc":"asc":(a.sortColumn=b,a.sortOrder=b.direction?b.direction:"asc");for(var l=0;l<a.countRows();l++)g=a.getDataAtCell(l,j),k.push([l,g]),i||(f=h._guessType(g),"string"===f?i="string":void 0===e?e=f:e!==f&&(i="string"));if(i||(i=e),b.data_type=i,i){d=this["sort_"+i][a.sortOrder],k.sort(function(a,b){return d(a[1],b[1])});var m=[];c(k,function(b){m.push(a.data[b[0]])}),a.data=m,c(a.columns,function(b){h.set_icon(b,a.options.sorting_icon)}),this.set_icon(b,a.options["sorting_"+a.sortOrder+"_icon"]),a.render()}},_enable_sorting:function(a){var b=this.classes,d=(a.thead(),this);c(a.columns,function(c){c.sortable===!1?c.th.removeClass(b.enabled):(d.set_icon(c,a.options.sorting_icon),c.th.addClass(b.enabled))})},_guessType:function(a){return this.sort_number.is(a)?"number":"string"},set_icon:function(b,c){if(c){var d=b.th.find("a.sortable-toggle");d.length||(d=a(document.createElement("a")).addClass("sortable-toggle").appendTo(b.th)),d.html('<i class="icon-'+c+'"></i>')}}}),h.Extension("skin",{options:{styles:{plain:"",table:"table",grid:"table-grid"},style:"table",skin:"default"},init:function(a){var b=this;a.skin=function(c){b.skin(a,c)},a.style=function(c){b.style(a,c)},a.skin(a.options.skin),a.style(a.options.style)},skin:function(a,b){var c=lux.web;if(c){var d=c.get_skin(a.elem);d!==b&&a.elem.removeClass(d).addClass(b)}},style:function(a,b){void 0!==a.options.styles[b]&&(c(a.options.styles,function(b){a.elem.removeClass(b)}),a.elem.addClass(a.options.styles[b]))}}),h.Extension("responsive",{init:function(b){if(b.options.responsive){var c=this;this.switched=!1,this._render=b.render,b.render=function(){c.render(b)},a(window).on("resize",function(){c.render(b)})}},render:function(b){var d=a(window).width();if(767>d&&!this.switched){this.switched=!0;var e=b.tbody();c(b.columns,function(a,b){b+=1,e.find("td:nth-of-type("+b+")").attr("data-content",a.name)})}else d>=767&&this.switched&&(this.switched=!1,this._render.call(b))}}),h.Extension("ajax",{options:{ajaxUrl:null,ajaxDataType:"json",ajaxMethod:"GET",ajaxAutoLoad:!0},init:function(a){if(a.options.ajaxAutoLoad&&a.options.ajaxUrl){var b=this;a.ajaxLoad=function(){b.ajaxLoad(a)},a.elem.one("datagrid-initialised",function(c){c.preventDefault(),b.ajaxLoad(a)})}},ajaxLoad:function(b){var c=b.options;c.ajaxUrl&&a.ajax(c.ajaxUrl,{dataType:c.ajaxDataType,data:b.input_data(),type:c.ajaxMethod,success:function(a){b.data=a,b.render()}})}}),a.fn.datagrid=function(a){var b=this.first(),c=b.data("datagrid");return"instance"===a?c:(c||(c=new lux.DataGrid(b,a)),b)},b.extension("datagrid",{selector:".datagrid",defaultElement:"div",decorate:function(){this.datagrid=new h(this.element(),this.options)}}),e});