define(["lux-web"],function(){"use strict";var a=lux.web,b=document.createElement("th"),c=document.createElement("tr"),d=document.createElement("td"),e="DATAGRID",f=lux,g={resizable:!0,sortable:!1,focusable:!0,selectable:!0};c.className="row";var h=lux.Class.extend({init:function(a,b){this.name=a,this.scope=b},on:function(a){this.scope.elem.bind(this.name,a)},one:function(a){this.scope.elem.one(this.name,a)},fire:function(a){var b=$.Event(this.name);return a=a||[],a.splice(0,0,this.scope),this.scope.elem.trigger(b,a),b}}),i=f.DataGridColumn=lux.Class.extend({init:function(a){var c=this;a=_.extend({},g,a),this.th=$(b.cloneNode(!1)).data("column",this),a.code||(a.code=a.name),_.extend(this,{getOptions:function(){return a},id:function(){return a.id||c.index()},label:function(){return a.name||c.letter()}})},datagrid:function(){var a=this.th.closest(".datagrid");return a.datagrid("instance")},index:function(){return this.th.index()},letter:function(){return lux.num_to_letter(this.th.index())},render:function(){{var a=this.name||this.letter();this.getOptions(),this.th}this.th.html(a)},inputData:function(){}}),j=f.DataGrid=lux.Class.extend({extensions:[],options:{autoload:!0,model:null,store:null,minRows:0,minColumns:0,maxRows:1/0,maxColumns:1/0,columns:null,rows:null,rowHeaders:!1,foot:!1,onLoadError:null},classes:{container:"datagrid",header:"hd",top:"header",bottom:"footer"},init:function(a,b){var c=$(a),d=this.classes;this.options=b=_.merge({},this.options,b),0===c.length?c=$(document.createElement("div")):a.is("table")&&(c=$(document.createElement("div")),a.before(c),c.append(a)),c.addClass(d.container),c.attr("id")||c.attr("id","dg-"+lux.s4()),this.elem=c,c.data(e,this);var f=this.table();0===f.length&&(f=$(document.createElement("table")).appendTo(c)),f.removeClass(d.container),f.prepend(this._addtag("tbody")),f.prepend(this._addtag("tfoot").addClass("hd")),b.foot?this.show_tfoot():this.hide_tfoot(),f.prepend(this._addtag("thead").addClass("hd")),f.prepend(this._addtag("div."+d.top).addClass(d.top).hide()),this.options.data||(this.options.data=m(this)),n(this),b.rowHeaders&&this.show_row_headers(),b.foot&&this.show_tfoot(),self.onLoadError=b.onLoadError||function(){},b.rows&&(b.minRows=Math.max(b.rows,0)),delete b.rows,p(this),o(this),this.setData(this.options.data),delete this.options.data,this.onReady.fire().isDefaultPrevented()||b.autoload&&this.load({add:!0})},setData:function(a){if(this.data)this.data.reset(a);else{if(!(a instanceof lux.Collection)){var b=this.options;a=new lux.Collection(b.model,b.store)}this.data=a}this.tbody().html("")},load:function(a){var b=this,c=a.add;this.data.fetch({data:this.inputData(),success:function(a){c?b.data.add(a):b.setData(a),b.render()},error:function(a){b.onLoadError(a)}})},id:function(){return this.elem.attr("id")},table:function(){return this.elem.find("table")},thead:function(){return this.elem.find("thead")},tbody:function(){return this.elem.find("tbody")},tfoot:function(){return this.elem.find("tfoot")},headers:function(){var a=this.thead().children("tr");if(a.length){if(a.length>1){var b=this.thead().children("tr.headers");a=b.length?b:a.first()}}else a=$(document.createElement("tr")).appendTo(this.thead());return a.addClass("headers")},column:function(a){return a="string"==typeof a?th=this.thead().find("#"+a):$(a),a.data("column")},insert_column:function(a,b){var c=this.head().find("tr.headers");void 0===b&&b>=c[0].children.length&&this.head().append(a)},inputData:function(){var a=this,b={field:this.fields()};return _(a.extensions).forEach(function(c){c.inputData(a,b)}),b},countRows:function(){return this.data.length},getDataAtCell:function(a,b){return a>=0&&a<this.data.length?this.data[a][b]:void 0},show_row_headers:function(){var a=this.thead(),b=a.find("th.row-header");if(!b.length){var c=a.children("tr");b=$(document.createElement("th")).addClass("row-header"),len(c.length)>1&&b.attr("rowspan",c),c.first().append(b)}},show_tfoot:function(){var a=this.tfoot().children("tr");a.length||(a=$(document.createElement("tr")).appendTo(this.tfoot()),_(this.columns).forEach(function(b){a.append("<td>"+b.name+"</td>")})),this.elem.addClass("footer"),this.tfoot().show()},hide_tfoot:function(){this.elem.removeClass("footer"),this.tfoot().hide()},toggle_tfoot:function(){this.elem.hasClass("footer")?this.hide_tfoot():this.show_tfoot()},_addtag:function(a){var b=this.elem.find(a);return b.length||(a=a.split(".")[0],b=$(document.createElement(a))),b},fields:function(){var a=[];return _(this.columns).forEach(function(b){var c=b.inputData();c&&a.push(c)}),a},render:function(){var a=this.tbody()[0],b=this.options.maxRows,e=this.options.minRows,f=this.columns,g=this.data;if(_(this.columns).forEach(function(a){a.render()}),g.length<e){for(var h=[],i={},j=g.length;e>j;j++)h.push(i);g.add(h)}g.forEach(function(e,g){if(g>=b)return!1;for(var h=c.cloneNode(!1),i=0;i<f.length;i++){var j=f[i],k=(e[j.id()],d.cloneNode(!1));h.appendChild(k)}a.appendChild(h)})},toString:function(){return"DataGrid - "+this.data.toString()}}),k=lux.Class.extend({inputData:function(){}});j.Extension=function(a,b){b.name=a,j.prototype.extensions.push(k.extend(b))};f.Cell=lux.View.extend({tagName:"td",init:function(a,b){this._super(a),this.column=b.column,this.column instanceof i||(this.column=new i(this.column))},exitEditMode:function(){this.elem.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.elem.removeClass("editor"),this.render()}});j.Extension("sorting",{options:{sortable:!1,sorting_icon:"sort",sorting_asc_icon:"sort-down",sorting_desc_icon:"sort-up"},classes:{enabled:"sortable",sorted:"sorted"},sort_string:{asc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?-1:a>b?1:0},desc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?1:a>b?-1:0}},sort_number:{is:function(a){return"number"!=typeof a?!isNaN(1*a):!0},asc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,a-b},desc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,b-a}},init:function(a){if(a.options.sortable){var b=this;a.sort=function(c,d){b.sort(a,c,d)},b._enable_sorting(a),a.elem.on("click","th",function(c){var d=a.column(c.currentTarget);d&&d.sorting!==!1&&b.sort(a,d)})}},sort:function(a,b){var c,d,e,f,g=this,h=b.data_type,i=b.index(),j=(this.classes,[]);a.options.rowHeaders&&i--,a.sortColumn===b?a.sortOrder="asc"===a.sortOrder?"desc":"asc":(a.sortColumn=b,a.sortOrder=b.direction?b.direction:"asc");for(var k=0;k<a.countRows();k++)f=a.getDataAtCell(k,i),j.push([k,f]),h||(e=g._guessType(f),"string"===e?h="string":void 0===d?d=e:d!==e&&(h="string"));if(h||(h=d),b.data_type=h,h){c=this["sort_"+h][a.sortOrder],j.sort(function(a,b){return c(a[1],b[1])});var l=[];_(j).forEach(function(b){l.push(a.data[b[0]])}),a.data=l,_(a.columns).forEach(function(b){g.set_icon(b,a.options.sorting_icon)}),this.set_icon(b,a.options["sorting_"+a.sortOrder+"_icon"]),a.render()}},_enable_sorting:function(a){var b=this.classes,c=(a.thead(),this);_(a.columns).forEach(function(d){d.sortable===!1?d.th.removeClass(b.enabled):(c.set_icon(d,a.options.sorting_icon),d.th.addClass(b.enabled))})},_guessType:function(a){return this.sort_number.is(a)?"number":"string"},set_icon:function(a,b){if(b){var c=a.th.find("a.sortable-toggle");c.length||(c=$(document.createElement("a")).addClass("sortable-toggle").appendTo(a.th)),c.html('<i class="icon-'+b+'"></i>')}}});var l=i.extend({});j.Extension("checkboxSelector",{options:{checkbox_selector:!1},init:function(a){a.options.checkbox_selector&&a.options.colHeaders&&a.options.colHeaders.splice(0,0,new l)}}),j.Extension("RowActions",{options:{row_actions:[]},init:function(a){var b=a.options;b.colHeaders&&b.row_actions&&b.row_actions.length&&(b.checkbox_selector||(b.checkbox_selector=!0,b.colHeaders.splice(0,0,new l)))}}),j.Extension("skin",{options:{styles:{plain:"",table:"table",grid:"grid"},style:"table",skin:"default",rowHeight:20,minWidth:30},init:function(a){var b=this;a.skin=function(c){b.skin(a,c)},a.style=function(c){b.style(a,c)},a.skin(a.options.skin),a.style(a.options.style),a.options.rowHeight&&this._createCssRules(a)},skin:function(a,b){var c=lux.web;if(c){var d=c.get_skin(a.elem);d!==b&&a.elem.removeClass(d).addClass(b)}},style:function(a,b){void 0!==a.options.styles[b]&&(_(a.options.styles).forEach(function(b){a.elem.removeClass(b)}),a.elem.addClass(a.options.styles[b]))},_createCssRules:function(a){var b=0,c=a.elem[0].id,d=$("<style type='text/css' rel='stylesheet' />").appendTo($("head")),e=a.options.rowHeight-b,f=["#"+c+" .row { height:"+a.options.rowHeight+"px; }","#"+c+" .row > td { height:"+e+"px; }"];a.options.minWidth&&f.push("#"+c+" .row > th { min-width:"+a.options.minWidth+"px; }"),d[0].styleSheet?d[0].styleSheet.cssText=f.join(" "):d[0].appendChild(document.createTextNode(f.join(" ")))}}),j.Extension("responsive",{init:function(a){if(a.options.responsive){var b=this;this.switched=!1,this._render=a.render,a.render=function(){b.render(a)},$(window).on("resize",function(){b.render(a)})}},render:function(a){var b=$(window).width();if(767>b&&!this.switched){this.switched=!0;var c=a.tbody();_(a.columns).forEach(function(a,b){b+=1,c.find("td:nth-of-type("+b+")").attr("data-content",a.name)})}else b>=767&&this.switched&&(this.switched=!1,this._render.call(a))}}),$.fn.datagrid=function(a){var b=this.first(),c=b.data(e);return"instance"===a?c:(c||(c=new lux.DataGrid(b,a)),c.elem)},a.extension("datagrid",{selector:".datagrid",defaultElement:"div",decorate:function(){var a=$(this.element()).datagrid(this.options);this.datagrid=a.data(e)}});var m=function(a){var b=a.thead().children("tr"),c=[];if(b.length){var d=this.thead().children("tr.headers");b=d.length?d:b.last(),b.children("th").each(function(){a.columns.push(new i(this))})}return a.tbody().children("tr").each(function(){var a={};$(this).children().each(function(){c.length<=length&&c.push(this.innerHTML)}),c.push(a)}),c},n=function(a){var b=[],d=c.cloneNode(!1),e=a.options.columns;if(a.columns=b,_.isNumber(e)){var f=parseInt(e,10);e=[];for(var g=0;f>g;g++)e.push(new i)}_(e).forEach(function(a){a instanceof i||("string"==typeof a&&(a={name:a}),a=new i(a)),d.appendChild(a.th[0]),b.push(a)}),a.thead().append($(d))},o=function(a){var b=a.extensions,c=a.options;a.extensions={},_(b).forEach(function(b){_(b.prototype.options).forEach(function(a,b){b in c||(c[b]=a)}),a.extensions[b.prototype.name]=new b(a)})},p=function(a){_.extend(a,{onReady:new h("ready",a),onScroll:new h("scroll",a),onSort:new h("sort",a),onClick:new h("click",a),onColumn:new h("column",a)})}});