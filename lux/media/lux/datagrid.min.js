define(["jquery","lux"],function(a){"use strict";var b=lux.web,c={},d=c.Column=lux.Class.extend({init:function(b){this.th=a(b);var c=this.th.data(),d=this.th.html(),e=c.code;if(e||(e=lux.s4(),this.th.data("code",e)),this.name=c.name||d,!d&&this.th.html(this.name),!this.th.attr("id")){var f=this.datagrid(),g=f.id()+"-"+e;this.th.attr("id",g)}this.th.data("column",this)},id:function(){return this.th.attr("id")},code:function(){return this.th.data("code")},datagrid:function(){var a=this.th.closest(".datagrid");return a.datagrid("instance")},index:function(){var a=this.th.index();return a}}),e=c.DataGridView=lux.Class.extend({init:function(a){this.g=a},render:function(){var b,c=this.g,d=c.tbody();d.html(""),_(this.g.data).forEach(function(e,f){b=a(document.createElement("tr")).appendTo(d),c.options.rowHeaders&&b.append(a(document.createElement("th")).html(f+1)),_(e).forEach(function(c){b.append(a(document.createElement("td")).html(c))})})}}),f=c.DataGrid=lux.Class.extend({extensions:[],options:{minRows:0,minColumns:0,maxRows:1/0,maxColumns:1/0,colHeaders:!1,rowHeaders:!1,foot:!1},classes:{container:"datagrid",header:"hd",top:"header",bottom:"footer"},init:function(b,c){var d=a(b),f=this.classes;this.options=c=_.merge({},this.options,c),0===d.length?d=a(document.createElement("div")):b.is("table")&&(d=a(document.createElement("div")),b.before(d),d.append(b)),d.addClass(f.container);var g=d.attr("id");g||d.attr("id","dg"+lux.s4()),this.elem=d,d.data("datagrid",this),this.data=[],this.columns=[];var h=this.table();0===h.length&&(h=a(document.createElement("table")).appendTo(d)),h.removeClass(f.container),h.prepend(this._addtag("tbody")),h.prepend(this._addtag("tfoot").addClass("hd")),c.foot?this.show_tfoot():this.hide_tfoot(),h.prepend(this._addtag("thead").addClass("hd")),h.prepend(this._addtag("div."+f.top).addClass(f.top).hide()),this.options.data?(this.data=this.options.data,delete this.options.data):this.initHTML(),this.options.colHeaders&&this.initHeaders(),c.rowHeaders&&this.show_row_headers(),c.foot&&this.show_tfoot(),this.view=new e(this),this.add_extensions();var i=a.Event("datagrid-initialised");this.elem.trigger(i),i.isDefaultPrevented()||this.render()},id:function(){return this.elem.attr("id")},table:function(){return this.elem.find("table")},thead:function(){return this.elem.find("thead")},headers:function(){var b=this.thead().children("tr");if(b.length){if(b.length>1){var c=this.thead().children("tr.headers");b=c.length?c:b.first()}}else b=a(document.createElement("tr")).appendTo(this.thead());return b.addClass("headers")},tbody:function(){return this.elem.find("tbody")},tfoot:function(){return this.elem.find("tfoot")},column:function(b){return b="string"==typeof b?th=this.thead().find("#"+b):a(b),b.data("column")},countRows:function(){return this.data.length},getDataAtCell:function(a,b){return a>=0&&a<this.data.length?this.data[a][b]:void 0},render:function(){this.view&&this.view.render()},show_row_headers:function(){var b=this.thead(),c=b.find("th.row-header");if(!c.length){var d=b.children("tr");c=a(document.createElement("th")).addClass("row-header"),len(d.length)>1&&c.attr("rowspan",d),d.first().append(c)}},show_tfoot:function(){var b=this.tfoot().children("tr");b.length||(b=a(document.createElement("tr")).appendTo(this.tfoot()),_(this.columns).forEach(function(a){b.append("<td>"+a.name+"</td>")})),this.elem.addClass("footer"),this.tfoot().show()},hide_tfoot:function(){this.elem.removeClass("footer"),this.tfoot().hide()},toggle_tfoot:function(){this.elem.hasClass("footer")?this.hide_tfoot():this.show_tfoot()},_addtag:function(b){var c=this.elem.find(b);return c.length||(b=b.split(".")[0],c=a(document.createElement(b))),c},initHTML:function(){{var b=this.thead().children("tr"),c=this;this.id()}if(b.length>1){var e=this.thead().children("tr.headers");b=e.length?e:b.last()}b.children("th").each(function(){c.columns.push(new d(this))});var f=c.columns.length;f&&this.tbody().children("tr").each(function(){var b=[];a(this).children().each(function(){b.length<=f&&b.push(this.innerHTML)}),c.data.push(b)})},initHeaders:function(){var b,c,e,f=this.columns,g=this.headers(),h={};_(this.columns).forEach(function(a){h[a.id()]=a}),_(this.options.colHeaders).forEach(function(i){if("string"==typeof i&&(i={name:i}),c=i.id,e=a(document.createElement("th")),c){if(e.attr(c),delete i.id,h[c])throw new lux.NotImplementedError}else b=new d(e.data(i).appendTo(g)),h[b.id()]=b,f.push(b)})},add_extensions:function(){var a=this;this.extensions={},_(this.constructor.prototype.extensions).forEach(function(b){var c=b.prototype.options,d=a.options;c&&_(c).forEach(function(a,b){void 0===d[b]&&(d[b]=a)}),a.extensions[name]=new b(a)})},input_data:function(){var a=this,b={field:this.fields()};return _(a.extensions).forEach(function(c){c.input_data(a,b)}),b},fields:function(){var a=[];return _(this.columns).forEach(function(b){a.push(b.code())}),a}}),g=lux.Class.extend({name:null,input_data:function(){}});return f.Extension=function(a,b){f.prototype.extensions.push(g.extend(b))},f.Extension("sorting",{options:{sortable:!1,sorting_icon:"sort",sorting_asc_icon:"sort-down",sorting_desc_icon:"sort-up"},classes:{enabled:"sortable",sorted:"sorted"},sort_string:{asc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?-1:a>b?1:0},desc:function(a,b){return a=(a+"").toLowerCase(),b=(b+"").toLowerCase(),b>a?1:a>b?-1:0}},sort_number:{is:function(a){return"number"!=typeof a?!isNaN(1*a):!0},asc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,a-b},desc:function(a,b){return a="-"===a||""===a?0:1*a,b="-"===b||""===b?0:1*b,b-a}},init:function(a){if(a.options.sortable){var b=this;this._enable_sorting(a),a.elem.on("click","th",function(c){var d=a.column(c.currentTarget);d&&d.sorting!==!1&&b.sort(a,d)})}},sort:function(a,b){var c,d,e,f,g=this,h=b.data_type,i=b.index(),j=(this.classes,[]);a.options.rowHeaders&&i--,a.sortColumn===b?a.sortOrder="asc"===a.sortOrder?"desc":"asc":(a.sortColumn=b,a.sortOrder=b.direction?b.direction:"asc");for(var k=0;k<a.countRows();k++)f=a.getDataAtCell(k,i),j.push([k,f]),h||(e=g._guessType(f),"string"===e?h="string":void 0===d?d=e:d!==e&&(h="string"));if(h||(h=d),b.data_type=h,h){c=this["sort_"+h][a.sortOrder],j.sort(function(a,b){return c(a[1],b[1])});var l=[];_(j).forEach(function(b){l.push(a.data[b[0]])}),a.data=l,_(a.columns).forEach(function(b){g.set_icon(b,a.options.sorting_icon)}),this.set_icon(b,a.options["sorting_"+a.sortOrder+"_icon"]),a.render()}},_enable_sorting:function(a){var b=this.classes,c=(a.thead(),this);_(a.columns).forEach(function(d){d.sortable===!1?d.th.removeClass(b.enabled):(c.set_icon(d,a.options.sorting_icon),d.th.addClass(b.enabled))})},_guessType:function(a){return this.sort_number.is(a)?"number":"string"},set_icon:function(b,c){if(c){var d=b.th.find("a.sortable-toggle");d.length||(d=a(document.createElement("a")).addClass("sortable-toggle").appendTo(b.th)),d.html('<i class="icon-'+c+'"></i>')}}}),f.Extension("skin",{options:{styles:{plain:"",table:"table",grid:"table-grid"},style:"table",skin:"default"},init:function(a){var b=this;a.skin=function(c){b.skin(a,c)},a.style=function(c){b.style(a,c)},a.skin(a.options.skin),a.style(a.options.style)},skin:function(a,b){var c=lux.web;if(c){var d=c.get_skin(a.elem);d!==b&&a.elem.removeClass(d).addClass(b)}},style:function(a,b){void 0!==a.options.styles[b]&&(_(a.options.styles).forEach(function(b){a.elem.removeClass(b)}),a.elem.addClass(a.options.styles[b]))}}),f.Extension("responsive",{init:function(b){if(b.options.responsive){var c=this;this.switched=!1,this._render=b.render,b.render=function(){c.render(b)},a(window).on("resize",function(){c.render(b)})}},render:function(b){var c=a(window).width();if(767>c&&!this.switched){this.switched=!0;var d=b.tbody();_(b.columns).forEach(function(a,b){b+=1,d.find("td:nth-of-type("+b+")").attr("data-content",a.name)})}else c>=767&&this.switched&&(this.switched=!1,this._render.call(b))}}),f.Extension("ajax",{options:{ajaxUrl:null,ajaxDataType:"json",ajaxMethod:"GET",ajaxAutoLoad:!0},init:function(a){if(a.options.ajaxAutoLoad&&a.options.ajaxUrl){var b=this;a.ajaxLoad=function(){b.ajaxLoad(a)},a.elem.one("datagrid-initialised",function(c){c.preventDefault(),b.ajaxLoad(a)})}},ajaxLoad:function(b){var c=b.options;c.ajaxUrl&&a.ajax(c.ajaxUrl,{dataType:c.ajaxDataType,data:b.input_data(),type:c.ajaxMethod,success:function(a){b.data=a,b.render()}})}}),a.fn.datagrid=function(a){var b=this.first(),c=b.data("datagrid");return"instance"===a?c:(c||(c=new lux.DataGrid(b,a)),b)},b.extension("datagrid",{selector:".datagrid",defaultElement:"div",decorate:function(){this.datagrid=new f(this.element(),this.options)}}),c});