.. _migrations:

==========
Migrations
==========

.. contents:: Table of Contents

Requirements
============

Lux use alembic_ as tool to provide migrations. Please install it via::

    pip install alembic

When Alembic is installed, you can use ``manage.py alembic -h`` to get all possible
migration commands.

**NOTE:** This documentation assume that you know alembic_ and its usage.

+-----------------------------------------------------------------------------+
| IMPORTANT                                                                   |
+=============================================================================+
| If you use auto-generated migrations **ALWAYS** check the outputs, as       |
| the mechanism is not bug-free and may contains errors/imperfections         |
| that needs to be fixed manually.                                            |
+-----------------------------------------------------------------------------+

Console commands
================

Lux command ``alembic`` provides almost the same sets of commands as alembic_.
The main difference is that there is no command ``list_templates`` as lux
provides only one default template.

Also there is one new command ``auto``, a shortcut for the alembic_ command::

    alembic revision --autogenerate

Anything else is similar to alembic commands.

Usual workflow
~~~~~~~~~~~~~~

* In new project (or in one where you want to start using migrations) use::

    python manage.py alembic init

This will create a ``migrations`` folder in main dir of your project. You can
change the destination by setting appropriate value in ``MIGRATIONS`` dict.

2. When you already initialized your migration directory it is a time for
creating initial structure of your database. It can be achieve in two ways:

* Using autogenerated migrations by: ::

    python manage.py alembic auto -m initial

**NOTE:** You must have empty database schema for this. If not you will
get an empty revision file.

* Manually by: ::

    python manage.py alembic revision -m initial

This will create empty revision template file where you will have to
put your migrations commands by yourself.

3. Whenever your models have changed use: ::

    python manage.py alembic auto -m <revision_name>

to update your migrations. You can also use ``revision`` command and finish
migration manually.

4. To bring your database to the newest state: ::

    python manage.py alembic upgrade heads

instead of ``heads`` you can put revision id to upgrade only to particular
revision.

5. If, for any reasons, you want revert database to previous state use: ::

    python manage.py alembic downgrade <revision_id>

For more information visit `Alembic docs site
<https://alembic.readthedocs.org/en/latest/>`_


Configuration
=============

Lux provide default configuration that works for most use cases.
However, if you need to customise this is what you can do:

Default settings
~~~~~~~~~~~~~~~~

1. ``script_location`` points to core project directory.
2. autogenerate migrations are available.
3. logging is set to default project's logging.

**Warning**
Auto generated migrations have some limits on what and how can be discovered.
More info can be found in `Alembic Auto Generating Migrations
<https://alembic.readthedocs.org/en/latest/autogenerate.html>`_.

Custom settings
~~~~~~~~~~~~~~~

If you wish to overwrite default setting, you have to define ``MIGRATIONS``
dict in your config file.

To overwrite main alembic settings create ``alembic`` key: ::

    MIGRATIONS = {
        'alembic': {
            'script_location': './migrations',
            ...
        }
    }

Refer to `Alembic .ini <https://goo.gl/Zeam9i>`_ to get available options.

To change logging behaviour provide: ::

    MIGRATIONS = {
        'alembic': {
            'script_location': './migrations',
            ...
        },
        'metadata': {
            '<db_name>': '<project_name>.<module_name>.models.Base'
        },
        'logging': {
            'path': '<path_to_logging_config_file>'
        }
    }

You have to provide proper config file for logging. Refer to
`Python logging <https://goo.gl/4s669q>`_


Editing env.py
===============

The ``env.py`` file is customized to read from ``MIGRATIONS`` settings.
You may change it to achieve desired logic. You are doing it on own risk!

.. _alembic: https://alembic.readthedocs.org/
